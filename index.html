<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Golf Competition Manager v2.0</title>
    <style>
        /* ULTRA-COMPACT STYLES - 30% smaller scorecard */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.3;
            padding: 8px;
            min-height: 100vh;
            font-size: 12px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        /* Compact Header */
        header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 10px 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        header h1 {
            font-size: 1.2rem;
            margin-bottom: 2px;
        }

        header p {
            margin: 0;
            font-size: 0.7rem;
            opacity: 0.9;
        }

        .header-controls {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .export-import-group {
            display: flex;
            gap: 5px;
            border-left: 1px solid rgba(255,255,255,0.2);
            padding-left: 6px;
        }

        /* Compact Buttons */
        button {
            padding: 5px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-weight: 600;
            font-size: 11px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
            background: #3498db;
            color: white;
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .btn-small {
            padding: 3px 6px;
            font-size: 10px;
        }

        /* Compact Tab Navigation */
        .tab-nav {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 2px;
            margin-bottom: 10px;
            border-radius: 5px;
            overflow: hidden;
            background: #ecf0f1;
        }

        .tab-button {
            padding: 8px 6px;
            background: #bdc3c7;
            border: none;
            cursor: pointer;
            font-weight: 600;
            text-align: center;
            color: #2c3e50;
            font-size: 11px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tab-button:hover {
            background: #a6acaf;
        }

        .tab-button.active {
            background: #2c3e50;
            color: white;
            box-shadow: inset 0 -2px 0 #2ecc71;
        }

        /* Compact Tab Content */
        .tab-content {
            display: none;
            background: white;
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
        }

        /* Compact Section Headers */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }

        .section-header h2 {
            font-size: 1.1rem;
            color: #2c3e50;
        }

        .section-actions {
            display: flex;
            gap: 5px;
        }

        /* Compact Players Container */
        .players-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            margin-top: 12px;
        }

        .player-card {
            background: white;
            padding: 12px;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            position: relative;
        }

        .player-card h3 {
            font-size: 0.9rem;
            margin-bottom: 6px;
            color: #2c3e50;
        }

        .player-group-badge {
            position: absolute;
            top: 6px;
            right: 6px;
            background: #3498db;
            color: white;
            padding: 1px 4px;
            border-radius: 8px;
            font-size: 0.5rem;
            font-weight: bold;
        }

        .player-actions {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }

        /* Compact Group Stats */
        .group-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin: 12px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .group-stat {
            padding: 8px;
            background: white;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
            text-align: center;
        }

        .group-stat h4 {
            margin-bottom: 6px;
            color: #2c3e50;
            font-size: 0.8rem;
        }

        .group-count {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2c3e50;
        }

        /* Ultra-Compact Scorecard - 30% smaller */
        .scorecard-container {
            overflow-x: auto !important;
            margin-top: 10px !important;
            border: 1px solid #e0e0e0 !important;
            border-radius: 5px !important;
            background: white !important;
            font-size: 10px !important;
            max-height: 85vh !important;
        }

        .scorecard-table {
            width: 100% !important;
            border-collapse: collapse !important;
            min-width: 900px !important; /* Reduced from 1200px */
        }

        .scorecard-table th {
            background: #2c3e50 !important;
            color: white !important;
            padding: 5px 3px !important; /* Reduced padding */
            text-align: center !important;
            font-weight: 600 !important;
            position: sticky !important;
            top: 0 !important;
            z-index: 10 !important;
            font-size: 9px !important; /* Smaller font */
            border-right: 1px solid #34495e !important;
        }

        .scorecard-table td {
            padding: 3px 2px !important; /* Reduced padding */
            text-align: center !important;
            border: 1px solid #e0e0e0 !important;
            min-width: 35px !important; /* Reduced from 50px */
            height: 45px !important; /* Fixed height for compactness */
        }

        .player-name-cell {
            text-align: left !important;
            font-weight: 600 !important;
            background: #f8f9fa !important;
            position: sticky !important;
            left: 0 !important;
            z-index: 5 !important;
            min-width: 120px !important; /* Reduced from 150px */
            padding: 5px 6px !important; /* Reduced padding */
            font-size: 9px !important; /* Smaller font */
            border-right: 2px solid #3498db !important;
        }

        .hole-header {
            padding: 3px 2px !important; /* Extra compact */
        }

        .hole-header div {
            font-size: 0.9em;
            line-height: 1.1;
        }

        .hole-header div:first-child {
            font-size: 0.8em; /* Smaller hole numbers */
            margin-bottom: 1px;
        }

        .hole-header div:last-child {
            font-size: 0.7em; /* Smaller par/index */
        }

        .score-input {
            width: 100% !important;
            padding: 3px !important;
            font-size: 10px !important;
            text-align: center !important;
            border: 1px solid #ddd !important;
            border-radius: 2px !important;
            background: white !important;
            font-weight: bold !important;
            -moz-appearance: textfield !important;
            height: 24px !important; /* Fixed height */
            margin-bottom: 2px !important;
        }

        .score-input::-webkit-outer-spin-button,
        .score-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .gross-display {
            font-size: 11px;
            font-weight: bold;
            padding: 2px 0;
            display: block;
            color: #2c3e50;
        }

        .stableford-display {
            font-size: 9px; /* Smaller */
            font-weight: bold;
            padding: 2px;
            border-radius: 2px;
            margin-top: 1px;
            display: block;
            min-height: 16px; /* Fixed height */
            line-height: 1.2;
        }

        .stableford-par { background: #2ecc71; color: white; }
        .stableford-birdie { background: #e74c3c; color: white; }
        .stableford-eagle { background: #9b59b6; color: white; }
        .stableford-bogey { background: #3498db; color: white; }
        .stableford-double { background: #ff6bc9; color: white; }
        .stableford-nr { background: #f1c40f; color: #2c3e50; }

        /* Summary cells - ultra compact */
        .summary-cell {
            font-size: 10px !important;
            padding: 4px 3px !important;
            min-width: 40px !important;
            font-weight: bold !important;
        }

        .front9-gross-cell { background: #2c3e50 !important; color: white !important; }
        .front9-points-cell { background: #2ecc71 !important; color: white !important; }
        .back9-gross-cell { background: #2c3e50 !important; color: white !important; }
        .back9-points-cell { background: #2ecc71 !important; color: white !important; }
        .total-gross-cell { background: #2c3e50 !important; color: white !important; }
        .total-points-cell { background: #2ecc71 !important; color: white !important; }
        .countback-cell { background: #3498db !important; color: white !important; }

        /* Color Legend - Extra Compact */
        .color-legend {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 8px;
            margin: 10px 0;
            border: 1px solid #e0e0e0;
        }

        .color-items {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }

        .color-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 3px 6px;
            background: white;
            border-radius: 3px;
            border: 1px solid #e0e0e0;
        }

        .color-swatch {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            border: 1px solid rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        .color-label {
            font-size: 0.7rem;
            font-weight: 500;
            color: #2c3e50;
        }

        /* Scorecard actions - compact */
        .scorecard-actions {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .scorecard-actions select {
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 11px;
            flex: 1;
            min-width: 150px;
        }

        .scorecard-actions button {
            padding: 6px 10px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 8px;
        }

        .modal-content {
            background: white;
            padding: 15px;
            border-radius: 6px;
            width: 95%;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            font-size: 12px;
        }

        .modal-content h3 {
            margin-bottom: 12px;
            color: #2c3e50;
            font-size: 1rem;
        }

        /* Pairs Compact Cards */
        .pairs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 10px;
            margin-top: 12px;
        }

        .pair-card {
            background: white;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            position: relative;
        }

        .pair-card.compact {
            padding: 8px;
        }

        .pair-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .pair-title {
            font-size: 0.8rem;
            font-weight: bold;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Comps Grid */
        .comps-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .comp-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.2s;
        }

        .comp-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .comp-card h3 {
            font-size: 1rem;
            margin-bottom: 8px;
            color: #2c3e50;
            padding-bottom: 6px;
            border-bottom: 2px solid #3498db;
        }

        .comp-description {
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .comp-actions {
            display: flex;
            gap: 6px;
            margin-top: 10px;
        }

        /* Leaderboard - Compact */
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            font-size: 11px;
        }

        .leaderboard-table th {
            background: #2c3e50;
            color: white;
            padding: 6px;
            text-align: center;
            font-weight: 600;
            position: relative;
            cursor: pointer;
            user-select: none;
            font-size: 10px;
        }

        .leaderboard-table td {
            padding: 6px;
            border: 1px solid #e0e0e0;
            font-size: 10px;
        }

        /* Master Leaderboard Table - UPDATED FORMAT with better readability */
        .master-leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            font-size: 11px;
            background: white;
        }

        .master-leaderboard-table th {
            color: white;
            padding: 8px 6px;
            text-align: center;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 10px;
            border-right: 1px solid rgba(255,255,255,0.2);
        }

        .master-leaderboard-table td {
            padding: 8px 6px;
            border: 1px solid #e0e0e0;
            font-size: 10px;
            vertical-align: top;
        }

        .master-leaderboard-table .position-col {
            width: 50px;
            text-align: center;
            font-weight: bold;
            background: #f8f9fa;
        }

        .master-leaderboard-table .player-col {
            width: 200px;
            text-align: left;
            font-weight: bold;
        }

        .master-leaderboard-table .courses-col {
            width: 200px;
            text-align: left;
            background: #f8f9fa;
        }

        .master-leaderboard-table .combined-col {
            width: 100px;
            text-align: center;
            font-weight: bold;
        }

        .combined-gross {
            background: #2c3e50;
            color: white;
        }

        .combined-points {
            background: #2ecc71;
            color: white;
        }

        /* NEW: Updated column header colors */
        .position-header {
            background: #6c3483 !important;
        }
        
        .player-header {
            background: #2c3e50 !important;
        }
        
        .courses-header {
            background: #2ecc71 !important;
        }
        
        .combined-gross-header {
            background: #2c3e50 !important;
        }
        
        .combined-points-header {
            background: #2ecc71 !important;
        }

        /* Course names only - simplified display */
        .course-names-list {
            font-size: 9px;
            line-height: 1.3;
        }

        .course-name-item {
            padding: 3px 0;
            border-bottom: 1px solid #eee;
            color: #2c3e50;
            font-weight: 500;
        }

        .course-name-item:last-child {
            border-bottom: none;
        }

        /* Course totals display */
        .course-totals-item {
            padding: 2px 0;
            font-size: 8px;
            color: #7f8c8d;
            border-bottom: 1px solid #eee;
        }

        .course-totals-item:last-child {
            border-bottom: none;
        }

        .course-total-gross {
            color: #2c3e50;
            font-weight: bold;
        }

        .course-total-points {
            color: #2ecc71;
            font-weight: bold;
        }

        /* Empty Message */
        .empty-message {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            background: #f8f9fa;
            border-radius: 5px;
            border: 2px dashed #e0e0e0;
            margin-top: 12px;
            font-size: 0.8rem;
        }

        .no-scorecard-message {
            text-align: center;
            padding: 30px 15px;
            color: #7f8c8d;
            background: #f8f9fa;
            border-radius: 5px;
            border: 2px dashed #e0e0e0;
            margin-top: 12px;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 8px;
            right: 8px;
            background: #2ecc71;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            font-size: 11px;
        }

        /* Utility Classes */
        .btn-primary { background: #3498db; }
        .btn-success { background: #2ecc71; }
        .btn-danger { background: #e74c3c; }
        .btn-warning { background: #f39c12; }
        .btn-info { background: #1abc9c; }
        .btn-secondary { background: #95a5a6; }
        .btn-purple { background: #9b59b6; }
        .btn-teal { background: #1abc9c; }
        .btn-orange { background: #e67e22; }
        
        /* Information Table Styles */
        #infoTable th {
            padding: 8px 6px;
            text-align: center;
            font-weight: 600;
            border: 1px solid #34495e;
            min-width: 120px;
            position: relative;
        }
        
        #infoTable th:nth-child(2) {
            min-width: 200px;
        }
        
        #infoTable th input {
            width: 100%;
            background: transparent;
            border: none;
            color: white;
            text-align: center;
            font-weight: 600;
            font-size: 11px;
            padding: 4px;
        }
        
        #infoTable th input:focus {
            outline: 2px solid #3498db;
            background: rgba(255,255,255,0.1);
        }
        
        #infoTable td {
            padding: 6px;
            border: 1px solid #e0e0e0;
            text-align: center;
            position: relative;
        }
        
        #infoTable td input {
            width: 100%;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 2px;
            font-size: 11px;
            text-align: center;
        }
        
        #infoTable td input:focus {
            outline: none;
            border-color: #3498db;
            background: #f0f8ff;
        }
        
        #infoTable tbody tr:hover {
            background: #f8f9fa;
        }
        
        .delete-row-btn, .delete-col-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 2px;
            cursor: pointer;
            font-size: 10px;
            margin-left: 4px;
        }
        
        .delete-row-btn:hover, .delete-col-btn:hover {
            background: #c0392b;
        }

        /* Responsive */
        @media (max-width: 1400px) {
            .tab-nav {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 1200px) {
            .players-container {
                grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            }
            
            .pairs-grid {
                grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            }
            
            .comps-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
            
            .scorecard-table {
                min-width: 800px;
            }
            
            .master-leaderboard-table .player-col {
                width: 150px;
            }
            
            .master-leaderboard-table .courses-col {
                width: 150px;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 5px;
                font-size: 11px;
            }
            
            header {
                flex-direction: column;
                text-align: center;
                padding: 8px;
            }
            
            .header-controls {
                justify-content: center;
                width: 100%;
            }
            
            .tab-nav {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .section-actions {
                width: 100%;
                justify-content: flex-start;
            }
            
            .scorecard-table {
                min-width: 700px;
                font-size: 9px;
            }
            
            .scorecard-table th,
            .scorecard-table td {
                padding: 2px;
                font-size: 8px;
            }
            
            .score-input {
                height: 22px;
                font-size: 9px;
                padding: 2px;
            }
            
            .stableford-display {
                font-size: 8px;
                padding: 1px;
                min-height: 14px;
            }
            
            .player-name-cell {
                min-width: 100px;
                font-size: 8px;
            }
            
            .comps-grid {
                grid-template-columns: 1fr;
            }
            
            .master-leaderboard-table .player-col {
                width: 120px;
            }
            
            .master-leaderboard-table .courses-col {
                width: 120px;
            }
            
            .master-leaderboard-table .combined-col {
                width: 80px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 4px;
                font-size: 10px;
            }
            
            .tab-nav {
                grid-template-columns: 1fr;
            }
            
            .players-container {
                grid-template-columns: 1fr;
            }
            
            .pairs-grid {
                grid-template-columns: 1fr;
            }
            
            .header-controls button {
                font-size: 10px;
                padding: 4px 6px;
            }
            
            .tab-button {
                padding: 6px;
                font-size: 10px;
            }
            
            .tab-content {
                padding: 8px;
            }
            
            .scorecard-table {
                min-width: 600px;
                font-size: 8px;
            }
            
            .score-input {
                height: 20px;
                font-size: 8px;
                padding: 1px;
            }
            
            .master-leaderboard-table {
                font-size: 9px;
            }
            
            .master-leaderboard-table th,
            .master-leaderboard-table td {
                padding: 4px 3px;
                font-size: 9px;
            }
            
            .master-leaderboard-table .player-col {
                width: 100px;
            }
            
            .master-leaderboard-table .courses-col {
                width: 100px;
            }
            
            .master-leaderboard-table .combined-col {
                width: 70px;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>üèåÔ∏è Golf Competition Manager</h1>
                <p>Professional Golf Tournament System By Kamal Dhunna</p>
            </div>
            <div class="header-controls">
                <button id="backupData" class="btn-warning">üíæ Backup</button>
                <button id="restoreData" class="btn-info">üì• Restore</button>
                <button id="shareWhatsApp" class="btn-success">üì± Share</button>
                <button id="captureImage" class="btn-secondary">üì∑ Capture</button>
                <button id="clearAllData" class="btn-danger">Clear All</button>
                <div class="export-import-group">
                    <button id="exportData" class="btn-primary">üì§ Export</button>
                    <button id="importData" class="btn-success">üì• Import</button>
                </div>
                <input type="file" id="importDataFileInput" accept=".csv,.xlsx,.xls" style="display: none;">
            </div>
        </header>

        <nav class="tab-nav">
            <button class="tab-button active" data-tab="players">üë• Players</button>
            <button class="tab-button" data-tab="courses">‚õ≥ Courses</button>
            <button class="tab-button" data-tab="scorecard">üìä Scorecard</button>
            <button class="tab-button" data-tab="leaderboard">üèÜ Leaderboard</button>
            <button class="tab-button" data-tab="pairs">ü§ù Pairs</button>
            <button class="tab-button" data-tab="comps">üéØ Comps</button>
            <button class="tab-button" data-tab="randomdraw">üé≤ Random Draw</button>
            <button class="tab-button" data-tab="information">‚ÑπÔ∏è Information</button>
        </nav>

        <main>
            <!-- Players Tab -->
            <div id="players-tab" class="tab-content active">
                <section class="players-section">
                    <div class="section-header">
                        <h2>Players Management</h2>
                        <div class="section-actions">
                            <button id="addPlayer" class="btn-primary">‚ûï Add Player</button>
                            <button id="clearPlayers" class="btn-warning btn-small">üóëÔ∏è Clear</button>
                        </div>
                    </div>
                    
                    <!-- Group Statistics -->
                    <div id="groupStats" class="group-stats" style="display: none;">
                        <!-- Group stats will be dynamically generated here -->
                    </div>
                    
                    <div id="playersContainer" class="players-container">
                        <div class="empty-message">
                            <h3>No players added yet</h3>
                            <p>Import players from Excel or add them manually.</p>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Courses Tab -->
            <div id="courses-tab" class="tab-content">
                <section class="courses-section">
                    <div class="section-header">
                        <h2>Course Management</h2>
                        <div class="section-actions">
                            <button id="addCourse" class="btn-primary">‚ûï Add Course</button>
                            <button id="backupCourses" class="btn-info btn-small">üíæ Backup</button>
                            <button id="clearCourses" class="btn-warning btn-small">üóëÔ∏è Clear</button>
                        </div>
                    </div>
                    
                    <div id="coursesContainer" class="players-container">
                        <div class="empty-message">
                            <h3>No courses available</h3>
                            <p>Add your first golf course to get started.</p>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Scorecard Tab -->
            <div id="scorecard-tab" class="tab-content">
                <section class="scorecard-section">
                    <div class="section-header">
                        <h2>Golf Scorecard</h2>
                        <div class="section-actions">
                            <button id="clearAllScores" class="btn-warning btn-small">üóëÔ∏è Clear Scores</button>
                            <button id="calculateScores" class="btn-success">üßÆ Calculate</button>
                        </div>
                    </div>
                    
                    <!-- Color Code Legend -->
                    <div class="color-legend">
                        <h4 style="margin-bottom: 6px; font-size: 0.8rem;"><i class="fas fa-palette"></i> Stableford Points Color Code</h4>
                        <div class="color-items">
                            <div class="color-item">
                                <div class="color-swatch" style="background: #2ecc71;"></div>
                                <div class="color-label">Par (2 Points)</div>
                            </div>
                            <div class="color-item">
                                <div class="color-swatch" style="background: #e74c3c;"></div>
                                <div class="color-label">Birdie (3 Points)</div>
                            </div>
                            <div class="color-item">
                                <div class="color-swatch" style="background: #9b59b6;"></div>
                                <div class="color-label">Eagle (4 Points)</div>
                            </div>
                            <div class="color-item">
                                <div class="color-swatch" style="background: #3498db;"></div>
                                <div class="color-label">Bogey (1 Point)</div>
                            </div>
                            <div class="color-item">
                                <div class="color-swatch" style="background: #ff6bc9;"></div>
                                <div class="color-label">Double+ (0 Points)</div>
                            </div>
                            <div class="color-item">
                                <div class="color-swatch" style="background: #f1c40f;"></div>
                                <div class="color-label">NR (No Return)</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="scorecard-actions">
                        <select id="scorecardCourseSelect">
                            <option value="">Select a course...</option>
                        </select>
                        <select id="scorecardGroupSelect">
                            <option value="all">All Players</option>
                            <!-- Groups will be dynamically added -->
                        </select>
                        <select id="scorecardSortSelect" style="padding: 6px; border: 1px solid #ddd; border-radius: 3px; font-size: 11px;">
                            <option value="name">Sort: Name (A‚ÜíZ)</option>
                            <option value="totalPoints" selected>Sort: Points (High‚ÜíLow)</option>
                            <option value="totalPointsAsc">Sort: Points (Low‚ÜíHigh)</option>
                            <option value="totalGross">Sort: Gross (Low‚ÜíHigh)</option>
                            <option value="totalGrossDesc">Sort: Gross (High‚ÜíLow)</option>
                            <option value="back9Points">Sort: Back 9 (High‚ÜíLow)</option>
                            <option value="front9Points">Sort: Front 9 (High‚ÜíLow)</option>
                        </select>
                        <button id="refreshScorecard" class="btn-primary">üîÑ Refresh</button>
                    </div>
                    
                    <div id="scorecardContainer">
                        <div class="no-scorecard-message">
                            <h3>No scorecard available yet</h3>
                            <p>Select a course and group to view the scorecard.</p>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Leaderboard Tab -->
            <div id="leaderboard-tab" class="tab-content">
                <section class="leaderboard-section">
                    <div class="section-header">
                        <h2>Leaderboard</h2>
                        <div class="section-actions">
                            <button id="refreshLeaderboard" class="btn-primary">üîÑ Refresh</button>
                            <button id="createMasterLeaderboard" class="btn-purple">üëë Master Leaderboard</button>
                        </div>
                    </div>
                    
                    <!-- Leaderboard Controls -->
                    <div class="leaderboard-controls" style="display: flex; gap: 8px; margin-bottom: 12px; padding: 10px; background: #f8f9fa; border-radius: 5px; border: 1px solid #e0e0e0; align-items: center; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <label for="leaderboardCurrency" style="font-size: 11px;">Currency:</label>
                            <select id="leaderboardCurrency" style="padding: 5px; border: 1px solid #ddd; border-radius: 3px; font-size: 11px;">
                                <option value="$">$ (USD)</option>
                                <option value="¬£">¬£ (GBP)</option>
                                <option value="‚Ç¨">‚Ç¨ (EUR)</option>
                                <option value="¬•">¬• (JPY)</option>
                                <option value="‚Çπ">‚Çπ (INR)</option>
                                <option value="A$">A$ (AUD)</option>
                                <option value="C$">C$ (CAD)</option>
                                <option value="">None</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <label for="leaderboardSortDefault" style="font-size: 11px;">Sort:</label>
                            <select id="leaderboardSortDefault" style="padding: 5px; border: 1px solid #ddd; border-radius: 3px; font-size: 11px;">
                                <option value="totalPoints">Points (High‚ÜíLow)</option>
                                <option value="totalPointsAsc">Points (Low‚ÜíHigh)</option>
                                <option value="totalGross">Gross (Low‚ÜíHigh)</option>
                                <option value="totalGrossDesc">Gross (High‚ÜíLow)</option>
                                <option value="name">Name (A‚ÜíZ)</option>
                                <option value="nameDesc">Name (Z‚ÜíA)</option>
                                <option value="money">Money (High‚ÜíLow)</option>
                            </select>
                        </div>
                        <button id="clearAllMoney" class="btn-warning btn-small">üóëÔ∏è Clear Money</button>
                        <button id="saveMoneyData" class="btn-success btn-small">üíæ Save Money</button>
                    </div>
                    
                    <div id="leaderboardContainer">
                        <div class="empty-message">
                            <h3>Leaderboard will appear here</h3>
                            <p>Enter scores on the scorecard to see the leaderboard.</p>
                        </div>
                    </div>

                    <!-- Master Leaderboard Container -->
                    <div id="masterLeaderboardContainer" style="display: none; margin-top: 20px;">
                        <div class="section-header" style="border-bottom: 2px solid #6c3483;">
                            <h2 style="color: #6c3483;">üëë Master Leaderboard</h2>
                            <div class="section-actions">
                                <button id="refreshMasterLeaderboard" class="btn-purple">üîÑ Refresh</button>
                                <button id="clearMasterLeaderboard" class="btn-warning btn-small">üóëÔ∏è Clear</button>
                            </div>
                        </div>
                        
                        <!-- Master Leaderboard Controls -->
                        <div style="display: flex; gap: 8px; margin-bottom: 12px; padding: 10px; background: #f8f9fa; border-radius: 5px; border: 1px solid #e0e0e0; align-items: center; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <label for="masterLeaderboardCurrency" style="font-size: 11px;">Currency:</label>
                                <select id="masterLeaderboardCurrency" style="padding: 5px; border: 1px solid #ddd; border-radius: 3px; font-size: 11px;">
                                    <option value="$">$ (USD)</option>
                                    <option value="¬£" selected>¬£ (GBP)</option>
                                    <option value="‚Ç¨">‚Ç¨ (EUR)</option>
                                    <option value="¬•">¬• (JPY)</option>
                                    <option value="‚Çπ">‚Çπ (INR)</option>
                                    <option value="A$">A$ (AUD)</option>
                                    <option value="C$">C$ (CAD)</option>
                                    <option value="">None</option>
                                </select>
                            </div>
                            <button id="clearMasterMoney" class="btn-warning btn-small">üóëÔ∏è Clear Money</button>
                            <button id="saveMasterMoney" class="btn-success btn-small">üíæ Save Money</button>
                        </div>
                        
                        <div id="masterLeaderboardContent">
                            <!-- Master leaderboard will be dynamically generated here -->
                        </div>
                    </div>
                </section>
            </div>

            <!-- Pairs Tab -->
            <div id="pairs-tab" class="tab-content">
                <section class="pairs-section">
                    <div class="section-header">
                        <h2>Pairs Competition</h2>
                        <div class="section-actions">
                            <button id="randomDrawPairs" class="btn-success btn-small">üé≤ Random Draw</button>
                            <button id="clearPairsMoney" class="btn-warning btn-small">üí∞ Clear Money</button>
                            <button id="savePairsMoney" class="btn-success btn-small">üíæ Save Money</button>
                        </div>
                    </div>
                    
                    <!-- Pairs Controls - Compact -->
                    <div class="pairs-controls" style="display: flex; gap: 6px; margin-bottom: 10px; padding: 8px; background: #f8f9fa; border-radius: 5px; border: 1px solid #e0e0e0; align-items: center; flex-wrap: wrap; font-size: 11px;">
                        <div style="display: flex; align-items: center; gap: 5px; flex: 1;">
                            <label for="pairsCourseSelect" style="font-size: 11px;">Course:</label>
                            <select id="pairsCourseSelect" style="padding: 5px; border: 1px solid #ddd; border-radius: 3px; font-size: 11px; min-width: 120px;">
                                <option value="">Select course...</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button id="calculatePairsScores" class="btn-primary btn-small">üßÆ Calc</button>
                            <button id="clearPairsScores" class="btn-warning btn-small">üóëÔ∏è Clear</button>
                        </div>
                    </div>
                    
                    <!-- Compact Pairs Display -->
                    <div id="pairsContainer">
                        <div class="empty-message">
                            <h3>No pairs created yet</h3>
                            <p>Select a course and click "Random Draw" to create pairs.</p>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Comps Tab -->
            <div id="comps-tab" class="tab-content">
                <section class="comps-section">
                    <div class="section-header">
                        <h2>Competition Types</h2>
                        <div class="section-actions">
                            <button id="refreshComps" class="btn-primary">üîÑ Refresh</button>
                            <button id="editAllComps" class="btn-warning btn-small">‚úèÔ∏è Edit All Comps</button>
                        </div>
                    </div>
                    
                    <div class="comps-grid" id="compsContainer">
                        <!-- Competition cards will be dynamically generated here -->
                        <div class="comp-card">
                            <h3>4 Ball Better Ball (4BBB)</h3>
                            <div class="comp-description">
                                A team competition where two players form a team. On each hole, the better net score of the two partners counts as the team score.
                            </div>
                            <div class="comp-actions" style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                                <button id="create4BBB" class="btn-success">üèåÔ∏è Auto Draw</button>
                                <button id="manualCreate4BBB" class="btn-info">‚úçÔ∏è Manual</button>
                                <button id="calculate4BBB" class="btn-primary" style="grid-column: 1 / -1;">üßÆ Calculate</button>
                            </div>
                        </div>
                        
                        <div class="comp-card">
                            <h3>4 Person Team (All Scores Count)</h3>
                            <div class="comp-description">
                                A team competition with 4 players per team. ALL FOUR scores count toward the team total on each hole (not just best 2).
                            </div>
                            <div class="comp-actions" style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                                <button id="create4PersonTeam" class="btn-teal">üë• Auto Draw</button>
                                <button id="manualCreate4PersonTeam" class="btn-info">‚úçÔ∏è Manual</button>
                                <button id="calculate4PersonTeam" class="btn-primary" style="grid-column: 1 / -1;">üßÆ Calculate</button>
                            </div>
                        </div>
                        
                        <div class="comp-card">
                            <h3>Best 3 from 4</h3>
                            <div class="comp-description">
                                A team competition where 4 players form a team, but only the best 3 net scores on each hole count toward the team total.
                            </div>
                            <div class="comp-actions" style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                                <button id="createBest3From4" class="btn-orange">‚≠ê Auto Draw</button>
                                <button id="manualCreateBest3From4" class="btn-info">‚úçÔ∏è Manual</button>
                                <button id="calculateBest3From4" class="btn-primary" style="grid-column: 1 / -1;">üßÆ Calculate</button>
                            </div>
                        </div>
                        
                        <div class="comp-card">
                            <h3>4 Person Team Mixed Score</h3>
                            <div class="comp-description">
                                4 players per team. P1: holes 1-4, P2: holes 5-9, P3: holes 10-13, P4: holes 14-18. Each player's net score counts only on their assigned holes.
                            </div>
                            <div class="comp-actions" style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                                <button id="createMixedScore" class="btn-success">üéØ Auto Draw</button>
                                <button id="manualCreateMixedScore" class="btn-info">‚úçÔ∏è Manual</button>
                                <button id="calculateMixedScore" class="btn-primary" style="grid-column: 1 / -1;">üßÆ Calculate</button>
                            </div>
                        </div>
                        
                        <div class="comp-card">
                            <h3>Team A vs Team B</h3>
                            <div class="comp-description">
                                A head-to-head team competition. Players can be randomly drawn or manually assigned to Team A or Team B. Each player's Stableford and Gross scores are calculated and totaled for their team.
                            </div>
                            <div class="comp-actions" style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                                <button id="createTeamAvsB" class="btn-success">üé≤ Auto Draw</button>
                                <button id="manualCreateTeamAvsB" class="btn-info">‚úçÔ∏è Manual Add</button>
                                <button id="calculateTeamAvsB" class="btn-primary" style="grid-column: 1 / -1;">üßÆ Calculate Scores</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="compsResultsContainer" style="margin-top: 20px;">
                        <!-- Competition results will be displayed here -->
                    </div>
                </section>
            </div>

            <!-- Random Draw Generator Tab -->
            <div id="randomdraw-tab" class="tab-content">
                <section class="randomdraw-section">
                    <div class="section-header">
                        <h2>üé≤ Random Draw Generator</h2>
                        <div class="section-actions">
                            <button id="clearRandomDraw" class="btn-warning btn-small">üóëÔ∏è Clear Draw</button>
                        </div>
                    </div>
                    
                    <!-- Random Draw Controls -->
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #e0e0e0; margin-bottom: 15px;">
                        <div style="display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 200px;">
                                <label for="randomDrawCourseSelect" style="display: block; margin-bottom: 5px; font-size: 11px; font-weight: 600;">Select Course *</label>
                                <select id="randomDrawCourseSelect" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px; font-size: 12px;">
                                    <option value="">-- Select a course --</option>
                                </select>
                            </div>
                            <button id="generateRandomDraw" class="btn-success" style="padding: 8px 15px; white-space: nowrap;">üé≤ Generate Draw</button>
                        </div>
                        <div style="margin-top: 10px; padding: 8px; background: #e8f5e9; border-left: 3px solid #2ecc71; border-radius: 3px; font-size: 11px; color: #2c3e50;">
                            <strong>‚ÑπÔ∏è Draw Logic:</strong> Players are truly randomized and distributed into groups. Priority: <strong>groups of 3</strong>, followed by <strong>groups of 4</strong> when needed. Maximum <strong>4 players</strong> per group.
                        </div>
                    </div>
                    
                    <!-- Draw Results Container -->
                    <div id="randomDrawContainer">
                        <div class="empty-message">
                            <h3>No draw generated yet</h3>
                            <p>Select a course and click "Generate Draw" to randomly assign players into groups.</p>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Information Tab -->
            <div id="information-tab" class="tab-content">
                <section class="information-section">
                    <div class="section-header">
                        <h2>‚ÑπÔ∏è Winnings Tracker</h2>
                        <div class="section-actions">
                            <button id="showHowTo" class="btn-info btn-small">üìñ How To</button>
                        </div>
                    </div>
                    
                    <!-- Grand Pot Section -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <div style="color: white;">
                                <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">üèÜ GRAND POT</div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span id="grandPotCurrency" style="font-size: 20px; font-weight: bold;">¬£</span>
                                    <input type="number" id="grandPotMoney" step="0.01" min="0" placeholder="0" style="width: 100px; padding: 8px; font-size: 18px; border: none; border-radius: 4px; font-weight: bold; text-align: center;">
                                </div>
                            </div>
                            <div style="text-align: right; color: white;">
                                <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">üí∞ REMAINING</div>
                                <div id="remainingPotMoney" style="font-size: 22px; font-weight: bold;">¬£0.00</div>
                            </div>
                        </div>
                        <button id="updateGrandPot" class="btn-success" style="margin-top: 10px; width: 100%;">üíæ Update Grand Pot</button>
                    </div>

                    <!-- Controls -->
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-bottom: 15px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                        <button id="addPlayerWinning" class="btn-success btn-small">‚ûï Add Player</button>
                        <button id="addTeamWinning" class="btn-primary btn-small">üë• Add Team Winning</button>
                        <button id="clearAllWinnings" class="btn-warning btn-small">üóëÔ∏è Clear All</button>
                        <button id="captureWinnings" class="btn-secondary btn-small">üì∑ Capture</button>
                        <div style="margin-left: auto; display: flex; gap: 6px; align-items: center;">
                            <label style="font-size: 11px; font-weight: 600;">Currency:</label>
                            <select id="infoTableCurrency" style="padding: 5px 8px; border: 1px solid #ddd; border-radius: 3px; font-size: 11px;">
                                <option value="¬£">¬£ (GBP)</option>
                                <option value="$">$ (USD)</option>
                                <option value="‚Ç¨">‚Ç¨ (EUR)</option>
                                <option value="¬•">¬• (JPY)</option>
                                <option value="‚Çπ">‚Çπ (INR)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Players Winnings Cards (wrapper for capture) -->
                    <div id="winningsCaptureArea">
                        <div id="winningsContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 12px;">
                            <!-- Cards will be generated here -->
                        </div>
                    </div>
                </section>
                
                <!-- Handicap Tracker Section -->
                <section class="handicap-tracker-section" style="margin-top: 30px;">
                    <div class="section-header">
                        <h2>üìä Handicap Tracker</h2>
                        <div class="section-actions">
                            <button id="addHandicapPlayer" class="btn-success btn-small">‚ûï Add Player</button>
                            <button id="clearHandicapTracker" class="btn-warning btn-small">üóëÔ∏è Clear All</button>
                            <button id="captureHandicapTracker" class="btn-secondary btn-small">üì∑ Capture</button>
                        </div>
                    </div>
                    
                    <!-- Handicap Tracker Table -->
                    <div id="handicapTrackerContainer" style="overflow-x: auto; margin-top: 15px;">
                        <!-- Table will be generated here -->
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Modal Forms -->
    <!-- Add Player Modal -->
    <div id="addPlayerForm" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>Add New Player</h3>
            <form id="playerFormElement">
                <div class="form-group" style="margin-bottom: 10px;">
                    <label for="playerName" style="font-size: 11px;">Player Name *</label>
                    <input type="text" id="playerName" required placeholder="Enter player name" style="padding: 6px; font-size: 12px;">
                </div>
                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 10px;">
                    <div class="form-group">
                        <label for="playerHandicapIndex" style="font-size: 11px;">Index H'cap *</label>
                        <input type="number" id="playerHandicapIndex" step="0.1" min="0" max="54" placeholder="0.0" required style="padding: 6px; font-size: 12px;">
                        <small style="color: #7f8c8d; font-size: 0.7rem;">Handicap Index</small>
                    </div>
                    <div class="form-group">
                        <label for="playerPHCPercentage" style="font-size: 11px;">PHC %</label>
                        <select id="playerPHCPercentage" style="padding: 6px; font-size: 12px;">
                            <option value="">Use Course Default</option>
                            <option value="100">100%</option>
                            <option value="95">95%</option>
                            <option value="90">90%</option>
                            <option value="85">85%</option>
                            <option value="80">80%</option>
                            <option value="75">75%</option>
                        </select>
                        <small style="color: #7f8c8d; font-size: 0.7rem;">Override PHC %</small>
                    </div>
                    <div class="form-group">
                        <label for="playerPHC" style="font-size: 11px;">PHC *</label>
                        <input type="number" id="playerPHC" min="0" max="54" placeholder="0" required style="padding: 6px; font-size: 12px;">
                        <small style="color: #7f8c8d; font-size: 0.7rem;">Playing Handicap</small>
                    </div>
                </div>
                
                <div class="form-group" style="margin-bottom: 10px;">
                    <label for="playerCourseSelect" style="font-size: 11px;">Course *</label>
                    <select id="playerCourseSelect" required style="padding: 6px; font-size: 12px;">
                        <option value="">Select course...</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 10px;">
                    <label for="playerGroupSelect" style="font-size: 11px;">Group (Max 4):</label>
                    <select id="playerGroupSelect" style="padding: 6px; font-size: 12px;">
                        <option value="">No Group</option>
                    </select>
                </div>
                <div class="form-actions" style="display: flex; gap: 6px; margin-top: 15px; justify-content: flex-end;">
                    <button type="button" id="savePlayer" class="btn-success">üíæ Save Player</button>
                    <button type="button" id="cancelPlayer" class="btn-secondary">‚ùå Cancel</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Create Team Modal -->
    <div id="createTeamModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3 id="teamModalTitle">Create Team</h3>
            <form id="teamFormElement">
                <div class="form-group" style="margin-bottom: 10px;">
                    <label for="teamCourseSelect" style="font-size: 11px;">Course *</label>
                    <select id="teamCourseSelect" required style="padding: 6px; font-size: 12px; width: 100%;">
                        <option value="">Select course...</option>
                    </select>
                </div>
                
                <div class="form-group" style="margin-bottom: 10px;">
                    <label for="teamCurrency" style="font-size: 11px;">Currency</label>
                    <select id="teamCurrency" style="padding: 6px; font-size: 12px; width: 100%;">
                        <option value="$">$ (USD)</option>
                        <option value="¬£" selected>¬£ (GBP)</option>
                        <option value="‚Ç¨">‚Ç¨ (EUR)</option>
                        <option value="¬•">¬• (JPY)</option>
                        <option value="‚Çπ">‚Çπ (INR)</option>
                        <option value="A$">A$ (AUD)</option>
                        <option value="C$">C$ (CAD)</option>
                        <option value="">None</option>
                    </select>
                </div>
                
                <div class="form-group" style="margin-bottom: 10px;">
                    <label for="teamMoneyValue" style="font-size: 11px;">Monetary Value (Optional)</label>
                    <div style="display: flex; gap: 5px; align-items: center;">
                        <span id="teamCurrencySymbol" style="font-size: 12px;">¬£</span>
                        <input type="number" id="teamMoneyValue" step="0.01" min="0" placeholder="0.00" style="padding: 6px; font-size: 12px; flex: 1;">
                    </div>
                    <small style="color: #7f8c8d; font-size: 0.7rem;">Prize money for each team</small>
                </div>
                
                <div class="form-actions" style="display: flex; gap: 6px; margin-top: 15px; justify-content: flex-end;">
                    <button type="button" id="confirmCreateTeam" class="btn-success">üíæ Create Team</button>
                    <button type="button" id="cancelCreateTeam" class="btn-secondary">‚ùå Cancel</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Manual Team Creation Modal -->
    <div id="manualTeamModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <h3 id="manualTeamModalTitle">Create Team Manually</h3>
            <form id="manualTeamFormElement">
                <div class="form-group" style="margin-bottom: 10px;">
                    <label for="manualTeamName" style="font-size: 11px;">Team Name *</label>
                    <input type="text" id="manualTeamName" required placeholder="Enter team name" style="padding: 6px; font-size: 12px; width: 100%;">
                </div>
                
                <div class="form-group" style="margin-bottom: 10px;">
                    <label for="manualTeamCourseSelect" style="font-size: 11px;">Course *</label>
                    <select id="manualTeamCourseSelect" required style="padding: 6px; font-size: 12px; width: 100%;">
                        <option value="">Select course...</option>
                    </select>
                </div>
                
                <div class="form-group" style="margin-bottom: 10px;">
                    <label for="manualTeamGroupSelect" style="font-size: 11px;">Group (Optional)</label>
                    <select id="manualTeamGroupSelect" style="padding: 6px; font-size: 12px; width: 100%;">
                        <option value="">No Group</option>
                    </select>
                </div>
                
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="font-size: 11px; display: block; margin-bottom: 8px;">Select Players *</label>
                    <div id="manualTeamPlayersSelection" style="max-height: 300px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 3px; padding: 10px; background: #f8f9fa;">
                        <!-- Player checkboxes will be dynamically added here -->
                    </div>
                    <small style="color: #7f8c8d; font-size: 0.7rem; margin-top: 5px; display: block;">Select <span id="manualTeamPlayersRequired">2</span> players for this team</small>
                </div>
                
                <div class="form-group" style="margin-bottom: 10px;">
                    <label for="manualTeamCurrency" style="font-size: 11px;">Currency</label>
                    <select id="manualTeamCurrency" style="padding: 6px; font-size: 12px; width: 100%;">
                        <option value="$">$ (USD)</option>
                        <option value="¬£" selected>¬£ (GBP)</option>
                        <option value="‚Ç¨">‚Ç¨ (EUR)</option>
                        <option value="¬•">¬• (JPY)</option>
                        <option value="‚Çπ">‚Çπ (INR)</option>
                        <option value="A$">A$ (AUD)</option>
                        <option value="C$">C$ (CAD)</option>
                        <option value="">None</option>
                    </select>
                </div>
                
                <div class="form-group" style="margin-bottom: 10px;">
                    <label for="manualTeamMoneyValue" style="font-size: 11px;">Monetary Value (Optional)</label>
                    <div style="display: flex; gap: 5px; align-items: center;">
                        <span id="manualTeamCurrencySymbol" style="font-size: 12px;">¬£</span>
                        <input type="number" id="manualTeamMoneyValue" step="0.01" min="0" placeholder="0.00" style="padding: 6px; font-size: 12px; flex: 1;">
                    </div>
                    <small style="color: #7f8c8d; font-size: 0.7rem;">Prize money for this team</small>
                </div>
                
                <div class="form-actions" style="display: flex; gap: 6px; margin-top: 15px; justify-content: flex-end;">
                    <button type="button" id="confirmManualTeam" class="btn-success">üíæ Create Team</button>
                    <button type="button" id="cancelManualTeam" class="btn-secondary">‚ùå Cancel</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Edit Team Modal -->
    <div id="editTeamModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3 id="editTeamModalTitle">Edit Team</h3>
            <form id="editTeamFormElement">
                <div class="form-group" style="margin-bottom: 10px;">
                    <label for="editTeamCurrency" style="font-size: 11px;">Currency</label>
                    <select id="editTeamCurrency" style="padding: 6px; font-size: 12px; width: 100%;">
                        <option value="$">$ (USD)</option>
                        <option value="¬£" selected>¬£ (GBP)</option>
                        <option value="‚Ç¨">‚Ç¨ (EUR)</option>
                        <option value="¬•">¬• (JPY)</option>
                        <option value="‚Çπ">‚Çπ (INR)</option>
                        <option value="A$">A$ (AUD)</option>
                        <option value="C$">C$ (CAD)</option>
                        <option value="">None</option>
                    </select>
                </div>
                
                <div class="form-group" style="margin-bottom: 10px;">
                    <label for="editTeamMoneyValue" style="font-size: 11px;">Monetary Value</label>
                    <div style="display: flex; gap: 5px; align-items: center;">
                        <span id="editTeamCurrencySymbol" style="font-size: 12px;">¬£</span>
                        <input type="number" id="editTeamMoneyValue" step="0.01" min="0" placeholder="0.00" style="padding: 6px; font-size: 12px; flex: 1;">
                    </div>
                    <small style="color: #7f8c8d; font-size: 0.7rem;">Prize money for this team</small>
                </div>
                
                <div id="editTeamPlayersContainer" style="margin-bottom: 15px;">
                    <!-- Players will be dynamically added here -->
                </div>
                
                <div class="form-actions" style="display: flex; gap: 6px; margin-top: 15px; justify-content: flex-end;">
                    <button type="button" id="confirmEditTeam" class="btn-success">üíæ Save Changes</button>
                    <button type="button" id="cancelEditTeam" class="btn-secondary">‚ùå Cancel</button>
                    <button type="button" id="deleteEditTeam" class="btn-danger">üóëÔ∏è Delete Team</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Edit All Comps Modal -->
    <div id="editAllCompsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>Edit All Competition Money</h3>
            
            <div style="margin-bottom: 15px;">
                <label for="editAllCurrency" style="font-size: 11px;">Currency for All</label>
                <select id="editAllCurrency" style="padding: 6px; font-size: 12px; width: 100%; margin-bottom: 10px;">
                    <option value="$">$ (USD)</option>
                    <option value="¬£" selected>¬£ (GBP)</option>
                    <option value="‚Ç¨">‚Ç¨ (EUR)</option>
                    <option value="¬•">¬• (JPY)</option>
                    <option value="‚Çπ">‚Çπ (INR)</option>
                    <option value="A$">A$ (AUD)</option>
                    <option value="C$">C$ (CAD)</option>
                    <option value="">None</option>
                </select>
            </div>
            
            <div id="editAllCompsContainer">
                <!-- All teams will be dynamically added here -->
            </div>
            
            <div class="form-actions" style="display: flex; gap: 6px; margin-top: 15px; justify-content: flex-end;">
                <button type="button" id="confirmEditAll" class="btn-success">üíæ Save All Changes</button>
                <button type="button" id="cancelEditAll" class="btn-secondary">‚ùå Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Add Course Modal -->
    <div id="addCourseForm" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <h3>Add New Course</h3>
            <form id="courseFormElement">
                <div class="form-group" style="margin-bottom: 10px;">
                    <label for="courseName" style="font-size: 11px;">Course Name *</label>
                    <input type="text" id="courseName" required placeholder="Enter course name" style="padding: 6px; font-size: 12px; width: 100%;">
                </div>
                
                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px;">
                    <div class="form-group">
                        <label for="courseRating" style="font-size: 11px;">Course Rating *</label>
                        <input type="number" id="courseRating" step="0.1" min="50" max="85" value="72.0" required style="padding: 6px; font-size: 12px; width: 100%;">
                    </div>
                    <div class="form-group">
                        <label for="courseSlope" style="font-size: 11px;">Slope Rating *</label>
                        <input type="number" id="courseSlope" min="55" max="155" value="113" required style="padding: 6px; font-size: 12px; width: 100%;">
                    </div>
                </div>
                
                <div style="margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 5px; border: 1px solid #e0e0e0;">
                    <h4 style="margin-bottom: 10px; font-size: 0.9rem;">Hole Configuration</h4>
                    <button type="button" id="useDefaultHoles" class="btn-info btn-small" style="margin-bottom: 10px;">‚öôÔ∏è Use Default (Par 72)</button>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <!-- Front 9 -->
                        <div>
                            <h5 style="margin-bottom: 8px; font-size: 0.85rem; color: #2c3e50;">Front 9</h5>
                            <div id="front9Holes" style="display: grid; gap: 6px;"></div>
                        </div>
                        
                        <!-- Back 9 -->
                        <div>
                            <h5 style="margin-bottom: 8px; font-size: 0.85rem; color: #2c3e50;">Back 9</h5>
                            <div id="back9Holes" style="display: grid; gap: 6px;"></div>
                        </div>
                    </div>
                </div>
                
                <div class="form-actions" style="display: flex; gap: 6px; margin-top: 15px; justify-content: flex-end;">
                    <button type="button" id="saveCourse" class="btn-success">üíæ Save Course</button>
                    <button type="button" id="cancelCourse" class="btn-secondary">‚ùå Cancel</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Team A vs Team B Modal -->
    <div id="teamAvsBModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 700px;">
            <h3 id="teamAvsBModalTitle">Team A vs Team B</h3>
            <form id="teamAvsBFormElement">
                <div class="form-group" style="margin-bottom: 10px;">
                    <label for="teamAvsBCourseSelect" style="font-size: 11px;">Course *</label>
                    <select id="teamAvsBCourseSelect" required style="padding: 6px; font-size: 12px; width: 100%;">
                        <option value="">Select course...</option>
                    </select>
                </div>
                
                <div id="teamAvsBPlayersSection" style="display: none; margin-top: 15px;">
                    <h4 style="font-size: 0.9rem; margin-bottom: 10px; color: #2c3e50;">Players Assignment</h4>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <!-- Team A -->
                        <div>
                            <div style="background: #ebf5fb; padding: 8px; border-radius: 3px; border: 2px solid #3498db; margin-bottom: 8px;">
                                <strong style="color: #2c3e50;">Team A (<span id="teamACount">0</span> players)</strong>
                            </div>
                            <div id="teamAPlayersList" style="max-height: 300px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 3px; padding: 8px; background: #f8f9fa;">
                                <!-- Team A players will be listed here -->
                            </div>
                        </div>
                        
                        <!-- Team B -->
                        <div>
                            <div style="background: #fadbd8; padding: 8px; border-radius: 3px; border: 2px solid #e74c3c; margin-bottom: 8px;">
                                <strong style="color: #2c3e50;">Team B (<span id="teamBCount">0</span> players)</strong>
                            </div>
                            <div id="teamBPlayersList" style="max-height: 300px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 3px; padding: 8px; background: #f8f9fa;">
                                <!-- Team B players will be listed here -->
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-left: 3px solid #f39c12; border-radius: 3px; font-size: 11px;">
                        <strong>‚ÑπÔ∏è Instructions:</strong> Click on any player to move them between teams or remove them.
                    </div>
                </div>
                
                <div class="form-actions" style="display: flex; gap: 6px; margin-top: 15px; justify-content: flex-end;">
                    <button type="button" id="teamAvsBAutoDraw" class="btn-success" style="display: none;">üé≤ Auto Draw Players</button>
                    <button type="button" id="confirmTeamAvsB" class="btn-primary">üíæ Save Teams</button>
                    <button type="button" id="cancelTeamAvsB" class="btn-secondary">‚ùå Cancel</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- How To Modal -->
    <div id="howToModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
            <h3 style="margin-bottom: 20px; color: #2c3e50;">üìñ Professional Golf Management System - User Guide</h3>
            
            <div style="background: #e8f5e9; padding: 15px; border-radius: 5px; margin-bottom: 20px; border-left: 4px solid #2ecc71;">
                <strong>üéØ Quick Start:</strong> This comprehensive guide covers all features and functionalities of the Golf Management System.
            </div>
            
            <div id="howToContent" style="padding: 10px; font-size: 13px; line-height: 1.8; color: #2c3e50;">
                <!-- Players Tab -->
                <h4 style="color: #3498db; border-bottom: 2px solid #3498db; padding-bottom: 5px; margin-top: 20px;">üë• PLAYERS TAB</h4>
                
                <h5 style="color: #2c3e50; margin-top: 15px;">‚ûï Adding Players:</h5>
                <ol style="margin-left: 20px;">
                    <li>Click the <strong>"‚ûï Add Player"</strong> button at the top</li>
                    <li>Fill in player details:
                        <ul style="margin-left: 20px;">
                            <li><strong>Player Name:</strong> Enter full name</li>
                            <li><strong>Index Handicap:</strong> Official handicap index (0.0 - 54.0)</li>
                            <li><strong>PHC %:</strong> Playing Handicap percentage (optional override)</li>
                            <li><strong>PHC:</strong> Playing Handicap (auto-calculated)</li>
                            <li><strong>Course:</strong> Select the course for this player</li>
                            <li><strong>Group:</strong> Assign to a group (max 4 players per group)</li>
                        </ul>
                    </li>
                    <li>Click <strong>"üíæ Save Player"</strong></li>
                </ol>
                
                <h5 style="color: #2c3e50; margin-top: 15px;">‚úèÔ∏è Editing Players:</h5>
                <ul style="margin-left: 20px;">
                    <li>Click the <strong>"‚úèÔ∏è Edit"</strong> button next to any player</li>
                    <li>Modify details and click <strong>"üíæ Update Player"</strong></li>
                </ul>
                
                <h5 style="color: #2c3e50; margin-top: 15px;">üóëÔ∏è Deleting Players:</h5>
                <ul style="margin-left: 20px;">
                    <li>Click the <strong>"üóëÔ∏è Delete"</strong> button next to any player</li>
                    <li>Confirm deletion (this removes all associated scores)</li>
                </ul>
                
                <h5 style="color: #2c3e50; margin-top: 15px;">üìÑ Export/Import:</h5>
                <ul style="margin-left: 20px;">
                    <li><strong>"üì• Backup Data":</strong> Downloads all data as JSON file</li>
                    <li><strong>"üì§ Restore Data":</strong> Imports previously saved data</li>
                    <li><strong>"üóëÔ∏è Clear Players":</strong> Removes all players and data (use with caution!)</li>
                </ul>
                
                <!-- Courses Tab -->
                <h4 style="color: #3498db; border-bottom: 2px solid #3498db; padding-bottom: 5px; margin-top: 25px;">‚õ≥ COURSES TAB</h4>
                
                <h5 style="color: #2c3e50; margin-top: 15px;">‚ûï Adding Courses:</h5>
                <ol style="margin-left: 20px;">
                    <li>Click <strong>"‚ûï Add Course"</strong></li>
                    <li>Enter course details:
                        <ul style="margin-left: 20px;">
                            <li><strong>Course Name:</strong> Official course name</li>
                            <li><strong>PHC %:</strong> Default playing handicap percentage (85-100%)</li>
                            <li><strong>Course Rating:</strong> Official rating (e.g., 72.0)</li>
                            <li><strong>Slope Rating:</strong> Official slope (55-155, typically 113)</li>
                        </ul>
                    </li>
                    <li>Configure holes:
                        <ul style="margin-left: 20px;">
                            <li>Click <strong>"‚öôÔ∏è Use Default (Par 72)"</strong> for standard setup</li>
                            <li>Or manually enter Par and Stroke Index for each hole</li>
                        </ul>
                    </li>
                    <li>Click <strong>"üíæ Save Course"</strong></li>
                </ol>
                
                <!-- Scorecard Tab -->
                <h4 style="color: #3498db; border-bottom: 2px solid #3498db; padding-bottom: 5px; margin-top: 25px;">üìã SCORECARD TAB</h4>
                
                <h5 style="color: #2c3e50; margin-top: 15px;">üéØ Entering Scores:</h5>
                <ol style="margin-left: 20px;">
                    <li>Select <strong>Course</strong> from dropdown</li>
                    <li>Filter by <strong>Group</strong> (optional)</li>
                    <li>Enter gross scores in yellow cells for each hole</li>
                    <li>System auto-calculates:
                        <ul style="margin-left: 20px;">
                            <li><strong>Net Score:</strong> Gross - strokes received</li>
                            <li><strong>Points:</strong> Stableford points per hole</li>
                            <li><strong>Totals:</strong> Front 9, Back 9, Total</li>
                        </ul>
                    </li>
                </ol>
                
                <h5 style="color: #2c3e50; margin-top: 15px;">üîÑ Scorecard Buttons:</h5>
                <ul style="margin-left: 20px;">
                    <li><strong>"üîÑ Refresh":</strong> Reload scorecard data</li>
                    <li><strong>"üßÆ Calculate":</strong> Recalculate all scores and points</li>
                    <li><strong>"üóëÔ∏è Clear All Scores":</strong> Remove all scores (confirmation required)</li>
                </ul>
                
                <!-- Leaderboard Tab -->
                <h4 style="color: #3498db; border-bottom: 2px solid #3498db; padding-bottom: 5px; margin-top: 25px;">üèÜ LEADERBOARD TAB</h4>
                
                <h5 style="color: #2c3e50; margin-top: 15px;">üìä Viewing Results:</h5>
                <ul style="margin-left: 20px;">
                    <li>Displays all players' performance across courses</li>
                    <li>Shows: Total Points, Gross Total, Net Total, Prize Money</li>
                    <li>Color-coded names indicate different courses</li>
                </ul>
                
                <h5 style="color: #2c3e50; margin-top: 15px;">üí∞ Adding Prize Money:</h5>
                <ol style="margin-left: 20px;">
                    <li>Click <strong>"üí∞ Add Money"</strong></li>
                    <li>Select currency (¬£, $, ‚Ç¨, etc.)</li>
                    <li>Enter player name and amount</li>
                    <li>Click <strong>"üíæ Save"</strong></li>
                </ol>
                
                <h5 style="color: #2c3e50; margin-top: 15px;">üîΩ Sorting:</h5>
                <ul style="margin-left: 20px;">
                    <li>Click any column header to sort</li>
                    <li>Set default sort order in settings dropdown</li>
                </ul>
                
                <h5 style="color: #2c3e50; margin-top: 15px;">üåü Master Leaderboard:</h5>
                <ul style="margin-left: 20px;">
                    <li>Tracks cumulative performance across all rounds</li>
                    <li><strong>"‚ûï Add to Master":</strong> Include players in master tracking</li>
                    <li>Weekly totals accumulated automatically</li>
                </ul>
                
                <h5 style="color: #e74c3c; margin-top: 15px;">‚öñÔ∏è COMPLETE COUNTBACK TIE-BREAKING RULES:</h5>
                <div style="background: #fff3cd; padding: 12px; border-left: 4px solid #f39c12; border-radius: 3px; margin: 10px 0;">
                    <p style="margin-bottom: 8px; font-weight: bold;">When players are tied on total Stableford points, positions are determined using the following 11-step official countback sequence:</p>
                </div>
                <ol style="margin-left: 20px;">
                    <li><strong>Total Stableford Points</strong> - Compare overall points</li>
                    <li><strong>Back 9 (Holes 10-18)</strong> - If tied, compare back 9 points</li>
                    <li><strong>Holes 13-18 (Last 6 of back 9)</strong> - If still tied</li>
                    <li><strong>Holes 16-18 (Last 3 holes)</strong> - If still tied</li>
                    <li><strong>Holes 17-18 (Last 2 holes)</strong> - If still tied</li>
                    <li><strong>Hole 18 (Last 1 hole)</strong> - If still tied</li>
                    <li><strong>Front 9 (Holes 1-9)</strong> - If still tied, compare front 9 points</li>
                    <li><strong>Holes 4-9 (Last 6 of front 9)</strong> - If still tied</li>
                    <li><strong>Holes 7-9 (Last 3 of front 9)</strong> - If still tied</li>
                    <li><strong>Holes 8-9 (Last 2 of front 9)</strong> - If still tied</li>
                    <li><strong>Hole 9 (Last hole of front 9)</strong> - Final tiebreaker</li>
                </ol>
                <div style="background: #e8f5e9; padding: 10px; border-left: 4px solid #2ecc71; border-radius: 3px; margin: 10px 0;">
                    <p style="margin: 0;"><strong>üí° Tip:</strong> The scorecard displays all 11 countback values in separate columns, showing the complete progression from left to right in order of priority.</p>
                </div>
                <div style="background: #e3f2fd; padding: 10px; border-left: 4px solid #2196F3; border-radius: 3px; margin: 10px 0;">
                    <p style="margin: 0;"><strong>‚ÑπÔ∏è Note:</strong> Players only share the same position if they remain tied after all 11 countback checks have been applied.</p>
                </div>
                
                <!-- Pairs Tab -->
                <h4 style="color: #3498db; border-bottom: 2px solid #3498db; padding-bottom: 5px; margin-top: 25px;">ü§ù PAIRS TAB</h4>
                
                <h5 style="color: #2c3e50; margin-top: 15px;">üé≤ Generating Pairs:</h5>
                <ol style="margin-left: 20px;">
                    <li>Select <strong>Course</strong></li>
                    <li>Click <strong>"üé≤ Generate Pairs"</strong></li>
                    <li>System randomly pairs players from selected course</li>
                    <li>Each pair assigned to a group</li>
                </ol>
                
                <h5 style="color: #2c3e50; margin-top: 15px;">üìä Calculating Pairs Results:</h5>
                <ol style="margin-left: 20px;">
                    <li>Ensure scores are entered in Scorecard tab</li>
                    <li>Click <strong>"üßÆ Calculate Pairs"</strong></li>
                    <li>System calculates best ball scores and points</li>
                    <li>Results show combined pair performance</li>
                </ol>
                
                <h5 style="color: #2c3e50; margin-top: 15px;">üí∞ Pairs Prize Money:</h5>
                <ul style="margin-left: 20px;">
                    <li>Click <strong>"üí∞ Add Prize"</strong> next to any pair</li>
                    <li>Enter amount - automatically splits between partners</li>
                </ul>
                
                <!-- Competitions Tab -->
                <h4 style="color: #3498db; border-bottom: 2px solid #3498db; padding-bottom: 5px; margin-top: 25px;">üèÖ COMPETITIONS TAB</h4>
                
                <h5 style="color: #2c3e50; margin-top: 15px;">üéØ 4 Ball Better Ball (4BBB):</h5>
                <ul style="margin-left: 20px;">
                    <li><strong>"‚≠ê Auto Draw":</strong> Randomly create 4-player teams</li>
                    <li><strong>"‚úçÔ∏è Manual":</strong> Manually select team members</li>
                    <li><strong>"üßÆ Calculate":</strong> Process best ball scoring</li>
                    <li><strong>Scoring:</strong> Best net score per hole from 4 players</li>
                </ul>
                
                <h5 style="color: #2c3e50; margin-top: 15px;">üë• 4 Person Teams:</h5>
                <ul style="margin-left: 20px;">
                    <li>Each player contributes to team score</li>
                    <li>Combined Stableford points</li>
                </ul>
                
                <h5 style="color: #2c3e50; margin-top: 15px;">üéØ Best 3 From 4:</h5>
                <ul style="margin-left: 20px;">
                    <li>4 players per team</li>
                    <li>Best 3 net scores count per hole</li>
                    <li>Discard worst score each hole</li>
                </ul>
                
                <h5 style="color: #2c3e50; margin-top: 15px;">üéØ 4 Person Team Mixed Score:</h5>
                <ul style="margin-left: 20px;">
                    <li>P1: Holes 1-4</li>
                    <li>P2: Holes 5-9</li>
                    <li>P3: Holes 10-13</li>
                    <li>P4: Holes 14-18</li>
                    <li>Each player's net score counts only on assigned holes</li>
                </ul>
                
                <h5 style="color: #2c3e50; margin-top: 15px;">‚öîÔ∏è Team A vs Team B:</h5>
                <ol style="margin-left: 20px;">
                    <li>Click <strong>"üé≤ Auto Draw"</strong> or <strong>"‚úçÔ∏è Manual Add"</strong></li>
                    <li>Select course and assign players to teams</li>
                    <li>Click <strong>"üßÆ Calculate Scores"</strong></li>
                    <li>System totals Stableford and Gross scores per team</li>
                </ol>
                
                <h5 style="color: #2c3e50; margin-top: 15px;">üí∞ Competition Prize Money:</h5>
                <ul style="margin-left: 20px;">
                    <li>Click <strong>"‚úèÔ∏è Edit"</strong> on any competition result</li>
                    <li>Enter prize amounts for each position</li>
                    <li>Automatically splits between team members</li>
                </ul>
                
                <!-- Random Draw Tab -->
                <h4 style="color: #3498db; border-bottom: 2px solid #3498db; padding-bottom: 5px; margin-top: 25px;">üé≤ RANDOM DRAW TAB</h4>
                
                <h5 style="color: #2c3e50; margin-top: 15px;">üé≤ Generating Draw:</h5>
                <ol style="margin-left: 20px;">
                    <li>Select <strong>Course</strong></li>
                    <li>Click <strong>"üé≤ Generate Draw"</strong></li>
                    <li>System randomly distributes players into groups</li>
                    <li><strong>Priority:</strong> Groups of 3, then groups of 4</li>
                    <li><strong>Maximum:</strong> 4 players per group</li>
                </ol>
                
                <h5 style="color: #2c3e50; margin-top: 15px;">üîÑ Draw Features:</h5>
                <ul style="margin-left: 20px;">
                    <li>Truly randomized player distribution</li>
                    <li>Balanced group sizes</li>
                    <li><strong>"üóëÔ∏è Clear Draw":</strong> Remove current draw</li>
                </ul>
                
                <!-- Information Tab -->
                <h4 style="color: #3498db; border-bottom: 2px solid #3498db; padding-bottom: 5px; margin-top: 25px;">‚ÑπÔ∏è INFORMATION TAB (WINNINGS TRACKER)</h4>
                
                <h5 style="color: #2c3e50; margin-top: 15px;">üèÜ Setting Up Grand Pot:</h5>
                <ol style="margin-left: 20px;">
                    <li>Enter total pot amount in <strong>"GRAND POT"</strong> field</li>
                    <li>Click <strong>"üíæ Update Grand Pot"</strong></li>
                    <li>System tracks remaining amount as prizes are awarded</li>
                </ol>
                
                <h5 style="color: #2c3e50; margin-top: 15px;">‚ûï Adding Individual Winner:</h5>
                <ol style="margin-left: 20px;">
                    <li>Click <strong>"‚ûï Add Player"</strong></li>
                    <li>Enter:
                        <ul style="margin-left: 20px;">
                            <li>Player name</li>
                            <li>Competition name (e.g., "Stableford")</li>
                            <li>Position (1st, 2nd, 3rd)</li>
                            <li>Prize money</li>
                        </ul>
                    </li>
                    <li>Creates individual winner card</li>
                </ol>
                
                <h5 style="color: #2c3e50; margin-top: 15px;">üë• Adding Team Winning:</h5>
                <ol style="margin-left: 20px;">
                    <li>Click <strong>"üë• Add Team Winning"</strong></li>
                    <li>Enter:
                        <ul style="margin-left: 20px;">
                            <li>Competition name (e.g., "Pairs", "4BBB")</li>
                            <li>Team size (2-4 players)</li>
                            <li>ALL player names (one prompt per player)</li>
                            <li>Team position</li>
                            <li>Total prize money</li>
                        </ul>
                    </li>
                    <li>System automatically splits prize equally among team members</li>
                    <li>Creates single team card showing all members</li>
                </ol>
                
                <h5 style="color: #2c3e50; margin-top: 15px;">üìä Winnings Display:</h5>
                <ul style="margin-left: 20px;">
                    <li><strong>Individual cards:</strong> Show player name, competition, position, amount</li>
                    <li><strong>Team cards:</strong> Show all team members with individual shares</li>
                    <li><strong>Grand Pot tracking:</strong> Shows remaining pot (green if positive, red if exceeded)</li>
                </ul>
                
                <h5 style="color: #2c3e50; margin-top: 15px;">üîß Winnings Management:</h5>
                <ul style="margin-left: 20px;">
                    <li><strong>Currency selector:</strong> Change display currency (¬£, $, ‚Ç¨, ¬•, ‚Çπ)</li>
                    <li><strong>"üóëÔ∏è Delete":</strong> Remove individual or team winning entry</li>
                    <li><strong>"üóëÔ∏è Clear All":</strong> Remove all winnings data</li>
                </ul>
                
                <!-- Header Buttons -->
                <h4 style="color: #3498db; border-bottom: 2px solid #3498db; padding-bottom: 5px; margin-top: 25px;">üîß HEADER BUTTONS (ALL TABS)</h4>
                
                <h5 style="color: #2c3e50; margin-top: 15px;">üì• Backup Data:</h5>
                <ul style="margin-left: 20px;">
                    <li>Downloads complete system data as JSON file</li>
                    <li>Includes: players, courses, scores, pairs, competitions, winnings</li>
                    <li>File named: <code>golf-data-[timestamp].json</code></li>
                </ul>
                
                <h5 style="color: #2c3e50; margin-top: 15px;">üì§ Restore Data:</h5>
                <ul style="margin-left: 20px;">
                    <li>Imports previously saved backup file</li>
                    <li>Overwrites current data (backup first!)</li>
                    <li>Restores complete system state</li>
                </ul>
                
                <!-- Tips & Best Practices -->
                <h4 style="color: #e67e22; border-bottom: 2px solid #e67e22; padding-bottom: 5px; margin-top: 25px;">üí° TIPS & BEST PRACTICES</h4>
                
                <ul style="margin-left: 20px;">
                    <li><strong>üíæ Regular Backups:</strong> Use "Backup Data" button regularly to save your work</li>
                    <li><strong>‚õ≥ Course Setup:</strong> Set up courses before adding players</li>
                    <li><strong>üë• Group Organization:</strong> Assign players to groups for easier score entry</li>
                    <li><strong>üìä Score Entry:</strong> Enter all scores before running competition calculations</li>
                    <li><strong>üí∞ Prize Tracking:</strong> Use Information tab to track all winnings in one place</li>
                    <li><strong>üîÑ Recalculate:</strong> Use calculate buttons after editing scores or adding players</li>
                    <li><strong>üì± Mobile Friendly:</strong> System works on tablets and phones</li>
                    <li><strong>üåê Browser Storage:</strong> Data saved locally in browser (backup to preserve)</li>
                </ul>
                
                <!-- Troubleshooting -->
                <h4 style="color: #e74c3c; border-bottom: 2px solid #e74c3c; padding-bottom: 5px; margin-top: 25px;">‚ö†Ô∏è TROUBLESHOOTING</h4>
                
                <ul style="margin-left: 20px;">
                    <li><strong>Scores not appearing?</strong> Click "Refresh" or "Calculate" button</li>
                    <li><strong>Pairs not generating?</strong> Ensure players assigned to selected course</li>
                    <li><strong>Competition results missing?</strong> Verify scores entered for all team members</li>
                    <li><strong>Lost data?</strong> Use "Restore Data" with your backup file</li>
                    <li><strong>Wrong calculations?</strong> Check PHC % settings and course slope/rating</li>
                </ul>
                
                <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin-top: 25px; border-left: 4px solid #f39c12;">
                    <strong>‚ÑπÔ∏è Note:</strong> All data is stored locally in your browser. Regular backups are recommended to prevent data loss.
                </div>
                
                <div style="background: #e8f5e9; padding: 15px; border-radius: 5px; margin-top: 15px; border-left: 4px solid #2ecc71;">
                    <strong>üéâ Version:</strong> Professional Golf Management System v2.0.0 | <strong>üìß Support:</strong> Contact system administrator for assistance
                </div>
            </div>
            
            <div class="form-actions" style="display: flex; gap: 6px; justify-content: center; margin-top: 20px; padding-top: 15px; border-top: 2px solid #e0e0e0;">
                <button type="button" id="closeHowTo" class="btn-primary" style="padding: 10px 30px;">‚úîÔ∏è Close Guide</button>
            </div>
        </div>
    </div>
    
    <!-- File inputs -->
    <input type="file" id="restoreFileInput" accept=".json" style="display: none;">

    <script>
        // Complete Golf Competition Manager v2.0 - Ultra Compact Edition
        // Build Date: 2026-01-08
        const APP_VERSION = '2.0.0-compact';
        console.log('Golf Manager Version:', APP_VERSION);
        console.log('Styles loaded:', document.styleSheets.length > 0);
        
        const app = {
            players: [],
            courses: [],
            pairs: [],
            currentHoleInputs: [],
            MAX_PLAYERS_PER_GROUP: 4,
            scores: {},
            currentTab: 'players',
            scorecardSettings: {
                selectedCourseId: '',
                selectedGroupFilter: 'all'
            },
            leaderboardMoney: {},
            leaderboardSettings: {
                currency: '$',
                defaultSort: 'totalPoints'
            },
            currentSort: {
                column: 'totalPoints',
                direction: 'desc'
            },
            pairsScores: {},
            pairsMoney: {},
            pairsSettings: {
                currency: '$'
            },
            
            // Track which course has been used for pairs
            pairsCourseGenerated: '',
            
            // Comps data with monetary values
            comps: {
                fourBBB: [],
                fourPersonTeams: [],
                best3From4: [],
                mixedScore: [],
                teamAvsB: { teamA: [], teamB: [], courseName: '' }
            },
            
            // Track current competition type for modal
            currentCompType: null,
            currentEditTeam: null,
            currentEditTeamType: null,
            
            // Master Leaderboard data
            masterLeaderboardData: [],
            
            // Random Draw data
            randomDrawGroups: [],
            randomDrawCourse: '',
            
            // Master Leaderboard money data
            masterLeaderboardMoney: {},
            masterLeaderboardCurrency: '¬£',
            
            // Temporary Team A vs Team B data for modal
            tempTeamAvsB: null,
            
            // How To content
            howToContent: '',
            
            // Information - Winnings data (team-based structure)
            winningsData: {
                teams: [], // [{comp: '', position: '', players: ['name1', 'name2'], totalAmount: 0}]
                currency: '¬£',
                grandPotMoney: 0
            },
            
            // Handicap Tracker data
            handicapTracker: {
                headers: {
                    col1: 'Start HCP',
                    col2: 'Cut Applied',
                    col3: 'New HCP'
                },
                dayLabels: ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5'],
                afterLabels: ['After Day 1', 'After Day 2', 'After Day 3', 'After Day 4', 'After Day 5'],
                players: [] // [{name: '', days: [{startHcp: '', cutApplied: '', newHcp: ''}, ...]}]
            },
            
            init() {
                this.loadData();
                this.setupEventListeners();
                this.setupTabs();
                this.renderPlayers();
                this.renderCourses();
                this.renderPairs();
                this.updateGroupStats();
                this.populateScorecardDropdowns();
                this.populatePairsCourseDropdown();
                this.populateRandomDrawCourseDropdown();
                
                this.restoreActiveTab();
                this.restoreScorecardSettings();
                this.restoreLeaderboardSettings();
                this.restorePairsSettings();
                
                if (this.scorecardSettings.selectedCourseId) {
                    this.renderScorecard();
                }
                
                // Render winnings if on information tab
                if (this.currentTab === 'information') {
                    this.renderWinnings();
                }
                
                this.showToast('App loaded successfully!', 'success');
            },
            
            loadData() {
                try {
                    const savedPlayers = localStorage.getItem('golfPlayers');
                    if (savedPlayers) this.players = JSON.parse(savedPlayers);
                    
                    const savedCourses = localStorage.getItem('golfCourses');
                    if (savedCourses) this.courses = JSON.parse(savedCourses);
                    
                    const savedPairs = localStorage.getItem('golfPairs');
                    if (savedPairs) this.pairs = JSON.parse(savedPairs);
                    
                    const savedScores = localStorage.getItem('golfScores');
                    if (savedScores) {
                        this.scores = JSON.parse(savedScores);
                        Object.keys(this.scores).forEach(playerId => {
                            Object.keys(this.scores[playerId]).forEach(hole => {
                                const score = this.scores[playerId][hole];
                                if (score === 0 || score === "0") {
                                    this.scores[playerId][hole] = 0;
                                }
                            });
                        });
                    }
                    
                    const savedTab = localStorage.getItem('golfActiveTab');
                    if (savedTab) this.currentTab = savedTab;
                    
                    const savedScorecardSettings = localStorage.getItem('golfScorecardSettings');
                    if (savedScorecardSettings) this.scorecardSettings = JSON.parse(savedScorecardSettings);
                    
                    const savedMoney = localStorage.getItem('golfLeaderboardMoney');
                    if (savedMoney) this.leaderboardMoney = JSON.parse(savedMoney);
                    
                    const savedLeaderboardSettings = localStorage.getItem('golfLeaderboardSettings');
                    if (savedLeaderboardSettings) this.leaderboardSettings = JSON.parse(savedLeaderboardSettings);
                    
                    const savedPairsScores = localStorage.getItem('golfPairsScores');
                    if (savedPairsScores) this.pairsScores = JSON.parse(savedPairsScores);
                    
                    const savedPairsMoney = localStorage.getItem('golfPairsMoney');
                    if (savedPairsMoney) this.pairsMoney = JSON.parse(savedPairsMoney);
                    
                    const savedPairsSettings = localStorage.getItem('golfPairsSettings');
                    if (savedPairsSettings) this.pairsSettings = JSON.parse(savedPairsSettings);
                    
                    // Load the course that pairs were generated for
                    const savedPairsCourse = localStorage.getItem('golfPairsCourseGenerated');
                    if (savedPairsCourse) this.pairsCourseGenerated = savedPairsCourse;
                    
                    // Load comps data
                    const savedComps = localStorage.getItem('golfComps');
                    if (savedComps) {
                        const loadedComps = JSON.parse(savedComps);
                        // Ensure all comp types exist
                        this.comps = {
                            fourBBB: loadedComps.fourBBB || [],
                            fourPersonTeams: loadedComps.fourPersonTeams || [],
                            best3From4: loadedComps.best3From4 || [],
                            mixedScore: loadedComps.mixedScore || [],
                            teamAvsB: loadedComps.teamAvsB || { teamA: [], teamB: [], courseName: '' }
                        };
                    }
                    
                    // Load master leaderboard data
                    const savedMasterLeaderboard = localStorage.getItem('golfMasterLeaderboard');
                    if (savedMasterLeaderboard) this.masterLeaderboardData = JSON.parse(savedMasterLeaderboard);
                    
                    // Load random draw data
                    const savedRandomDrawGroups = localStorage.getItem('golfRandomDrawGroups');
                    if (savedRandomDrawGroups) this.randomDrawGroups = JSON.parse(savedRandomDrawGroups);
                    
                    const savedRandomDrawCourse = localStorage.getItem('golfRandomDrawCourse');
                    if (savedRandomDrawCourse) this.randomDrawCourse = savedRandomDrawCourse;
                    
                    // Load master leaderboard money data
                    const savedMasterMoney = localStorage.getItem('golfMasterLeaderboardMoney');
                    if (savedMasterMoney) this.masterLeaderboardMoney = JSON.parse(savedMasterMoney);
                    
                    const savedMasterCurrency = localStorage.getItem('golfMasterLeaderboardCurrency');
                    if (savedMasterCurrency) this.masterLeaderboardCurrency = savedMasterCurrency;
                    
                    // Load How To content
                    const savedHowTo = localStorage.getItem('golfHowToContent');
                    if (savedHowTo) this.howToContent = savedHowTo;
                    
                    // Load Winnings data (new team-based system)
                    const savedWinnings = localStorage.getItem('golfWinningsData');
                    if (savedWinnings) {
                        const loadedData = JSON.parse(savedWinnings);
                        // Ensure teams array exists (migrate from old players structure if needed)
                        if (loadedData.players && !loadedData.teams) {
                            // Migrate old players structure to teams
                            loadedData.teams = [];
                            delete loadedData.players;
                        }
                        this.winningsData = loadedData;
                    }
                    
                    // Ensure teams array exists
                    if (!this.winningsData.teams) {
                        this.winningsData.teams = [];
                    }
                    
                    // Load Handicap Tracker data
                    const savedHandicapTracker = localStorage.getItem('golfHandicapTracker');
                    if (savedHandicapTracker) {
                        this.handicapTracker = JSON.parse(savedHandicapTracker);
                    }
                    
                } catch (e) {
                    console.error('Error loading data:', e);
                }
            },
            
            saveData() {
                try {
                    localStorage.setItem('golfPlayers', JSON.stringify(this.players));
                    localStorage.setItem('golfCourses', JSON.stringify(this.courses));
                    localStorage.setItem('golfPairs', JSON.stringify(this.pairs));
                    localStorage.setItem('golfScores', JSON.stringify(this.scores));
                    localStorage.setItem('golfActiveTab', this.currentTab);
                    localStorage.setItem('golfScorecardSettings', JSON.stringify(this.scorecardSettings));
                    localStorage.setItem('golfLeaderboardMoney', JSON.stringify(this.leaderboardMoney));
                    localStorage.setItem('golfLeaderboardSettings', JSON.stringify(this.leaderboardSettings));
                    localStorage.setItem('golfPairsScores', JSON.stringify(this.pairsScores));
                    localStorage.setItem('golfPairsMoney', JSON.stringify(this.pairsMoney));
                    localStorage.setItem('golfPairsSettings', JSON.stringify(this.pairsSettings));
                    localStorage.setItem('golfPairsCourseGenerated', this.pairsCourseGenerated);
                    localStorage.setItem('golfComps', JSON.stringify(this.comps));
                    localStorage.setItem('golfMasterLeaderboard', JSON.stringify(this.masterLeaderboardData));
                    localStorage.setItem('golfRandomDrawGroups', JSON.stringify(this.randomDrawGroups));
                    localStorage.setItem('golfRandomDrawCourse', this.randomDrawCourse);
                    localStorage.setItem('golfMasterLeaderboardMoney', JSON.stringify(this.masterLeaderboardMoney));
                    localStorage.setItem('golfMasterLeaderboardCurrency', this.masterLeaderboardCurrency);
                    localStorage.setItem('golfHowToContent', this.howToContent);
                    localStorage.setItem('golfWinningsData', JSON.stringify(this.winningsData));
                    localStorage.setItem('golfHandicapTracker', JSON.stringify(this.handicapTracker));
                } catch (e) {
                    console.error('Error saving data:', e);
                }
            },
            
            setupEventListeners() {
                // Tab switching
                document.querySelectorAll('.tab-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const tabId = e.currentTarget.dataset.tab;
                        this.switchTab(tabId);
                    });
                });
                
                // Add Player
                document.getElementById('addPlayer').addEventListener('click', () => this.showAddPlayerForm());
                // Note: savePlayer button uses onclick assignment in hideAddPlayerForm/editPlayer instead of addEventListener
                // to allow proper switching between savePlayer and updatePlayer functions
                document.getElementById('cancelPlayer').addEventListener('click', () => this.hideAddPlayerForm());
                
                // Prevent form submission on Enter key or button click
                document.getElementById('playerFormElement').addEventListener('submit', (e) => {
                    e.preventDefault();
                    return false;
                });
                document.getElementById('clearPlayers').addEventListener('click', () => {
                    if (confirm('Clear all players?')) {
                        this.players = [];
                        this.scores = {};
                        this.pairs = [];
                        this.leaderboardMoney = {};
                        this.pairsScores = {};
                        this.pairsMoney = {};
                        this.pairsCourseGenerated = '';
                        this.comps = { fourBBB: [], fourPersonTeams: [], best3From4: [] };
                        this.masterLeaderboardData = [];
                        this.saveData();
                        this.renderPlayers();
                        this.renderPairs();
                        this.updateGroupStats();
                        this.showToast('All players cleared', 'warning');
                    }
                });
                
                // Auto-calculate PHC
                document.getElementById('playerHandicapIndex').addEventListener('input', () => this.calculatePHC());
                document.getElementById('playerCourseSelect').addEventListener('change', () => {
                    this.calculatePHC();
                    this.populateGroupDropdown();
                });
                document.getElementById('playerPHCPercentage').addEventListener('change', () => this.calculatePHC());
                
                // Scorecard
                const refreshScorecardBtn = document.getElementById('refreshScorecard');
                if (refreshScorecardBtn) {
                    refreshScorecardBtn.addEventListener('click', () => {
                        this.renderScorecard();
                        this.showToast('Scorecard refreshed', 'success');
                    });
                }
                document.getElementById('scorecardCourseSelect').addEventListener('change', () => {
                    this.saveScorecardSettings();
                    this.renderScorecard();
                });
                document.getElementById('scorecardGroupSelect').addEventListener('change', () => {
                    this.saveScorecardSettings();
                    this.renderScorecard();
                });
                document.getElementById('scorecardSortSelect').addEventListener('change', () => {
                    this.renderScorecard();
                });
                document.getElementById('clearAllScores').addEventListener('click', () => {
                    if (confirm('Clear ALL scores for all players?')) {
                        this.scores = {};
                        this.saveData();
                        this.renderScorecard();
                        this.showToast('All scores cleared', 'warning');
                    }
                });
                document.getElementById('calculateScores').addEventListener('click', () => this.calculateAllScores());
                
                // Add Course
                document.getElementById('addCourse').addEventListener('click', () => this.showAddCourseForm());
                // Note: saveCourse button uses onclick assignment in hideAddCourseForm/editCourse instead of addEventListener
                // to allow proper switching between saveCourse and updateCourse functions
                document.getElementById('cancelCourse').addEventListener('click', () => this.hideAddCourseForm());
                document.getElementById('useDefaultHoles').addEventListener('click', () => this.initializeHoleInputs());
                document.getElementById('clearCourses').addEventListener('click', () => {
                    if (confirm('Clear all courses?')) {
                        this.courses = [];
                        this.scorecardSettings.selectedCourseId = '';
                        this.saveData();
                        this.renderCourses();
                        this.populateScorecardDropdowns();
                        this.populatePairsCourseDropdown();
                        this.showToast('All courses cleared', 'warning');
                    }
                });
                document.getElementById('backupCourses').addEventListener('click', () => this.backupCourses());
                
                // Header buttons
                document.getElementById('backupData').addEventListener('click', () => this.backupData());
                document.getElementById('restoreData').addEventListener('click', () => document.getElementById('restoreFileInput').click());
                document.getElementById('shareWhatsApp').addEventListener('click', () => this.shareWhatsApp());
                document.getElementById('captureImage').addEventListener('click', () => this.captureFullTabData());
                document.getElementById('clearAllData').addEventListener('click', () => {
                    if (confirm('‚ö†Ô∏è Clear ALL data?')) {
                        localStorage.clear();
                        this.players = [];
                        this.courses = [];
                        this.pairs = [];
                        this.scores = {};
                        this.leaderboardMoney = {};
                        this.pairsScores = {};
                        this.pairsMoney = {};
                        this.pairsCourseGenerated = '';
                        this.comps = { fourBBB: [], fourPersonTeams: [], best3From4: [] };
                        this.masterLeaderboardData = [];
                        this.currentTab = 'players';
                        this.scorecardSettings = { selectedCourseId: '', selectedGroupFilter: 'all' };
                        this.leaderboardSettings = { currency: '$', defaultSort: 'totalPoints' };
                        this.pairsSettings = { currency: '$' };
                        this.renderPlayers();
                        this.renderCourses();
                        this.renderPairs();
                        this.renderScorecard();
                        this.updateGroupStats();
                        this.switchTab('players');
                        this.showToast('All data cleared', 'warning');
                    }
                });
                document.getElementById('exportData').addEventListener('click', () => this.exportData());
                document.getElementById('importData').addEventListener('click', () => document.getElementById('importDataFileInput').click());
                
                // File inputs
                document.getElementById('restoreFileInput').addEventListener('change', (e) => this.restoreData(e));
                document.getElementById('importDataFileInput').addEventListener('change', (e) => this.importData(e));
                
                // Modal close
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal')) e.target.style.display = 'none';
                });
                
                // Pairs buttons
                document.getElementById('randomDrawPairs').addEventListener('click', () => this.randomDrawPairs());
                document.getElementById('calculatePairsScores').addEventListener('click', () => this.calculatePairsScores());
                document.getElementById('clearPairsScores').addEventListener('click', () => {
                    if (confirm('Clear all pairs and scores? This will remove the entire draw.')) {
                        this.pairs = [];
                        this.pairsScores = {};
                        this.pairsMoney = {};
                        this.pairsCourseGenerated = '';
                        this.saveData();
                        this.renderPairs();
                        this.showToast('All pairs and scores cleared', 'warning');
                    }
                });
                
                // Track course selection changes for pairs
                document.getElementById('pairsCourseSelect').addEventListener('change', (e) => {
                    const selectedCourse = e.target.value;
                    
                    // Clear pairs if switching to a different course
                    if (selectedCourse !== this.pairsCourseGenerated && this.pairs.length > 0) {
                        if (confirm(`Switching from "${this.pairsCourseGenerated}" to "${selectedCourse}". Clear existing pairs for the old course?`)) {
                            this.pairs = [];
                            this.pairsScores = {};
                            this.pairsMoney = {};
                            this.pairsCourseGenerated = '';
                            this.saveData();
                            this.renderPairs();
                            this.showToast('Pairs cleared for new course selection', 'warning');
                        } else {
                            // Revert to previous selection
                            e.target.value = this.pairsCourseGenerated || '';
                        }
                    }
                });
                
                document.getElementById('savePairsMoney').addEventListener('click', () => {
                    this.savePairsMoneyData();
                    this.showToast('Pairs money data saved', 'success');
                });
                document.getElementById('clearPairsMoney').addEventListener('click', () => {
                    if (confirm('Clear all money values from pairs?')) {
                        this.pairsMoney = {};
                        this.saveData();
                        this.renderPairs();
                        this.showToast('All pairs money values cleared', 'warning');
                    }
                });
                
                // Leaderboard buttons
                const refreshLeaderboardBtn = document.getElementById('refreshLeaderboard');
                if (refreshLeaderboardBtn) {
                    refreshLeaderboardBtn.addEventListener('click', () => {
                        this.renderLeaderboard();
                        this.showToast('Leaderboard refreshed', 'success');
                    });
                }
                document.getElementById('clearAllMoney').addEventListener('click', () => {
                    if (confirm('Clear all money values from leaderboard?')) {
                        this.leaderboardMoney = {};
                        this.saveData();
                        this.renderLeaderboard();
                        this.showToast('All money values cleared', 'warning');
                    }
                });
                document.getElementById('saveMoneyData').addEventListener('click', () => {
                    this.saveMoneyData();
                    this.showToast('Money data saved', 'success');
                });
                
                // Leaderboard settings
                document.getElementById('leaderboardCurrency').addEventListener('change', (e) => {
                    this.leaderboardSettings.currency = e.target.value;
                    this.saveLeaderboardSettings();
                    this.renderLeaderboard();
                });
                document.getElementById('leaderboardSortDefault').addEventListener('change', (e) => {
                    this.leaderboardSettings.defaultSort = e.target.value;
                    this.saveLeaderboardSettings();
                    this.applyDefaultSort();
                    this.renderLeaderboard();
                });
                
                // Master Leaderboard buttons
                document.getElementById('createMasterLeaderboard').addEventListener('click', () => this.createMasterLeaderboard());
                document.getElementById('refreshMasterLeaderboard').addEventListener('click', () => this.refreshMasterLeaderboard());
                document.getElementById('clearMasterLeaderboard').addEventListener('click', () => {
                    if (confirm('Clear Master Leaderboard data?')) {
                        this.masterLeaderboardData = [];
                        this.masterLeaderboardMoney = {};
                        this.saveData();
                        document.getElementById('masterLeaderboardContainer').style.display = 'none';
                        this.showToast('Master Leaderboard cleared', 'warning');
                    }
                });
                document.getElementById('masterLeaderboardCurrency').addEventListener('change', (e) => {
                    this.masterLeaderboardCurrency = e.target.value;
                    this.saveData();
                    this.renderMasterLeaderboard();
                });
                document.getElementById('clearMasterMoney').addEventListener('click', () => {
                    if (confirm('Clear all money values from Master Leaderboard?')) {
                        this.masterLeaderboardMoney = {};
                        this.saveData();
                        this.renderMasterLeaderboard();
                        this.showToast('Master Leaderboard money cleared', 'warning');
                    }
                });
                document.getElementById('saveMasterMoney').addEventListener('click', () => {
                    this.saveMasterMoneyData();
                    this.showToast('Master Leaderboard money saved', 'success');
                });
                
                // Comps buttons
                document.getElementById('create4BBB').addEventListener('click', () => this.showCreateTeamModal('4BBB'));
                document.getElementById('manualCreate4BBB').addEventListener('click', () => this.showManualTeamModal('4BBB'));
                document.getElementById('calculate4BBB').addEventListener('click', () => this.calculate4BBB());
                document.getElementById('create4PersonTeam').addEventListener('click', () => this.showCreateTeamModal('4PersonTeam'));
                document.getElementById('manualCreate4PersonTeam').addEventListener('click', () => this.showManualTeamModal('4PersonTeam'));
                document.getElementById('calculate4PersonTeam').addEventListener('click', () => this.calculate4PersonTeam());
                document.getElementById('createBest3From4').addEventListener('click', () => this.showCreateTeamModal('Best3From4'));
                document.getElementById('manualCreateBest3From4').addEventListener('click', () => this.showManualTeamModal('Best3From4'));
                document.getElementById('calculateBest3From4').addEventListener('click', () => this.calculateBest3From4());
                document.getElementById('createMixedScore').addEventListener('click', () => this.showCreateTeamModal('MixedScore'));
                document.getElementById('manualCreateMixedScore').addEventListener('click', () => this.showManualTeamModal('MixedScore'));
                document.getElementById('calculateMixedScore').addEventListener('click', () => this.calculateMixedScore());
                document.getElementById('createTeamAvsB').addEventListener('click', () => this.showTeamAvsBAutoDraw());
                document.getElementById('manualCreateTeamAvsB').addEventListener('click', () => this.showTeamAvsBManualAdd());
                document.getElementById('calculateTeamAvsB').addEventListener('click', () => this.calculateTeamAvsB());
                const refreshCompsBtn = document.getElementById('refreshComps');
                if (refreshCompsBtn) {
                    refreshCompsBtn.addEventListener('click', () => {
                        this.renderCompsResults();
                        this.showToast('Competitions refreshed', 'success');
                    });
                }
                document.getElementById('editAllComps').addEventListener('click', () => this.showEditAllCompsModal());
                
                // Team modal
                document.getElementById('teamCurrency').addEventListener('change', (e) => {
                    document.getElementById('teamCurrencySymbol').textContent = e.target.value || '';
                });
                document.getElementById('confirmCreateTeam').addEventListener('click', () => this.createTeam());
                document.getElementById('cancelCreateTeam').addEventListener('click', () => this.hideCreateTeamModal());
                
                // Edit Team modal
                document.getElementById('editTeamCurrency').addEventListener('change', (e) => {
                    document.getElementById('editTeamCurrencySymbol').textContent = e.target.value || '';
                });
                document.getElementById('confirmEditTeam').addEventListener('click', () => this.saveEditedTeam());
                document.getElementById('cancelEditTeam').addEventListener('click', () => this.hideEditTeamModal());
                document.getElementById('deleteEditTeam').addEventListener('click', () => this.deleteEditedTeam());
                
                // Edit All Comps modal
                document.getElementById('editAllCurrency').addEventListener('change', (e) => {
                    const currency = e.target.value;
                    // Update all currency symbols in the modal
                    document.querySelectorAll('.edit-all-currency-symbol').forEach(span => {
                        span.textContent = currency || '';
                    });
                });
                document.getElementById('confirmEditAll').addEventListener('click', () => this.saveAllCompsChanges());
                document.getElementById('cancelEditAll').addEventListener('click', () => this.hideEditAllCompsModal());
                
                // Manual Team modal
                document.getElementById('manualTeamCurrency').addEventListener('change', (e) => {
                    document.getElementById('manualTeamCurrencySymbol').textContent = e.target.value || '';
                });
                document.getElementById('manualTeamCourseSelect').addEventListener('change', () => {
                    this.populateManualTeamGroups();
                });
                document.getElementById('confirmManualTeam').addEventListener('click', () => this.confirmManualTeam());
                document.getElementById('cancelManualTeam').addEventListener('click', () => this.hideManualTeamModal());
                
                // Team A vs Team B modal
                document.getElementById('teamAvsBCourseSelect').addEventListener('change', () => this.teamAvsBCourseChanged());
                document.getElementById('teamAvsBAutoDraw').addEventListener('click', () => this.teamAvsBAutoDrawInModal());
                document.getElementById('confirmTeamAvsB').addEventListener('click', () => this.confirmTeamAvsB());
                document.getElementById('cancelTeamAvsB').addEventListener('click', () => this.hideTeamAvsBModal());
                
                // Random Draw buttons
                document.getElementById('generateRandomDraw').addEventListener('click', () => this.generateRandomDraw());
                document.getElementById('clearRandomDraw').addEventListener('click', () => {
                    if (confirm('Clear the current random draw?')) {
                        this.randomDrawGroups = [];
                        this.randomDrawCourse = '';
                        this.saveData();
                        this.renderRandomDraw();
                        this.showToast('Random draw cleared', 'warning');
                    }
                });
                
                // How To modal button
                document.getElementById('showHowTo').addEventListener('click', () => this.showHowToModal());
                document.getElementById('closeHowTo').addEventListener('click', () => this.hideHowToModal());
                
                // Winnings Tracker buttons
                document.getElementById('addPlayerWinning').addEventListener('click', () => this.addPlayerWinning());
                document.getElementById('addTeamWinning').addEventListener('click', () => this.addTeamWinning());
                document.getElementById('clearAllWinnings').addEventListener('click', () => {
                    if (confirm('Clear all winnings data?')) {
                        this.winningsData.teams = [];
                        this.renderWinnings();
                        this.updateRemainingMoney();
                        this.saveData();
                        this.showToast('All winnings cleared', 'warning');
                    }
                });
                document.getElementById('infoTableCurrency').addEventListener('change', (e) => {
                    this.winningsData.currency = e.target.value;
                    document.getElementById('grandPotCurrency').textContent = e.target.value;
                    this.renderWinnings();
                    this.saveData();
                });
                
                // Grand Pot Money
                document.getElementById('updateGrandPot').addEventListener('click', () => {
                    const value = parseFloat(document.getElementById('grandPotMoney').value) || 0;
                    this.winningsData.grandPotMoney = value;
                    this.updateRemainingMoney();
                    this.saveData();
                    this.showToast('Grand Pot updated', 'success');
                });
                
                document.getElementById('grandPotMoney').addEventListener('change', () => {
                    const value = parseFloat(document.getElementById('grandPotMoney').value) || 0;
                    this.winningsData.grandPotMoney = value;
                    this.updateRemainingMoney();
                });
                
                // Handicap Tracker buttons
                document.getElementById('addHandicapPlayer').addEventListener('click', () => this.addHandicapPlayer());
                document.getElementById('clearHandicapTracker').addEventListener('click', () => {
                    if (confirm('Clear all handicap tracker data?')) {
                        this.handicapTracker.players = [];
                        this.renderHandicapTracker();
                        this.saveData();
                        this.showToast('Handicap tracker cleared', 'warning');
                    }
                });
                
                // Capture buttons for Information tab
                document.getElementById('captureWinnings').addEventListener('click', () => this.captureWinningsTracker());
                document.getElementById('captureHandicapTracker').addEventListener('click', () => this.captureHandicapTracker());
                
                window.addEventListener('beforeunload', () => this.saveData());
            },
            
            setupTabs() {
                // Initial tab setup
            },
            
            restoreActiveTab() {
                if (this.currentTab) {
                    this.switchTab(this.currentTab);
                } else {
                    this.switchTab('players');
                }
            },
            
            restoreLeaderboardSettings() {
                const currencySelect = document.getElementById('leaderboardCurrency');
                const sortSelect = document.getElementById('leaderboardSortDefault');
                
                if (currencySelect && this.leaderboardSettings.currency) {
                    currencySelect.value = this.leaderboardSettings.currency;
                }
                
                if (sortSelect && this.leaderboardSettings.defaultSort) {
                    sortSelect.value = this.leaderboardSettings.defaultSort;
                }
            },
            
            restorePairsSettings() {
                // Pairs settings restoration
            },
            
            saveLeaderboardSettings() {
                localStorage.setItem('golfLeaderboardSettings', JSON.stringify(this.leaderboardSettings));
            },
            
            savePairsSettings() {
                localStorage.setItem('golfPairsSettings', JSON.stringify(this.pairsSettings));
            },
            
            switchTab(tabId) {
                this.currentTab = tabId;
                
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                const tabButton = document.querySelector(`[data-tab="${tabId}"]`);
                const tabContent = document.getElementById(`${tabId}-tab`);
                
                if (tabButton) tabButton.classList.add('active');
                if (tabContent) tabContent.classList.add('active');
                
                if (tabId === 'scorecard') {
                    setTimeout(() => this.renderScorecard(), 100);
                } else if (tabId === 'leaderboard') {
                    setTimeout(() => {
                        this.applyDefaultSort();
                        this.renderLeaderboard();
                        this.renderMasterLeaderboard();
                    }, 100);
                } else if (tabId === 'pairs') {
                    setTimeout(() => {
                        this.populatePairsCourseDropdown();
                        this.renderPairs();
                    }, 100);
                } else if (tabId === 'comps') {
                    setTimeout(() => {
                        this.renderCompsResults();
                    }, 100);
                } else if (tabId === 'randomdraw') {
                    setTimeout(() => {
                        this.populateRandomDrawCourseDropdown();
                        this.renderRandomDraw();
                    }, 100);
                } else if (tabId === 'information') {
                    setTimeout(() => {
                        this.renderWinnings();
                        this.renderHandicapTracker();
                    }, 100);
                }
                
                this.saveData();
            },
            
            calculatePHC() {
                const handicapIndex = parseFloat(document.getElementById('playerHandicapIndex').value) || 0;
                const playerPHCPercentage = document.getElementById('playerPHCPercentage').value;
                const selectedCourseName = document.getElementById('playerCourseSelect').value;
                
                if (isNaN(handicapIndex) || !selectedCourseName) {
                    document.getElementById('playerPHC').value = 0;
                    return;
                }
                
                // Find the selected course to get rating, slope, and par
                const course = this.courses.find(c => c.name === selectedCourseName);
                if (!course) {
                    document.getElementById('playerPHC').value = 0;
                    return;
                }
                
                const rating = parseFloat(course.rating) || 72;
                const slope = parseFloat(course.slope) || 113;
                const par = parseFloat(course.par) || 72;
                
                // Step 1: Calculate Course Handicap (Playing Handicap)
                const courseHandicap = handicapIndex * (slope / 113) + (rating - par);
                
                // Step 2: Round the Playing Handicap
                const roundedPlayingHandicap = Math.round(courseHandicap);
                
                // Step 3: Apply PHC percentage to the rounded Playing Handicap (if specified)
                let finalPHC;
                if (playerPHCPercentage && playerPHCPercentage !== '') {
                    const phcPercentage = parseInt(playerPHCPercentage) / 100;
                    // Round DOWN when percentage < 100%
                    if (phcPercentage < 1) {
                        finalPHC = Math.floor(roundedPlayingHandicap * phcPercentage);
                    } else {
                        finalPHC = Math.round(roundedPlayingHandicap * phcPercentage);
                    }
                } else {
                    // If no PHC % selected, use the full rounded Playing Handicap
                    finalPHC = roundedPlayingHandicap;
                }
                
                document.getElementById('playerPHC').value = finalPHC;
            },
            
            showAddPlayerForm() {
                this.populateCourseDropdown();
                this.populateGroupDropdown();
                
                document.getElementById('playerName').value = '';
                document.getElementById('playerHandicapIndex').value = '';
                document.getElementById('playerPHC').value = '';
                document.getElementById('playerCourseSelect').value = '';
                document.getElementById('playerGroupSelect').value = '';
                document.getElementById('playerPHCPercentage').value = '';
                
                // Reset button to add mode
                document.querySelector('#addPlayerForm h3').textContent = 'Add New Player';
                const saveBtn = document.getElementById('savePlayer');
                saveBtn.textContent = 'üíæ Save Player';
                saveBtn.onclick = () => this.savePlayer();
                
                document.getElementById('addPlayerForm').style.display = 'flex';
            },
            
            hideAddPlayerForm() {
                document.getElementById('addPlayerForm').style.display = 'none';
                document.querySelector('#addPlayerForm h3').textContent = 'Add New Player';
                const saveBtn = document.getElementById('savePlayer');
                saveBtn.textContent = 'üíæ Save Player';
                saveBtn.onclick = () => this.savePlayer();
            },
            
            showHowToModal() {
                document.getElementById('howToModal').style.display = 'flex';
            },
            
            hideHowToModal() {
                document.getElementById('howToModal').style.display = 'none';
            },
            
            // NEW CARD-BASED WINNINGS FUNCTIONS
            renderWinnings() {
                const container = document.getElementById('winningsContainer');
                if (!container) return;
                
                // Update currency displays
                const currencySelect = document.getElementById('infoTableCurrency');
                if (currencySelect) {
                    currencySelect.value = this.winningsData.currency;
                }
                
                const grandPotCurrency = document.getElementById('grandPotCurrency');
                if (grandPotCurrency) {
                    grandPotCurrency.textContent = this.winningsData.currency;
                }
                
                const grandPotInput = document.getElementById('grandPotMoney');
                if (grandPotInput) {
                    grandPotInput.value = this.winningsData.grandPotMoney || 0;
                }
                
                this.updateRemainingMoney();
                
                // Render cards - group by team winnings
                if (!this.winningsData.teams || this.winningsData.teams.length === 0) {
                    container.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 40px; background: #f8f9fa; border-radius: 8px; border: 2px dashed #ddd;">
                            <div style="font-size: 48px; margin-bottom: 10px;">üèÜ</div>
                            <h3 style="color: #7f8c8d; margin-bottom: 8px;">No Winnings Yet</h3>
                            <p style="color: #95a5a6; font-size: 14px;">Click "‚ûï Add Player" for individual winners or "üë• Add Team Winning" for team events</p>
                        </div>
                    `;
                    return;
                }
                
                const currency = this.winningsData.currency;
                
                container.innerHTML = this.winningsData.teams.map((team, teamIdx) => {
                    const totalPrize = team.totalAmount;
                    const shareAmount = team.totalAmount / team.players.length;
                    const isIndividual = team.players.length === 1;
                    
                    if (isIndividual) {
                        // Individual player card
                        return `
                            <div style="background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.08); border: 1px solid #e0e0e0; transition: all 0.2s;" onmouseover="this.style.boxShadow='0 4px 8px rgba(0,0,0,0.12)'" onmouseout="this.style.boxShadow='0 2px 4px rgba(0,0,0,0.08)'">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0;">
                                    <div>
                                        <div style="font-weight: bold; font-size: 16px; color: #2c3e50;">üë§ ${team.players[0]}</div>
                                        <div style="font-size: 12px; color: #7f8c8d; margin-top: 2px;">
                                            ${team.comp} <span style="padding: 2px 6px; background: #3498db; color: white; border-radius: 3px; font-size: 10px; margin-left: 4px;">${team.position}</span>
                                        </div>
                                    </div>
                                    <div style="font-size: 20px; font-weight: bold; color: #27ae60;">${currency}${totalPrize.toFixed(2)}</div>
                                </div>
                                <button onclick="window.app.deleteTeam(${teamIdx})" style="width: 100%; padding: 6px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">üóëÔ∏è Delete</button>
                            </div>
                        `;
                    } else {
                        // Team card
                        return `
                            <div style="background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.08); border: 1px solid #e0e0e0; transition: all 0.2s;" onmouseover="this.style.boxShadow='0 4px 8px rgba(0,0,0,0.12)'" onmouseout="this.style.boxShadow='0 2px 4px rgba(0,0,0,0.08)'">
                                <!-- Team Header -->
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0;">
                                    <div>
                                        <div style="font-weight: bold; font-size: 16px; color: #2c3e50;">üë• ${team.comp}</div>
                                        <div style="font-size: 11px; color: #7f8c8d; margin-top: 2px;">
                                            <span style="padding: 2px 6px; background: #3498db; color: white; border-radius: 3px; font-size: 10px; margin-right: 4px;">${team.position}</span>
                                            ${team.players.length} Players
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 20px; font-weight: bold; color: #27ae60;">${currency}${totalPrize.toFixed(2)}</div>
                                        <div style="font-size: 10px; color: #7f8c8d;">Total Prize</div>
                                    </div>
                                </div>
                                
                                <!-- Team Members -->
                                <div style="display: flex; flex-direction: column; gap: 6px; margin-bottom: 10px;">
                                    ${team.players.map((playerName, idx) => `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; background: #f8f9fa; border-radius: 4px; font-size: 12px;">
                                            <div style="font-weight: 600; color: #34495e;">üë§ ${playerName}</div>
                                            <div style="font-weight: bold; color: #2c3e50;">${currency}${shareAmount.toFixed(2)}</div>
                                        </div>
                                    `).join('')}
                                </div>
                                
                                <!-- Delete Team Button -->
                                <button onclick="window.app.deleteTeam(${teamIdx})" style="width: 100%; padding: 6px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">üóëÔ∏è Delete Team</button>
                            </div>
                        `;
                    }
                }).join('');
            },
            
            addPlayerWinning() {
                // Add individual player winning
                const playerName = prompt('Enter player name:');
                if (!playerName || !playerName.trim()) return;
                
                const comp = prompt('Competition name:');
                if (!comp || !comp.trim()) return;
                
                const position = prompt('Position (1st, 2nd, 3rd, etc.):');
                if (!position || !position.trim()) return;
                
                const amountStr = prompt('Prize money:');
                const amount = parseFloat(amountStr) || 0;
                if (amount <= 0) {
                    this.showToast('Prize amount must be greater than 0', 'warning');
                    return;
                }
                
                // Create a single-player "team" entry
                this.winningsData.teams.push({
                    comp: comp.trim(),
                    position: position.trim(),
                    players: [playerName.trim()],
                    totalAmount: amount
                });
                
                this.renderWinnings();
                this.updateRemainingMoney();
                this.saveData();
                this.showToast(`Individual winning added for ${playerName.trim()}`, 'success');
            },
            
            addTeamWinning() {
                // Step 1: Competition name
                const comp = prompt('Competition name (e.g., Pairs, 4BBB, 4 Person Team):');
                if (!comp || !comp.trim()) return;
                
                // Step 2: Team size
                const teamSizeStr = prompt('How many players in the team? (2, 3, or 4):');
                const teamSize = parseInt(teamSizeStr) || 2;
                if (teamSize < 2 || teamSize > 4) {
                    this.showToast('Team size must be 2-4 players', 'warning');
                    return;
                }
                
                // Step 3: Collect all team member names
                const players = [];
                for (let i = 1; i <= teamSize; i++) {
                    const name = prompt(`Enter player ${i} name:`);
                    if (!name || !name.trim()) {
                        this.showToast('All team member names required', 'warning');
                        return;
                    }
                    players.push(name.trim());
                }
                
                // Step 4: Position
                const position = prompt('Team position (1st, 2nd, 3rd, etc.):');
                if (!position || !position.trim()) return;
                
                // Step 5: Total prize money
                const amountStr = prompt('Total prize money for the team:');
                const totalAmount = parseFloat(amountStr) || 0;
                if (totalAmount <= 0) {
                    this.showToast('Prize amount must be greater than 0', 'warning');
                    return;
                }
                
                // Create team winning entry
                this.winningsData.teams.push({
                    comp: comp.trim(),
                    position: position.trim(),
                    players: players,
                    totalAmount: totalAmount
                });
                
                this.renderWinnings();
                this.updateRemainingMoney();
                this.saveData();
                this.showToast(`Team winning added: ${players.join(', ')}`, 'success');
            },
            
            deleteTeam(teamIndex) {
                if (!confirm('Delete this team winning?')) return;
                
                this.winningsData.teams.splice(teamIndex, 1);
                
                this.renderWinnings();
                this.updateRemainingMoney();
                this.saveData();
                this.showToast('Team winning deleted', 'warning');
            },
            
            updateRemainingMoney() {
                const grandPot = parseFloat(this.winningsData.grandPotMoney) || 0;
                const totalAwarded = this.winningsData.teams.reduce((sum, team) => sum + (team.totalAmount || 0), 0);
                const remaining = grandPot - totalAwarded;
                
                const remainingSpan = document.getElementById('remainingPotMoney');
                if (remainingSpan) {
                    remainingSpan.textContent = `${this.winningsData.currency}${remaining.toFixed(2)}`;
                    remainingSpan.style.color = remaining >= 0 ? '#2ecc71' : '#e74c3c';
                }
            },
            
            // HANDICAP TRACKER FUNCTIONS
            renderHandicapTracker() {
                const container = document.getElementById('handicapTrackerContainer');
                if (!container) return;
                
                const { headers, dayLabels, afterLabels, players } = this.handicapTracker;
                
                if (players.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 8px; border: 2px dashed #ddd;">
                            <div style="font-size: 48px; margin-bottom: 10px;">üìä</div>
                            <h3 style="color: #7f8c8d; margin-bottom: 8px;">No Players Added</h3>
                            <p style="color: #95a5a6; font-size: 14px;">Click "‚ûï Add Player" to start tracking handicaps</p>
                        </div>
                    `;
                    return;
                }
                
                let html = `
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px; background: white;">
                        <thead>
                            <tr style="background: #2c3e50; color: white;">
                                <th rowspan="2" style="padding: 8px; border: 1px solid #34495e; min-width: 120px; position: sticky; left: 0; background: #2c3e50; z-index: 2;">Player</th>
                `;
                
                // Day headers (spanning 3 columns each)
                for (let d = 0; d < 5; d++) {
                    html += `
                        <th colspan="3" style="padding: 8px; border: 1px solid #34495e; text-align: center; background: ${d % 2 === 0 ? '#3498db' : '#2980b9'};">
                            <input type="text" value="${dayLabels[d]}" 
                                   data-day="${d}" data-type="dayLabel"
                                   style="background: transparent; border: none; color: white; text-align: center; font-weight: bold; width: 80px;"
                                   onchange="window.app.updateHandicapHeader(this)">
                        </th>
                    `;
                }
                html += `</tr><tr style="background: #34495e; color: white;">`;
                
                // Sub-headers for each day
                for (let d = 0; d < 5; d++) {
                    html += `
                        <th style="padding: 6px; border: 1px solid #4a6278; min-width: 70px;">
                            <input type="text" value="${headers.col1}" 
                                   data-col="col1" data-type="header"
                                   style="background: transparent; border: none; color: white; text-align: center; font-size: 10px; width: 60px;"
                                   onchange="window.app.updateHandicapHeader(this)">
                        </th>
                        <th style="padding: 6px; border: 1px solid #4a6278; min-width: 70px;">
                            <input type="text" value="${headers.col2}" 
                                   data-col="col2" data-type="header"
                                   style="background: transparent; border: none; color: white; text-align: center; font-size: 10px; width: 60px;"
                                   onchange="window.app.updateHandicapHeader(this)">
                        </th>
                        <th style="padding: 6px; border: 1px solid #4a6278; min-width: 70px;">
                            <input type="text" value="${headers.col3}" 
                                   data-col="col3" data-type="header"
                                   style="background: transparent; border: none; color: white; text-align: center; font-size: 10px; width: 60px;"
                                   onchange="window.app.updateHandicapHeader(this)">
                        </th>
                    `;
                }
                html += `</tr>`;
                
                // After Day labels row
                html += `<tr style="background: #ecf0f1;">
                    <th style="padding: 6px; border: 1px solid #bdc3c7; font-weight: normal; font-style: italic; position: sticky; left: 0; background: #ecf0f1; z-index: 1;"></th>`;
                for (let d = 0; d < 5; d++) {
                    html += `
                        <th colspan="3" style="padding: 4px; border: 1px solid #bdc3c7; text-align: center; font-weight: normal; font-style: italic; font-size: 10px; color: #7f8c8d;">
                            <input type="text" value="${afterLabels[d]}" 
                                   data-day="${d}" data-type="afterLabel"
                                   style="background: transparent; border: none; text-align: center; font-style: italic; font-size: 10px; color: #7f8c8d; width: 80px;"
                                   onchange="window.app.updateHandicapHeader(this)">
                        </th>
                    `;
                }
                html += `</tr></thead><tbody>`;
                
                // Player rows
                players.forEach((player, playerIdx) => {
                    html += `<tr style="${playerIdx % 2 === 0 ? 'background: #fff;' : 'background: #f8f9fa;'}">`;
                    
                    // Player name cell with delete button
                    html += `
                        <td style="padding: 6px; border: 1px solid #e0e0e0; position: sticky; left: 0; ${playerIdx % 2 === 0 ? 'background: #fff;' : 'background: #f8f9fa;'} z-index: 1;">
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <input type="text" value="${player.name}" 
                                       data-player="${playerIdx}" data-field="name"
                                       style="flex: 1; padding: 4px; border: 1px solid #ddd; border-radius: 3px; font-size: 11px;"
                                       onchange="window.app.updateHandicapPlayerName(this)">
                                <button onclick="window.app.deleteHandicapPlayer(${playerIdx})" 
                                        style="background: #e74c3c; color: white; border: none; border-radius: 3px; padding: 2px 6px; cursor: pointer; font-size: 10px;"
                                        title="Delete player">‚úï</button>
                            </div>
                        </td>
                    `;
                    
                    // Day data cells
                    for (let d = 0; d < 5; d++) {
                        const dayData = player.days[d] || { startHcp: '', cutApplied: '', newHcp: '' };
                        html += `
                            <td style="padding: 4px; border: 1px solid #e0e0e0; text-align: center;">
                                <input type="text" value="${dayData.startHcp}" 
                                       data-player="${playerIdx}" data-day="${d}" data-field="startHcp"
                                       style="width: 50px; padding: 3px; border: 1px solid #ddd; border-radius: 3px; text-align: center; font-size: 11px;"
                                       onchange="window.app.updateHandicapValue(this)">
                            </td>
                            <td style="padding: 4px; border: 1px solid #e0e0e0; text-align: center;">
                                <input type="text" value="${dayData.cutApplied}" 
                                       data-player="${playerIdx}" data-day="${d}" data-field="cutApplied"
                                       style="width: 50px; padding: 3px; border: 1px solid #ddd; border-radius: 3px; text-align: center; font-size: 11px;"
                                       onchange="window.app.updateHandicapValue(this)">
                            </td>
                            <td style="padding: 4px; border: 1px solid #e0e0e0; text-align: center; background: ${d % 2 === 0 ? '#e8f6f3' : '#ebf5fb'};">
                                <input type="text" value="${dayData.newHcp}" 
                                       data-player="${playerIdx}" data-day="${d}" data-field="newHcp"
                                       style="width: 50px; padding: 3px; border: 1px solid #27ae60; border-radius: 3px; text-align: center; font-size: 11px; font-weight: bold;"
                                       onchange="window.app.updateHandicapValue(this)">
                            </td>
                        `;
                    }
                    
                    html += `</tr>`;
                });
                
                html += `</tbody></table>`;
                container.innerHTML = html;
            },
            
            addHandicapPlayer() {
                const playerName = prompt('Enter player name:');
                if (!playerName || !playerName.trim()) return;
                
                // Create new player with 5 empty days
                const newPlayer = {
                    name: playerName.trim(),
                    days: [
                        { startHcp: '', cutApplied: '', newHcp: '' },
                        { startHcp: '', cutApplied: '', newHcp: '' },
                        { startHcp: '', cutApplied: '', newHcp: '' },
                        { startHcp: '', cutApplied: '', newHcp: '' },
                        { startHcp: '', cutApplied: '', newHcp: '' }
                    ]
                };
                
                this.handicapTracker.players.push(newPlayer);
                this.renderHandicapTracker();
                this.saveData();
                this.showToast(`Player "${playerName.trim()}" added to handicap tracker`, 'success');
            },
            
            deleteHandicapPlayer(playerIdx) {
                if (!confirm('Delete this player from handicap tracker?')) return;
                
                this.handicapTracker.players.splice(playerIdx, 1);
                this.renderHandicapTracker();
                this.saveData();
                this.showToast('Player removed from handicap tracker', 'warning');
            },
            
            updateHandicapHeader(input) {
                const type = input.dataset.type;
                
                if (type === 'header') {
                    const col = input.dataset.col;
                    this.handicapTracker.headers[col] = input.value;
                } else if (type === 'dayLabel') {
                    const day = parseInt(input.dataset.day);
                    this.handicapTracker.dayLabels[day] = input.value;
                } else if (type === 'afterLabel') {
                    const day = parseInt(input.dataset.day);
                    this.handicapTracker.afterLabels[day] = input.value;
                }
                
                this.saveData();
            },
            
            updateHandicapPlayerName(input) {
                const playerIdx = parseInt(input.dataset.player);
                this.handicapTracker.players[playerIdx].name = input.value;
                this.saveData();
            },
            
            updateHandicapValue(input) {
                const playerIdx = parseInt(input.dataset.player);
                const dayIdx = parseInt(input.dataset.day);
                const field = input.dataset.field;
                
                if (!this.handicapTracker.players[playerIdx].days[dayIdx]) {
                    this.handicapTracker.players[playerIdx].days[dayIdx] = { startHcp: '', cutApplied: '', newHcp: '' };
                }
                
                this.handicapTracker.players[playerIdx].days[dayIdx][field] = input.value;
                this.saveData();
            },
            
            // CAPTURE FUNCTIONS FOR INFORMATION TAB
            captureWinningsTracker() {
                const captureArea = document.querySelector('.information-section');
                if (!captureArea) {
                    this.showToast('Nothing to capture', 'warning');
                    return;
                }
                
                this.showToast('Capturing Winnings Tracker...', 'info');
                
                // Store original styles
                const originalOverflow = captureArea.style.overflow;
                const originalWidth = captureArea.style.width;
                const originalMaxWidth = captureArea.style.maxWidth;
                
                // Temporarily expand to show full content
                captureArea.style.overflow = 'visible';
                captureArea.style.width = 'auto';
                captureArea.style.maxWidth = 'none';
                
                html2canvas(captureArea, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    scrollX: 0,
                    scrollY: 0,
                    windowWidth: captureArea.scrollWidth,
                    windowHeight: captureArea.scrollHeight
                }).then(canvas => {
                    // Restore original styles
                    captureArea.style.overflow = originalOverflow;
                    captureArea.style.width = originalWidth;
                    captureArea.style.maxWidth = originalMaxWidth;
                    
                    // Create download link
                    const link = document.createElement('a');
                    const timestamp = new Date().toISOString().slice(0, 10);
                    link.download = `Winnings-Tracker-${timestamp}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    
                    this.showToast('Winnings Tracker captured!', 'success');
                }).catch(err => {
                    // Restore original styles on error
                    captureArea.style.overflow = originalOverflow;
                    captureArea.style.width = originalWidth;
                    captureArea.style.maxWidth = originalMaxWidth;
                    
                    console.error('Capture error:', err);
                    this.showToast('Failed to capture', 'error');
                });
            },
            
            captureHandicapTracker() {
                const captureArea = document.querySelector('.handicap-tracker-section');
                if (!captureArea) {
                    this.showToast('Nothing to capture', 'warning');
                    return;
                }
                
                this.showToast('Capturing Handicap Tracker...', 'info');
                
                // Store original styles for the section and container
                const container = document.getElementById('handicapTrackerContainer');
                const originalSectionOverflow = captureArea.style.overflow;
                const originalSectionWidth = captureArea.style.width;
                const originalContainerOverflow = container ? container.style.overflow : '';
                const originalContainerWidth = container ? container.style.width : '';
                
                // Temporarily expand to show full content (including horizontal scroll)
                captureArea.style.overflow = 'visible';
                captureArea.style.width = 'auto';
                if (container) {
                    container.style.overflow = 'visible';
                    container.style.width = 'auto';
                }
                
                // Get the table inside for accurate width
                const table = container ? container.querySelector('table') : null;
                const captureWidth = table ? Math.max(captureArea.scrollWidth, table.scrollWidth + 40) : captureArea.scrollWidth;
                
                html2canvas(captureArea, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    scrollX: 0,
                    scrollY: 0,
                    windowWidth: captureWidth,
                    windowHeight: captureArea.scrollHeight,
                    width: captureWidth,
                    height: captureArea.scrollHeight
                }).then(canvas => {
                    // Restore original styles
                    captureArea.style.overflow = originalSectionOverflow;
                    captureArea.style.width = originalSectionWidth;
                    if (container) {
                        container.style.overflow = originalContainerOverflow;
                        container.style.width = originalContainerWidth;
                    }
                    
                    // Create download link
                    const link = document.createElement('a');
                    const timestamp = new Date().toISOString().slice(0, 10);
                    link.download = `Handicap-Tracker-${timestamp}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    
                    this.showToast('Handicap Tracker captured!', 'success');
                }).catch(err => {
                    // Restore original styles on error
                    captureArea.style.overflow = originalSectionOverflow;
                    captureArea.style.width = originalSectionWidth;
                    if (container) {
                        container.style.overflow = originalContainerOverflow;
                        container.style.width = originalContainerWidth;
                    }
                    
                    console.error('Capture error:', err);
                    this.showToast('Failed to capture', 'error');
                });
            },
            
            // OLD INFO TABLE FUNCTIONS
            renderInfoTable() {
                const headerRow = document.getElementById('infoTableHeader');
                const tbody = document.getElementById('infoTableBody');
                
                // Clear existing content
                headerRow.innerHTML = '';
                tbody.innerHTML = '';
                
                // Restore currency selector value
                const currencySelect = document.getElementById('infoTableCurrency');
                if (currencySelect) {
                    currencySelect.value = this.infoTableData.currency || '$';
                }
                
                // Restore grand pot money
                const grandPotInput = document.getElementById('grandPotMoney');
                if (grandPotInput) {
                    grandPotInput.value = this.infoTableData.grandPotMoney || 0;
                }
                const grandPotCurrency = document.getElementById('grandPotCurrency');
                if (grandPotCurrency) {
                    grandPotCurrency.textContent = this.infoTableData.currency || '$';
                }
                
                // Update remaining pot money
                this.updateRemainingPotMoney();
                
                // Render headers with delete buttons
                this.infoTableData.headers.forEach((header, index) => {
                    const th = document.createElement('th');
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = header;
                    input.addEventListener('change', (e) => {
                        this.infoTableData.headers[index] = e.target.value;
                    });
                    th.appendChild(input);
                    
                    // Add delete button for columns (except first two)
                    if (index >= 2) {
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'delete-col-btn';
                        deleteBtn.textContent = '√ó';
                        deleteBtn.title = 'Delete column';
                        deleteBtn.addEventListener('click', () => this.deleteInfoTableColumn(index));
                        th.appendChild(deleteBtn);
                    }
                    
                    headerRow.appendChild(th);
                });
                
                // Render rows
                this.infoTableData.rows.forEach((row, rowIndex) => {
                    const tr = document.createElement('tr');
                    
                    row.forEach((cell, cellIndex) => {
                        const td = document.createElement('td');
                        
                        // Players Name column (index 0) - text input only
                        if (cellIndex === 0) {
                            const input = document.createElement('input');
                            input.type = 'text';
                            input.value = cell || '';
                            input.addEventListener('change', (e) => {
                                this.infoTableData.rows[rowIndex][cellIndex] = e.target.value;
                            });
                            td.appendChild(input);
                        }
                        // Winners Position column (index 1) - Display auto-calculated total
                        else if (cellIndex === 1) {
                            td.style.padding = '6px';
                            td.style.textAlign = 'center';
                            td.style.background = '#fff3cd';
                            td.style.fontWeight = 'bold';
                            td.style.fontSize = '12px';
                            
                            // Calculate total from all other columns (index 2+)
                            let total = 0;
                            for (let i = 2; i < row.length; i++) {
                                const otherCell = row[i];
                                if (otherCell && otherCell.includes(' - ')) {
                                    const parts = otherCell.split(' - ');
                                    if (parts[1]) {
                                        const value = parseFloat(parts[1].replace(/[^0-9.]/g, ''));
                                        if (!isNaN(value)) {
                                            total += value;
                                        }
                                    }
                                }
                            }
                            
                            const currency = this.infoTableData.currency || '$';
                            const totalSpan = document.createElement('span');
                            totalSpan.id = `winner-total-${rowIndex}`;
                            totalSpan.textContent = `${currency}${total.toFixed(2)}`;
                            totalSpan.style.color = '#2c3e50';
                            
                            // Store the total in the cell data
                            this.infoTableData.rows[rowIndex][cellIndex] = `Total - ${currency}${total.toFixed(2)}`;
                            
                            td.appendChild(totalSpan);
                        }
                        // All other columns (index 2+) - position dropdown + value input
                        else if (cellIndex >= 2) {
                            td.style.padding = '4px';
                            const container = document.createElement('div');
                            container.style.display = 'flex';
                            container.style.gap = '4px';
                            container.style.alignItems = 'center';
                            
                            // Parse existing value (format: "1st - $100" or just "1st")
                            let position = '';
                            let value = '';
                            if (cell) {
                                const parts = cell.split(' - ');
                                position = parts[0] || '';
                                if (parts[1]) {
                                    value = parts[1].replace(/[^0-9.]/g, ''); // Remove currency symbols
                                }
                            }
                            
                            // Position dropdown
                            const posSelect = document.createElement('select');
                            posSelect.style.flex = '0 0 60px';
                            posSelect.style.padding = '4px';
                            posSelect.style.fontSize = '11px';
                            posSelect.style.border = '1px solid #ddd';
                            posSelect.style.borderRadius = '2px';
                            
                            const positions = [
                                { value: '', label: '---', symbol: '' },
                                { value: '1st', label: '1st', symbol: 'üèÜ' },
                                { value: '2nd', label: '2nd', symbol: 'ü•à' },
                                { value: '3rd', label: '3rd', symbol: 'ü•â' },
                                { value: '4th', label: '4th', symbol: 'üèÖ' },
                                { value: '5th', label: '5th', symbol: 'üéñÔ∏è' },
                                { value: '6th', label: '6th', symbol: '‚≠ê' },
                                { value: '7th', label: '7th', symbol: '‚≠ê' },
                                { value: '8th', label: '8th', symbol: '‚≠ê' },
                                { value: '9th', label: '9th', symbol: '‚≠ê' },
                                { value: '10th', label: '10th', symbol: '‚≠ê' }
                            ];
                            positions.forEach(pos => {
                                const option = document.createElement('option');
                                option.value = pos.value;
                                option.textContent = pos.symbol ? `${pos.symbol} ${pos.label}` : pos.label;
                                if (pos.value === position) option.selected = true;
                                posSelect.appendChild(option);
                            });
                            
                            // Currency symbol display
                            const currencySymbol = document.createElement('span');
                            currencySymbol.textContent = this.infoTableData.currency || '$';
                            currencySymbol.style.fontSize = '11px';
                            currencySymbol.style.fontWeight = 'bold';
                            currencySymbol.style.color = '#2c3e50';
                            currencySymbol.style.padding = '0 2px';
                            
                            // Value input
                            const valueInput = document.createElement('input');
                            valueInput.type = 'text';
                            valueInput.placeholder = '0.00';
                            valueInput.value = value;
                            valueInput.style.width = '60px';
                            valueInput.style.padding = '4px';
                            valueInput.style.fontSize = '11px';
                            valueInput.style.border = '1px solid #ddd';
                            valueInput.style.borderRadius = '2px';
                            valueInput.style.textAlign = 'right';
                            valueInput.style.paddingRight = '6px';
                            
                            // Update function
                            const updateCell = () => {
                                const pos = posSelect.value;
                                const val = valueInput.value.trim();
                                const currency = this.infoTableData.currency || '';
                                
                                if (val) {
                                    // Value exists - store with or without position
                                    if (pos) {
                                        this.infoTableData.rows[rowIndex][cellIndex] = `${pos} - ${currency}${val}`;
                                        console.log(`Updated row ${rowIndex}, col ${cellIndex}:`, `${pos} - ${currency}${val}`);
                                    } else {
                                        // No position selected, just save value with default position
                                        this.infoTableData.rows[rowIndex][cellIndex] = `--- - ${currency}${val}`;
                                        console.log(`Updated row ${rowIndex}, col ${cellIndex} (no position):`, `--- - ${currency}${val}`);
                                    }
                                } else if (pos) {
                                    this.infoTableData.rows[rowIndex][cellIndex] = pos;
                                } else {
                                    this.infoTableData.rows[rowIndex][cellIndex] = '';
                                }
                            };
                            
                            posSelect.addEventListener('change', () => {
                                updateCell();
                                this.updateWinnersPositionTotals();
                                this.updateRemainingPotMoney();
                                this.saveData();
                            });
                            
                            valueInput.addEventListener('blur', () => {
                                updateCell();
                                this.updateWinnersPositionTotals();
                                this.updateRemainingPotMoney();
                                this.saveData();
                            });
                            
                            valueInput.addEventListener('keypress', (e) => {
                                if (e.key === 'Enter') {
                                    e.preventDefault();
                                    valueInput.blur(); // Trigger blur event on Enter
                                }
                            });
                            
                            container.appendChild(posSelect);
                            container.appendChild(currencySymbol);
                            container.appendChild(valueInput);
                            td.appendChild(container);
                        }
                        
                        tr.appendChild(td);
                    });
                    
                    // Add delete row button
                    const actionTd = document.createElement('td');
                    actionTd.style.border = 'none';
                    actionTd.style.background = '#f8f9fa';
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-row-btn';
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.addEventListener('click', () => this.deleteInfoTableRow(rowIndex));
                    actionTd.appendChild(deleteBtn);
                    tr.appendChild(actionTd);
                    
                    tbody.appendChild(tr);
                });
            },
            
            addInfoTableRow() {
                const newRow = new Array(this.infoTableData.headers.length).fill('');
                this.infoTableData.rows.push(newRow);
                this.renderInfoTable();
                this.showToast('Row added', 'success');
            },
            
            addInfoTableColumn() {
                const columnName = prompt('Enter column name:');
                if (columnName) {
                    this.infoTableData.headers.push(columnName);
                    // Add empty cell to all existing rows
                    this.infoTableData.rows.forEach(row => {
                        row.push('');
                    });
                    this.renderInfoTable();
                    this.showToast('Column added', 'success');
                }
            },
            
            deleteInfoTableRow(rowIndex) {
                if (confirm('Delete this row?')) {
                    this.infoTableData.rows.splice(rowIndex, 1);
                    this.renderInfoTable();
                    this.updateRemainingPotMoney();
                    this.saveData();
                    this.showToast('Row deleted', 'warning');
                }
            },
            
            showDeleteColumnDialog() {
                // Get all deletable columns (index 2+)
                const deletableColumns = [];
                this.infoTableData.headers.forEach((header, index) => {
                    if (index >= 2) {
                        deletableColumns.push({ index, name: header });
                    }
                });
                
                if (deletableColumns.length === 0) {
                    this.showToast('No columns to delete', 'warning');
                    return;
                }
                
                // Build the message with numbered list
                let message = 'Select column to delete:\n\n';
                deletableColumns.forEach((col, i) => {
                    message += `${i + 1}. ${col.name}\n`;
                });
                message += `\nEnter number (1-${deletableColumns.length}):`;
                
                const input = prompt(message);
                if (input === null) return; // User cancelled
                
                const selectedNum = parseInt(input);
                if (isNaN(selectedNum) || selectedNum < 1 || selectedNum > deletableColumns.length) {
                    this.showToast('Invalid selection', 'error');
                    return;
                }
                
                const selectedColumn = deletableColumns[selectedNum - 1];
                this.deleteInfoTableColumn(selectedColumn.index);
            },
            
            deleteInfoTableColumn(colIndex) {
                if (confirm(`Delete column "${this.infoTableData.headers[colIndex]}"?`)) {
                    this.infoTableData.headers.splice(colIndex, 1);
                    // Remove the column from all rows
                    this.infoTableData.rows.forEach(row => {
                        row.splice(colIndex, 1);
                    });
                    this.renderInfoTable();
                    this.saveData();
                    this.showToast('Column deleted', 'warning');
                }
            },
            
            saveInfoTable() {
                this.saveData();
                this.showToast('Table saved successfully!', 'success');
            },
            
            updateRemainingPotMoney() {
                const grandPot = parseFloat(this.infoTableData.grandPotMoney) || 0;
                let totalAwarded = 0;
                
                // Calculate total money awarded from Winners Position column (index 1)
                this.infoTableData.rows.forEach(row => {
                    const cell = row[1]; // Winners Position column
                    if (cell && cell.includes(' - ')) {
                        const parts = cell.split(' - ');
                        if (parts[1]) {
                            // Extract numeric value, removing currency symbols
                            const value = parseFloat(parts[1].replace(/[^0-9.]/g, ''));
                            if (!isNaN(value)) {
                                totalAwarded += value;
                            }
                        }
                    }
                });
                
                const remaining = grandPot - totalAwarded;
                const currency = this.infoTableData.currency || '$';
                
                // Update the remaining display
                const remainingSpan = document.getElementById('remainingPotMoney');
                if (remainingSpan) {
                    remainingSpan.textContent = `${currency}${remaining.toFixed(2)}`;
                    // Color code: green if positive, red if negative
                    if (remaining >= 0) {
                        remainingSpan.style.color = '#2ecc71';
                    } else {
                        remainingSpan.style.color = '#e74c3c';
                    }
                }
            },
            
            updateWinnersPositionTotals() {
                const currency = this.infoTableData.currency || '$';
                console.log('Updating Winners Position totals...');
                
                this.infoTableData.rows.forEach((row, rowIndex) => {
                    // Calculate total from all other columns (index 2+)
                    let total = 0;
                    for (let i = 2; i < row.length; i++) {
                        const cell = row[i];
                        if (cell && cell.includes(' - ')) {
                            const parts = cell.split(' - ');
                            if (parts[1]) {
                                const value = parseFloat(parts[1].replace(/[^0-9.]/g, ''));
                                if (!isNaN(value)) {
                                    total += value;
                                    console.log(`Row ${rowIndex}, Col ${i}: Adding ${value}, Total now: ${total}`);
                                }
                            }
                        }
                    }
                    
                    console.log(`Row ${rowIndex} final total: ${total}`);
                    
                    // Update the Winners Position cell data
                    this.infoTableData.rows[rowIndex][1] = `Total - ${currency}${total.toFixed(2)}`;
                    
                    // Update the display in the DOM using the ID
                    const totalSpan = document.getElementById(`winner-total-${rowIndex}`);
                    if (totalSpan) {
                        totalSpan.textContent = `${currency}${total.toFixed(2)}`;
                        console.log(`Updated DOM for row ${rowIndex}: ${currency}${total.toFixed(2)}`);
                    } else {
                        console.log(`Could not find span with ID winner-total-${rowIndex}`);
                    }
                });
            },
            
            populateCourseDropdown() {
                const select = document.getElementById('playerCourseSelect');
                select.innerHTML = '<option value="">Select course...</option>';
                this.courses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course.name;
                    option.textContent = course.name;
                    select.appendChild(option);
                });
            },
            
            populateGroupDropdown() {
                const select = document.getElementById('playerGroupSelect');
                const selectedCourse = document.getElementById('playerCourseSelect').value;
                
                // Clear existing options except the first
                select.innerHTML = '<option value="">No Group</option>';
                
                if (!selectedCourse) return;
                
                // Get existing numeric groups for the selected course
                const existingGroups = this.getGroupsForCourse(selectedCourse)
                    .map(g => parseInt(g))
                    .filter(g => !isNaN(g))
                    .sort((a, b) => a - b);
                
                // Find the highest group number
                const maxGroup = existingGroups.length > 0 ? Math.max(...existingGroups) : 0;
                
                // Generate groups 1 to maxGroup + 5 (always show at least 5 groups ahead)
                const totalGroups = Math.max(maxGroup + 5, 10);
                
                for (let i = 1; i <= totalGroups; i++) {
                    const groupName = i.toString();
                    const count = this.getGroupCountForCourse(groupName, selectedCourse);
                    const spotsLeft = Math.max(0, this.MAX_PLAYERS_PER_GROUP - count);
                    const option = document.createElement('option');
                    option.value = groupName;
                    
                    if (count >= this.MAX_PLAYERS_PER_GROUP) {
                        option.textContent = `Group ${groupName} (FULL)`;
                        option.disabled = true;
                    } else if (count > 0) {
                        option.textContent = `Group ${groupName} (${spotsLeft} spots left)`;
                    } else {
                        option.textContent = `Group ${groupName}`;
                    }
                    
                    select.appendChild(option);
                }
            },
            
            getGroupsForCourse(courseName) {
                const groups = new Set();
                this.players.forEach(player => {
                    if (player.course === courseName && player.group) {
                        groups.add(player.group);
                    }
                });
                return Array.from(groups);
            },
            
            getGroupCountForCourse(groupName, courseName, excludePlayerId = null) {
                return this.players.filter(p => 
                    p.course === courseName && 
                    p.group === groupName && 
                    (excludePlayerId === null || p.id !== excludePlayerId)
                ).length;
            },
            
            getAllGroups() {
                const groups = new Set();
                this.players.forEach(player => {
                    if (player.group) groups.add(player.group);
                });
                return Array.from(groups);
            },
            
            getGroupsByCourse() {
                const groupsByCourse = {};
                this.players.forEach(player => {
                    if (player.course && player.group) {
                        if (!groupsByCourse[player.course]) {
                            groupsByCourse[player.course] = new Set();
                        }
                        groupsByCourse[player.course].add(player.group);
                    }
                });
                
                // Convert Sets to Arrays
                const result = {};
                Object.keys(groupsByCourse).forEach(course => {
                    result[course] = Array.from(groupsByCourse[course]);
                });
                return result;
            },
            
            isGroupFullForCourse(groupName, courseName, excludePlayerId = null) {
                return this.getGroupCountForCourse(groupName, courseName, excludePlayerId) >= this.MAX_PLAYERS_PER_GROUP;
            },
            
            updateGroupStats() {
                const groupsByCourse = this.getGroupsByCourse();
                const groupStats = document.getElementById('groupStats');
                
                if (this.players.length > 0) {
                    groupStats.style.display = 'grid';
                    groupStats.innerHTML = '';
                    
                    // Collect all course-group combinations
                    const allCourseGroups = [];
                    
                    Object.keys(groupsByCourse).forEach(courseName => {
                        groupsByCourse[courseName].forEach(groupName => {
                            allCourseGroups.push({
                                course: courseName,
                                group: groupName,
                                count: this.getGroupCountForCourse(groupName, courseName)
                            });
                        });
                    });
                    
                    // Sort by count (descending) and take top 4
                    const topGroups = allCourseGroups
                        .sort((a, b) => b.count - a.count)
                        .slice(0, 4);
                    
                    topGroups.forEach(courseGroup => {
                        const isFull = courseGroup.count >= this.MAX_PLAYERS_PER_GROUP;
                        
                        const statDiv = document.createElement('div');
                        statDiv.className = 'group-stat';
                        statDiv.innerHTML = `
                            <h4>${courseGroup.course}</h4>
                            <div style="font-size: 0.7rem; color: #7f8c8d; margin-bottom: 2px;">${courseGroup.group}</div>
                            <div class="group-count" style="color: ${isFull ? '#e74c3c' : '#2ecc71'}">
                                ${courseGroup.count}/${this.MAX_PLAYERS_PER_GROUP}
                            </div>
                            <div style="font-size: 0.7rem; color: ${isFull ? '#e74c3c' : '#2ecc71'}">
                                ${isFull ? 'FULL' : `${this.MAX_PLAYERS_PER_GROUP - courseGroup.count} spots left`}
                            </div>
                        `;
                        groupStats.appendChild(statDiv);
                    });
                    
                    // Add Ungrouped count
                    const ungroupedCount = this.players.filter(p => !p.group || p.group === '').length;
                    const ungroupedDiv = document.createElement('div');
                    ungroupedDiv.className = 'group-stat';
                    ungroupedDiv.innerHTML = `
                        <h4>Ungrouped</h4>
                        <div class="group-count" style="color: #3498db">
                            ${ungroupedCount}
                        </div>
                        <div style="font-size: 0.7rem; color: #7f8c8d">
                            No group assigned
                        </div>
                    `;
                    groupStats.appendChild(ungroupedDiv);
                    
                } else {
                    groupStats.style.display = 'none';
                }
            },
            
            savePlayer() {
                const name = document.getElementById('playerName').value.trim();
                const handicap = parseFloat(document.getElementById('playerHandicapIndex').value) || 0;
                const phc = parseInt(document.getElementById('playerPHC').value) || 0;
                const course = document.getElementById('playerCourseSelect').value;
                const phcPercentage = document.getElementById('playerPHCPercentage').value;
                
                // Handle group selection
                let group = document.getElementById('playerGroupSelect').value;
                
                if (!name) {
                    this.showToast('Please enter player name', 'error');
                    return;
                }
                
                if (isNaN(handicap)) {
                    this.showToast('Please enter valid handicap index', 'error');
                    return;
                }
                
                if (!course) {
                    this.showToast('Please select a course', 'error');
                    return;
                }
                
                if (group && this.isGroupFullForCourse(group, course)) {
                    this.showToast(`Cannot add player to ${group} - group is full for ${course}!`, 'error');
                    return;
                }
                
                const player = {
                    id: Date.now(),
                    name: name,
                    handicap: handicap,
                    phc: phc,
                    course: course,
                    group: group,
                    date: new Date().toISOString().split('T')[0],
                    phcPercentage: phcPercentage
                };
                
                this.players.push(player);
                this.saveData();
                this.renderPlayers();
                this.updateGroupStats();
                this.populateScorecardDropdowns();
                this.hideAddPlayerForm();
                
                this.showToast(`Player "${name}" added! PHC: ${phc}`, 'success');
            },
            
            renderPlayers() {
                const container = document.getElementById('playersContainer');
                
                if (this.players.length === 0) {
                    container.innerHTML = `
                        <div class="empty-message">
                            <h3>No players added yet</h3>
                            <p>Import players from Excel or add them manually to get started.</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = '';
                
                const sortedPlayers = [...this.players].sort((a, b) => {
                    if (a.course === b.course) {
                        if (a.group === b.group) return a.name.localeCompare(b.name);
                        if (!a.group) return 1;
                        if (!b.group) return -1;
                        // Compare numerically if both are numbers, otherwise alphabetically
                        const aNum = parseInt(a.group);
                        const bNum = parseInt(b.group);
                        if (!isNaN(aNum) && !isNaN(bNum)) {
                            return aNum - bNum;
                        }
                        return a.group.localeCompare(b.group);
                    }
                    return a.course.localeCompare(b.course);
                });
                
                sortedPlayers.forEach(player => {
                    const card = document.createElement('div');
                    card.className = 'player-card';
                    
                    let groupBadge = '';
                    if (player.group) {
                        const groupLabel = isNaN(parseInt(player.group)) ? player.group : `Group ${player.group}`;
                        groupBadge = `<span class="player-group-badge">${groupLabel}</span>`;
                    }
                    
                    let phcInfo = `${player.phc || '0'}`;
                    if (player.phcPercentage && player.phcPercentage !== 'default') {
                        phcInfo += ` <span style="color: #3498db; font-size: 0.9em;">(${player.phcPercentage}%)</span>`;
                    }
                    
                    const groupDisplay = player.group ? 
                        (isNaN(parseInt(player.group)) ? player.group : `Group ${player.group}`) : 
                        'No group assigned';
                    
                    card.innerHTML = `
                        ${groupBadge}
                        <h3>${player.name}</h3>
                        <p><strong>Handicap Index:</strong> ${player.handicap}</p>
                        <p><strong>PHC:</strong> ${phcInfo}</p>
                        <p><strong>Course:</strong> ${player.course || 'Not assigned'}</p>
                        <p><strong>Group:</strong> ${groupDisplay}</p>
                        <div class="player-actions">
                            <button class="btn-secondary btn-small" onclick="app.editPlayer(${player.id})">‚úèÔ∏è Edit</button>
                            <button class="btn-danger btn-small" onclick="app.deletePlayer(${player.id})">üóëÔ∏è Delete</button>
                        </div>
                    `;
                    container.appendChild(card);
                });
            },
            
            editPlayer(playerId) {
                const player = this.players.find(p => p.id === playerId);
                if (!player) return;
                
                // Don't call showAddPlayerForm as it clears fields
                this.populateCourseDropdown();
                
                document.getElementById('playerName').value = player.name;
                document.getElementById('playerHandicapIndex').value = player.handicap;
                document.getElementById('playerPHC').value = player.phc;
                document.getElementById('playerCourseSelect').value = player.course;
                document.getElementById('playerPHCPercentage').value = player.phcPercentage || '';
                
                this.populateGroupDropdown();
                
                const groupSelect = document.getElementById('playerGroupSelect');
                if (player.group) {
                    // Check if the group exists in the dropdown
                    let optionExists = false;
                    for (let i = 0; i < groupSelect.options.length; i++) {
                        if (groupSelect.options[i].value === player.group) {
                            optionExists = true;
                            break;
                        }
                    }
                    
                    if (!optionExists) {
                        // Add the group as an option
                        const option = document.createElement('option');
                        option.value = player.group;
                        option.textContent = player.group;
                        groupSelect.insertBefore(option, groupSelect.lastElementChild);
                    }
                    groupSelect.value = player.group;
                } else {
                    groupSelect.value = '';
                }
                
                // Update modal title and button
                document.querySelector('#addPlayerForm h3').textContent = 'Edit Player';
                const saveBtn = document.getElementById('savePlayer');
                saveBtn.textContent = 'üíæ Update Player';
                saveBtn.onclick = () => this.updatePlayer(playerId);
                
                document.getElementById('addPlayerForm').style.display = 'flex';
            },
            
            updatePlayer(playerId) {
                const index = this.players.findIndex(p => p.id === playerId);
                if (index === -1) return;
                
                const name = document.getElementById('playerName').value.trim();
                const handicap = parseFloat(document.getElementById('playerHandicapIndex').value) || 0;
                const phc = parseInt(document.getElementById('playerPHC').value) || 0;
                const course = document.getElementById('playerCourseSelect').value;
                const phcPercentage = document.getElementById('playerPHCPercentage').value;
                
                // Handle group selection
                let group = document.getElementById('playerGroupSelect').value;
                
                const currentPlayer = this.players[index];
                
                // If changing course or group, check if the new group is full for the new course
                // Exclude current player from the count since they're being moved/updated
                if ((group !== currentPlayer.group || course !== currentPlayer.course) && 
                    group && this.isGroupFullForCourse(group, course, playerId)) {
                    this.showToast(`Cannot move player to ${group} - group is full for ${course}!`, 'error');
                    return;
                }
                
                this.players[index] = { 
                    ...this.players[index], 
                    name, 
                    handicap, 
                    phc, 
                    course, 
                    group: group || '',
                    phcPercentage: phcPercentage
                };
                
                this.saveData();
                this.renderPlayers();
                this.updateGroupStats();
                this.hideAddPlayerForm();
                
                this.showToast(`Player "${name}" updated!`, 'success');
            },
            
            deletePlayer(playerId) {
                if (!confirm('Delete this player?')) return;
                
                const index = this.players.findIndex(p => p.id === playerId);
                if (index === -1) return;
                
                const playerName = this.players[index].name;
                this.players.splice(index, 1);
                
                delete this.scores[playerId];
                delete this.leaderboardMoney[playerId];
                delete this.pairsScores[playerId];
                
                // Remove player from any pairs
                this.pairs = this.pairs.filter(pair => 
                    pair.player1.id !== playerId && pair.player2.id !== playerId
                );
                
                // Remove player from any comps
                this.removePlayerFromComps(playerId);
                
                // Remove player from master leaderboard
                this.masterLeaderboardData = this.masterLeaderboardData.filter(item => item.playerId !== playerId);
                
                this.saveData();
                this.renderPlayers();
                this.renderPairs();
                this.updateGroupStats();
                
                this.showToast(`Player "${playerName}" deleted`, 'warning');
            },
            
            removePlayerFromComps(playerId) {
                // Remove from 4BBB
                this.comps.fourBBB = this.comps.fourBBB.filter(team => 
                    !team.players.some(p => p.id === playerId)
                );
                
                // Remove from 4 Person Teams
                this.comps.fourPersonTeams = this.comps.fourPersonTeams.filter(team => 
                    !team.players.some(p => p.id === playerId)
                );
                
                // Remove from Best 3 from 4
                this.comps.best3From4 = this.comps.best3From4.filter(team => 
                    !team.players.some(p => p.id === playerId)
                );
            },
            
            // Course Management
            showAddCourseForm() {
                // Initialize hole configuration inputs
                this.initializeHoleInputs();
                
                // Reset button to add mode
                document.querySelector('#addCourseForm h3').textContent = 'Add New Course';
                const saveBtn = document.getElementById('saveCourse');
                saveBtn.textContent = 'üíæ Save Course';
                saveBtn.onclick = () => this.saveCourse();
                
                document.getElementById('addCourseForm').style.display = 'flex';
            },
            
            initializeHoleInputs() {
                const front9Container = document.getElementById('front9Holes');
                const back9Container = document.getElementById('back9Holes');
                
                front9Container.innerHTML = '';
                back9Container.innerHTML = '';
                
                // Default PAR pattern
                const defaultPars = [4,4,3,4,5,4,3,5,4,4,4,5,3,4,4,3,5,4];
                
                // Create inputs for holes 1-9 (Front 9)
                for (let i = 1; i <= 9; i++) {
                    const holeDiv = this.createHoleInput(i, defaultPars[i-1], i);
                    front9Container.appendChild(holeDiv);
                }
                
                // Create inputs for holes 10-18 (Back 9)
                for (let i = 10; i <= 18; i++) {
                    const holeDiv = this.createHoleInput(i, defaultPars[i-1], i);
                    back9Container.appendChild(holeDiv);
                }
            },
            
            createHoleInput(holeNumber, defaultPar, defaultIndex) {
                const div = document.createElement('div');
                div.style.cssText = 'display: grid; grid-template-columns: 40px 1fr 1fr; gap: 5px; align-items: center; padding: 5px; background: white; border-radius: 3px; border: 1px solid #ddd;';
                
                div.innerHTML = `
                    <span style="font-weight: bold; font-size: 10px; color: #2c3e50;">H${holeNumber}</span>
                    <div>
                        <label style="font-size: 9px; color: #7f8c8d; display: block;">Par</label>
                        <input type="number" 
                               class="hole-par-input" 
                               data-hole="${holeNumber}" 
                               value="${defaultPar}" 
                               min="3" 
                               max="6" 
                               style="width: 100%; padding: 3px; font-size: 11px; text-align: center; border: 1px solid #ddd; border-radius: 2px;">
                    </div>
                    <div>
                        <label style="font-size: 9px; color: #7f8c8d; display: block;">SI</label>
                        <input type="number" 
                               class="hole-index-input" 
                               data-hole="${holeNumber}" 
                               value="${defaultIndex}" 
                               min="1" 
                               max="18" 
                               style="width: 100%; padding: 3px; font-size: 11px; text-align: center; border: 1px solid #ddd; border-radius: 2px;">
                    </div>
                `;
                
                // Add keyboard navigation after DOM insertion
                setTimeout(() => {
                    const parInput = div.querySelector('.hole-par-input');
                    const indexInput = div.querySelector('.hole-index-input');
                    
                    if (parInput) {
                        parInput.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                // Move to SI input of same hole
                                indexInput.focus();
                                indexInput.select();
                            }
                        });
                    }
                    
                    if (indexInput) {
                        indexInput.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                // Move to Par input of next hole
                                const nextHole = holeNumber + 1;
                                if (nextHole <= 18) {
                                    const nextParInput = document.querySelector(`.hole-par-input[data-hole="${nextHole}"]`);
                                    if (nextParInput) {
                                        nextParInput.focus();
                                        nextParInput.select();
                                    }
                                }
                            }
                        });
                    }
                }, 0);
                
                return div;
            },
            
            hideAddCourseForm() {
                document.getElementById('addCourseForm').style.display = 'none';
                document.getElementById('courseName').value = '';
                document.getElementById('courseRating').value = '72.0';
                document.getElementById('courseSlope').value = '113';
                
                // Reset save button
                const saveBtn = document.getElementById('saveCourse');
                saveBtn.textContent = 'üíæ Save Course';
                saveBtn.onclick = () => this.saveCourse();
                
                // Reset modal title
                document.querySelector('#addCourseForm h3').textContent = 'Add New Course';
            },
            
            saveCourse() {
                const name = document.getElementById('courseName').value.trim();
                const rating = parseFloat(document.getElementById('courseRating').value);
                const slope = parseInt(document.getElementById('courseSlope').value);
                
                if (!name) {
                    this.showToast('Please enter course name', 'error');
                    return;
                }
                
                if (isNaN(rating) || rating < 50 || rating > 85) {
                    this.showToast('Please enter valid course rating (50-85)', 'error');
                    return;
                }
                
                if (isNaN(slope) || slope < 55 || slope > 155) {
                    this.showToast('Please enter valid slope rating (55-155)', 'error');
                    return;
                }
                
                // Read hole configuration from inputs
                const holes = [];
                let totalPar = 0;
                let frontPar = 0;
                let backPar = 0;
                
                for (let i = 1; i <= 18; i++) {
                    const parInput = document.querySelector(`.hole-par-input[data-hole="${i}"]`);
                    const indexInput = document.querySelector(`.hole-index-input[data-hole="${i}"]`);
                    
                    const par = parseInt(parInput.value) || 4;
                    const index = parseInt(indexInput.value) || i;
                    
                    holes.push({
                        number: i,
                        par: par,
                        index: index,
                        yardage: 0
                    });
                    
                    totalPar += par;
                    if (i <= 9) {
                        frontPar += par;
                    } else {
                        backPar += par;
                    }
                }
                
                // Create course with configured holes
                const course = {
                    id: Date.now(),
                    name: name,
                    rating: rating,
                    slope: slope,
                    par: totalPar,
                    teeColor: 'White',
                    holes: holes,
                    frontPar: frontPar,
                    backPar: backPar,
                    date: new Date().toISOString()
                };
                
                this.courses.push(course);
                this.saveData();
                this.renderCourses();
                this.populateScorecardDropdowns();
                this.populatePairsCourseDropdown();
                this.hideAddCourseForm();
                
                this.showToast(`Course "${name}" added with Par ${totalPar}!`, 'success');
            },
            
            renderCourses() {
                const container = document.getElementById('coursesContainer');
                
                if (this.courses.length === 0) {
                    container.innerHTML = `
                        <div class="empty-message">
                            <h3>No courses available</h3>
                            <p>Add your first golf course to get started.</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = '';
                
                this.courses.forEach(course => {
                    const card = document.createElement('div');
                    card.className = 'player-card';
                    
                    card.innerHTML = `
                        <div class="player-card-header">
                            <h3>${course.name}</h3>
                            <div class="player-actions">
                                <button class="btn-secondary btn-small" onclick="app.editCourse(${course.id})">‚úèÔ∏è Edit</button>
                                <button class="btn-danger btn-small" onclick="app.deleteCourse(${course.id})">üóëÔ∏è Delete</button>
                            </div>
                        </div>
                        <p><strong>Rating:</strong> ${course.rating}</p>
                        <p><strong>Slope:</strong> ${course.slope}</p>
                        <p><strong>Par:</strong> ${course.par}</p>
                        <p><strong>Tee:</strong> ${course.teeColor || 'White'}</p>
                    `;
                    container.appendChild(card);
                });
            },
            
            editCourse(courseId) {
                const course = this.courses.find(c => c.id === courseId);
                if (!course) return;
                
                // Populate form with course data
                document.getElementById('courseName').value = course.name;
                document.getElementById('courseRating').value = course.rating;
                document.getElementById('courseSlope').value = course.slope;
                
                // Initialize and populate hole inputs
                this.initializeHoleInputs();
                
                // Populate hole data
                if (course.holes && course.holes.length === 18) {
                    course.holes.forEach(hole => {
                        const parInput = document.querySelector(`.hole-par-input[data-hole="${hole.number}"]`);
                        const indexInput = document.querySelector(`.hole-index-input[data-hole="${hole.number}"]`);
                        
                        if (parInput) parInput.value = hole.par;
                        if (indexInput) indexInput.value = hole.index;
                    });
                }
                
                // Change save button to update
                const saveBtn = document.getElementById('saveCourse');
                saveBtn.textContent = 'üíæ Update Course';
                saveBtn.onclick = () => this.updateCourse(courseId);
                
                // Update modal title
                document.querySelector('#addCourseForm h3').textContent = 'Edit Course';
                
                document.getElementById('addCourseForm').style.display = 'flex';
            },
            
            updateCourse(courseId) {
                const index = this.courses.findIndex(c => c.id === courseId);
                if (index === -1) return;
                
                const name = document.getElementById('courseName').value.trim();
                const rating = parseFloat(document.getElementById('courseRating').value);
                const slope = parseInt(document.getElementById('courseSlope').value);
                
                if (!name) {
                    this.showToast('Please enter course name', 'error');
                    return;
                }
                
                if (isNaN(rating) || rating < 50 || rating > 85) {
                    this.showToast('Please enter valid course rating (50-85)', 'error');
                    return;
                }
                
                if (isNaN(slope) || slope < 55 || slope > 155) {
                    this.showToast('Please enter valid slope rating (55-155)', 'error');
                    return;
                }
                
                // Read hole configuration from inputs
                const holes = [];
                let totalPar = 0;
                let frontPar = 0;
                let backPar = 0;
                
                for (let i = 1; i <= 18; i++) {
                    const parInput = document.querySelector(`.hole-par-input[data-hole="${i}"]`);
                    const indexInput = document.querySelector(`.hole-index-input[data-hole="${i}"]`);
                    
                    const par = parseInt(parInput.value) || 4;
                    const index = parseInt(indexInput.value) || i;
                    
                    holes.push({
                        number: i,
                        par: par,
                        index: index,
                        yardage: 0
                    });
                    
                    totalPar += par;
                    if (i <= 9) {
                        frontPar += par;
                    } else {
                        backPar += par;
                    }
                }
                
                // Update course
                this.courses[index] = {
                    ...this.courses[index],
                    name: name,
                    rating: rating,
                    slope: slope,
                    par: totalPar,
                    holes: holes,
                    frontPar: frontPar,
                    backPar: backPar
                };
                
                this.saveData();
                this.renderCourses();
                this.populateScorecardDropdowns();
                this.populatePairsCourseDropdown();
                this.hideAddCourseForm();
                
                // Reset save button
                const saveBtn = document.getElementById('saveCourse');
                saveBtn.textContent = 'üíæ Save Course';
                saveBtn.onclick = () => this.saveCourse();
                
                // Reset modal title
                document.querySelector('#addCourseForm h3').textContent = 'Add New Course';
                
                this.showToast(`Course "${name}" updated with Par ${totalPar}!`, 'success');
            },
            
            deleteCourse(courseId) {
                const index = this.courses.findIndex(c => c.id === courseId);
                if (index === -1) return;
                
                if (!confirm('Delete this course?')) return;
                
                const courseName = this.courses[index].name;
                this.courses.splice(index, 1);
                
                if (this.scorecardSettings.selectedCourseId == courseId) {
                    this.scorecardSettings.selectedCourseId = '';
                    this.saveScorecardSettings();
                }
                
                // If this course was used for pairs, clear pairs
                if (this.pairsCourseGenerated === courseName) {
                    this.pairs = [];
                    this.pairsScores = {};
                    this.pairsMoney = {};
                    this.pairsCourseGenerated = '';
                    this.saveData();
                    this.renderPairs();
                }
                
                this.saveData();
                this.renderCourses();
                this.populateScorecardDropdowns();
                this.populatePairsCourseDropdown();
                
                this.showToast(`Course "${courseName}" deleted`, 'warning');
            },
            
            // Scorecard
            saveScorecardSettings() {
                this.scorecardSettings.selectedCourseId = document.getElementById('scorecardCourseSelect').value;
                this.scorecardSettings.selectedGroupFilter = document.getElementById('scorecardGroupSelect').value;
                localStorage.setItem('golfScorecardSettings', JSON.stringify(this.scorecardSettings));
            },
            
            restoreScorecardSettings() {
                const courseSelect = document.getElementById('scorecardCourseSelect');
                const groupSelect = document.getElementById('scorecardGroupSelect');
                
                if (this.scorecardSettings.selectedCourseId) {
                    courseSelect.value = this.scorecardSettings.selectedCourseId;
                }
                
                if (this.scorecardSettings.selectedGroupFilter) {
                    groupSelect.value = this.scorecardSettings.selectedGroupFilter;
                }
            },
            
            populateScorecardDropdowns() {
                const courseSelect = document.getElementById('scorecardCourseSelect');
                courseSelect.innerHTML = '<option value="">Select a course...</option>';
                
                this.courses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course.id;
                    option.textContent = course.name;
                    courseSelect.appendChild(option);
                });
                
                if (this.scorecardSettings.selectedCourseId) {
                    courseSelect.value = this.scorecardSettings.selectedCourseId;
                }
                
                // Populate group filter dropdown based on selected course
                const groupSelect = document.getElementById('scorecardGroupSelect');
                groupSelect.innerHTML = '<option value="all">All Players</option>';
                
                const selectedCourseId = document.getElementById('scorecardCourseSelect').value;
                if (selectedCourseId) {
                    const course = this.courses.find(c => c.id == selectedCourseId);
                    if (course) {
                        const groups = this.getGroupsForCourse(course.name);
                        groups.forEach(group => {
                            const option = document.createElement('option');
                            option.value = group;
                            option.textContent = group;
                            groupSelect.appendChild(option);
                        });
                    }
                }
                
                groupSelect.innerHTML += '<option value="ungrouped">Ungrouped Only</option>';
            },
            
            renderScorecard() {
                const container = document.getElementById('scorecardContainer');
                const courseId = document.getElementById('scorecardCourseSelect').value;
                const groupFilter = document.getElementById('scorecardGroupSelect').value;
                
                this.scorecardSettings.selectedCourseId = courseId;
                this.scorecardSettings.selectedGroupFilter = groupFilter;
                this.saveScorecardSettings();
                
                if (!courseId) {
                    container.innerHTML = `
                        <div class="no-scorecard-message">
                            <h3>No course selected</h3>
                            <p>Please select a course from the dropdown above.</p>
                            ${this.courses.length === 0 ? '<p><strong>No courses available. Add a course first.</strong></p>' : ''}
                        </div>
                    `;
                    return;
                }
                
                const course = this.courses.find(c => c.id == courseId);
                if (!course || !course.holes || course.holes.length !== 18) {
                    container.innerHTML = `
                        <div class="no-scorecard-message">
                            <h3>Course not properly configured</h3>
                            <p>The selected course does not have complete hole setup.</p>
                        </div>
                    `;
                    return;
                }
                
                console.log('Scorecard Debug:', {
                    courseName: course.name,
                    totalPlayers: this.players.length,
                    playerCourses: this.players.map(p => ({ name: p.name, course: p.course }))
                });
                
                // Case-insensitive course name matching
                let filteredPlayers = this.players.filter(p => 
                    p.course && course.name && 
                    p.course.toLowerCase() === course.name.toLowerCase()
                );
                if (groupFilter !== 'all') {
                    if (groupFilter === 'ungrouped') {
                        filteredPlayers = filteredPlayers.filter(p => !p.group || p.group === '');
                    } else {
                        filteredPlayers = filteredPlayers.filter(p => p.group === groupFilter);
                    }
                }
                
                if (filteredPlayers.length === 0) {
                    container.innerHTML = `
                        <div class="no-scorecard-message">
                            <h3>No players for this course/group</h3>
                            <p>No players are assigned to "${course.name}"${groupFilter !== 'all' ? ` in ${groupFilter}` : ''}.</p>
                        </div>
                    `;
                    return;
                }
                
                // Sort players based on selected sort option
                const sortSelect = document.getElementById('scorecardSortSelect');
                const sortOption = sortSelect ? sortSelect.value : 'totalPoints';
                
                // Calculate totals for each player for sorting
                const playersWithTotals = filteredPlayers.map(player => {
                    const playerScores = this.scores[player.id] || {};
                    let front9Gross = 0, front9Points = 0, back9Gross = 0, back9Points = 0, totalGross = 0, totalPoints = 0;
                    
                    for (let i = 1; i <= 18; i++) {
                        const hole = course.holes.find(h => h.number === i);
                        const score = playerScores[i];
                        if (score !== undefined && score !== null && score !== '' && hole) {
                            const scoreNum = parseInt(score);
                            const stablefordResult = this.calculateStablefordWithResult(score, hole.par, player.phc, hole.index);
                            if (i <= 9) {
                                front9Gross += scoreNum;
                                front9Points += stablefordResult.points;
                            } else {
                                back9Gross += scoreNum;
                                back9Points += stablefordResult.points;
                            }
                            totalGross += scoreNum;
                            totalPoints += stablefordResult.points;
                        }
                    }
                    
                    return { player, front9Gross, front9Points, back9Gross, back9Points, totalGross, totalPoints };
                });
                
                // Sort based on selection
                playersWithTotals.sort((a, b) => {
                    switch(sortOption) {
                        case 'name':
                            return a.player.name.localeCompare(b.player.name);
                        case 'totalPoints':
                            if (b.totalPoints !== a.totalPoints) {
                                return b.totalPoints - a.totalPoints;
                            }
                            // If tied on total points, use countback (a vs b, not b vs a)
                            return this.compareCountback(
                                this.calculateCountbackScore(this.scores[a.player.id] || {}, course, a.player),
                                this.calculateCountbackScore(this.scores[b.player.id] || {}, course, b.player)
                            );
                        case 'totalPointsAsc':
                            return a.totalPoints - b.totalPoints;
                        case 'totalGross':
                            return a.totalGross - b.totalGross;
                        case 'totalGrossDesc':
                            return b.totalGross - a.totalGross;
                        case 'back9Points':
                            return b.back9Points - a.back9Points;
                        case 'front9Points':
                            return b.front9Points - a.front9Points;
                        default:
                            return 0;
                    }
                });
                
                // Update filteredPlayers with sorted order
                filteredPlayers = playersWithTotals.map(item => item.player);
                
                // Ultra-compact scorecard HTML
                let html = `
                    <div class="scorecard-container">
                        <div style="background: #3498db; color: white; padding: 8px; text-align: center;">
                            <h3 style="margin: 0; font-size: 1rem;">${course.name}</h3>
                            <p style="margin: 2px 0 0 0; font-size: 0.7rem; opacity: 0.9;">
                                Par ${course.par} | Rating ${course.rating} | Slope ${course.slope}
                            </p>
                        </div>
                        <table class="scorecard-table">
                            <thead>
                                <tr>
                                    <th class="player-name-cell">Player / PHC / Group</th>
                `;
                
                // Ultra-compact hole headers
                for (let i = 1; i <= 18; i++) {
                    const hole = course.holes.find(h => h.number === i);
                    html += `<th class="hole-header">
                        <div style="font-weight: bold; font-size: 14px;">${i}</div>
                        <div style="color: #2ecc71; font-weight: bold; font-size: 14px;">${hole.par}</div>
                        <div style="color: #3498db; font-weight: bold; font-size: 14px;">${hole.index}</div>
                    </th>`;
                }
                
                // Summary headers with complete countback progression
                html += `
                    <th class="summary-cell front9-gross-cell">F9 G</th>
                    <th class="summary-cell front9-points-cell">F9 P</th>
                    <th class="summary-cell back9-gross-cell">B9 G</th>
                    <th class="summary-cell back9-points-cell">B9 P</th>
                    <th class="summary-cell total-gross-cell">TOT G</th>
                    <th class="summary-cell total-points-cell">TOT P</th>
                    <th class="summary-cell countback-cell" title="Back 9 (10-18)">B9</th>
                    <th class="summary-cell countback-cell" title="Holes 13-18">13-18</th>
                    <th class="summary-cell countback-cell" title="Holes 16-18">16-18</th>
                    <th class="summary-cell countback-cell" title="Holes 17-18">17-18</th>
                    <th class="summary-cell countback-cell" title="Hole 18">H18</th>
                    <th class="summary-cell front9-points-cell" title="Front 9 (1-9)">F9</th>
                    <th class="summary-cell countback-cell" title="Holes 4-9">4-9</th>
                    <th class="summary-cell countback-cell" title="Holes 7-9">7-9</th>
                    <th class="summary-cell countback-cell" title="Holes 8-9">8-9</th>
                    <th class="summary-cell countback-cell" title="Hole 9">H9</th>
                </tr>
                </thead>
                <tbody>
                `;
                
                filteredPlayers.forEach(player => {
                    const playerScores = this.scores[player.id] || {};
                    
                    let front9Gross = 0;
                    let front9Points = 0;
                    let back9Gross = 0;
                    let back9Points = 0;
                    let totalGross = 0;
                    let totalPoints = 0;
                    
                    // Calculate countback data using new function
                    const countbackData = this.calculateCountbackScore(playerScores, course, player);
                    
                    html += `
                        <tr>
                            <td class="player-name-cell">
                                <div style="font-weight: bold; font-size: 0.9em;">${player.name}</div>
                                <div style="font-size: 0.8em; color: #7f8c8d;">
                                    PHC: ${player.phc || 0} | ${player.group || 'Ungrouped'}
                                </div>
                            </td>
                    `;
                    
                    for (let i = 1; i <= 18; i++) {
                        const hole = course.holes.find(h => h.number === i);
                        const score = playerScores[i] !== undefined ? playerScores[i] : '';
                        const par = hole ? hole.par : 4;
                        const holeIndex = hole ? hole.index : 18;
                        
                        html += `<td style="padding: 2px; border: 1px solid #e0e0e0; min-width: 35px; height: 45px;">`;
                        
                        if (score !== '' && score !== null && score !== undefined) {
                            const scoreNum = parseInt(score);
                            const netScore = this.calculateNetScore(scoreNum, player.phc, holeIndex);
                            const stablefordResult = this.calculateStablefordWithResult(scoreNum, par, player.phc, holeIndex);
                            
                            if (i <= 9) {
                                front9Gross += scoreNum;
                                front9Points += stablefordResult.points;
                            } else {
                                back9Gross += scoreNum;
                                back9Points += stablefordResult.points;
                            }
                            
                            totalGross += scoreNum;
                            totalPoints += stablefordResult.points;
                            
                            const stablefordClass = `stableford-${stablefordResult.type}`;
                            const displayText = stablefordResult.type === 'nr' ? 'NR' : stablefordResult.points;
                            
                            html += `
                                <input type="number" 
                                       min="0" 
                                       max="15" 
                                       value="${score}" 
                                       data-player="${player.id}" 
                                       data-hole="${i}"
                                       class="score-input"
                                       placeholder="-">
                                <div class="stableford-display ${stablefordClass}">${displayText}</div>
                            `;
                        } else {
                            html += `
                                <input type="number" 
                                       min="0" 
                                       max="15" 
                                       value="" 
                                       data-player="${player.id}" 
                                       data-hole="${i}"
                                       class="score-input"
                                       placeholder="-">
                            `;
                        }
                        
                        html += `</td>`;
                    }
                    
                    // Summary cells with complete countback sequence
                    html += `
                        <td class="summary-cell front9-gross-cell">${front9Gross > 0 ? front9Gross : ''}</td>
                        <td class="summary-cell front9-points-cell">${front9Points > 0 ? front9Points : ''}</td>
                        <td class="summary-cell back9-gross-cell">${back9Gross > 0 ? back9Gross : ''}</td>
                        <td class="summary-cell back9-points-cell">${back9Points > 0 ? back9Points : ''}</td>
                        <td class="summary-cell total-gross-cell">${totalGross > 0 ? totalGross : ''}</td>
                        <td class="summary-cell total-points-cell">${totalPoints > 0 ? totalPoints : ''}</td>
                        <td class="summary-cell countback-cell">${countbackData.back9 > 0 ? countbackData.back9 : ''}</td>
                        <td class="summary-cell countback-cell">${countbackData.back9_last6 > 0 ? countbackData.back9_last6 : ''}</td>
                        <td class="summary-cell countback-cell">${countbackData.back9_last3 > 0 ? countbackData.back9_last3 : ''}</td>
                        <td class="summary-cell countback-cell">${countbackData.back9_last2 > 0 ? countbackData.back9_last2 : ''}</td>
                        <td class="summary-cell countback-cell">${countbackData.back9_last1 > 0 ? countbackData.back9_last1 : ''}</td>
                        <td class="summary-cell front9-points-cell">${countbackData.front9 > 0 ? countbackData.front9 : ''}</td>
                        <td class="summary-cell countback-cell">${countbackData.front9_last6 > 0 ? countbackData.front9_last6 : ''}</td>
                        <td class="summary-cell countback-cell">${countbackData.front9_last3 > 0 ? countbackData.front9_last3 : ''}</td>
                        <td class="summary-cell countback-cell">${countbackData.front9_last2 > 0 ? countbackData.front9_last2 : ''}</td>
                        <td class="summary-cell countback-cell">${countbackData.front9_last1 > 0 ? countbackData.front9_last1 : ''}</td>
                    </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                </div>
                `;
                
                container.innerHTML = html;
                
                this.setupScoreInputListeners();
            },
            
            setupScoreInputListeners() {
                document.querySelectorAll('.score-input').forEach(input => {
                    const newInput = input.cloneNode(true);
                    input.parentNode.replaceChild(newInput, input);
                    
                    newInput.addEventListener('input', (e) => {
                        const playerId = parseInt(e.target.dataset.player);
                        const hole = parseInt(e.target.dataset.hole);
                        const score = e.target.value.trim();
                        
                        if (!this.scores[playerId]) this.scores[playerId] = {};
                        
                        if (score === '') {
                            delete this.scores[playerId][hole];
                            const cell = e.target.closest('td');
                            const stablefordDisplay = cell.querySelector('.stableford-display');
                            if (stablefordDisplay) stablefordDisplay.remove();
                        } else {
                            const scoreNum = parseInt(score);
                            if (scoreNum >= 0 && scoreNum <= 15) {
                                this.scores[playerId][hole] = scoreNum;
                                
                                const cell = e.target.closest('td');
                                const existingStableford = cell.querySelector('.stableford-display');
                                if (existingStableford) existingStableford.remove();
                                
                                const courseId = document.getElementById('scorecardCourseSelect').value;
                                const course = this.courses.find(c => c.id == courseId);
                                if (course) {
                                    const holeData = course.holes.find(h => h.number === hole);
                                    if (holeData) {
                                        const player = this.players.find(p => p.id === playerId);
                                        if (player) {
                                            const stablefordResult = this.calculateStablefordWithResult(
                                                scoreNum, 
                                                holeData.par, 
                                                player.phc, 
                                                holeData.index
                                            );
                                            
                                            const stablefordDiv = document.createElement('div');
                                            const displayText = stablefordResult.type === 'nr' ? 'NR' : stablefordResult.points;
                                            stablefordDiv.className = `stableford-display stableford-${stablefordResult.type}`;
                                            stablefordDiv.textContent = displayText;
                                            cell.appendChild(stablefordDiv);
                                        }
                                    }
                                }
                            } else {
                                e.target.value = '';
                                delete this.scores[playerId][hole];
                                const cell = e.target.closest('td');
                                const stablefordDisplay = cell.querySelector('.stableford-display');
                                if (stablefordDisplay) stablefordDisplay.remove();
                            }
                        }
                        
                        this.saveData();
                        this.updateScorecardTotals(playerId);
                    });
                    
                    newInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            e.target.dispatchEvent(new Event('input'));
                            
                            const playerId = parseInt(e.target.dataset.player);
                            const currentHole = parseInt(e.target.dataset.hole);
                            
                            const row = e.target.closest('tr');
                            const allInputsInRow = Array.from(row.querySelectorAll('.score-input'));
                            
                            allInputsInRow.sort((a, b) => {
                                return parseInt(a.dataset.hole) - parseInt(b.dataset.hole);
                            });
                            
                            const currentIndex = allInputsInRow.findIndex(input => 
                                parseInt(input.dataset.hole) === currentHole
                            );
                            
                            if (currentIndex !== -1 && currentIndex < allInputsInRow.length - 1) {
                                const nextInput = allInputsInRow[currentIndex + 1];
                                setTimeout(() => {
                                    nextInput.focus();
                                    nextInput.select();
                                }, 10);
                            }
                        }
                    });
                    
                    newInput.addEventListener('focus', (e) => {
                        setTimeout(() => e.target.select(), 10);
                    });
                });
            },
            
            updateScorecardTotals(playerId) {
                const courseId = document.getElementById('scorecardCourseSelect').value;
                if (!courseId) return;
                
                const course = this.courses.find(c => c.id == courseId);
                if (!course) return;
                
                const player = this.players.find(p => p.id === playerId);
                if (!player) return;
                
                const playerScores = this.scores[playerId] || {};
                
                let front9Gross = 0;
                let front9Points = 0;
                let back9Gross = 0;
                let back9Points = 0;
                let totalGross = 0;
                let totalPoints = 0;
                
                // Calculate countback data using new function
                const countbackData = this.calculateCountbackScore(playerScores, course, player);
                
                for (let i = 1; i <= 18; i++) {
                    const hole = course.holes.find(h => h.number === i);
                    const score = playerScores[i];
                    
                    if (score !== undefined && score !== null && score !== '' && hole) {
                        const scoreNum = parseInt(score);
                        const netScore = this.calculateNetScore(scoreNum, player.phc, hole.index);
                        const stablefordResult = this.calculateStablefordWithResult(
                            score, 
                            hole.par, 
                            player.phc,
                            hole.index
                        );
                        
                        if (i <= 9) {
                            front9Gross += scoreNum;
                            front9Points += stablefordResult.points;
                        } else {
                            back9Gross += scoreNum;
                            back9Points += stablefordResult.points;
                        }
                        
                        totalGross += scoreNum;
                        totalPoints += stablefordResult.points;
                    }
                }
                
                const playerRows = document.querySelectorAll(`tr td.player-name-cell`);
                playerRows.forEach((td, rowIndex) => {
                    if (td.textContent.includes(player.name)) {
                        const row = td.closest('tr');
                        if (row) {
                            const totalCells = row.querySelectorAll('.summary-cell');
                            if (totalCells.length >= 16) {
                                totalCells[0].textContent = front9Gross > 0 ? front9Gross : '';
                                totalCells[1].textContent = front9Points > 0 ? front9Points : '';
                                totalCells[2].textContent = back9Gross > 0 ? back9Gross : '';
                                totalCells[3].textContent = back9Points > 0 ? back9Points : '';
                                totalCells[4].textContent = totalGross > 0 ? totalGross : '';
                                totalCells[5].textContent = totalPoints > 0 ? totalPoints : '';
                                // Update all 11 countback columns
                                totalCells[6].textContent = countbackData.back9 > 0 ? countbackData.back9 : '';
                                totalCells[7].textContent = countbackData.back9_last6 > 0 ? countbackData.back9_last6 : '';
                                totalCells[8].textContent = countbackData.back9_last3 > 0 ? countbackData.back9_last3 : '';
                                totalCells[9].textContent = countbackData.back9_last2 > 0 ? countbackData.back9_last2 : '';
                                totalCells[10].textContent = countbackData.back9_last1 > 0 ? countbackData.back9_last1 : '';
                                totalCells[11].textContent = countbackData.front9 > 0 ? countbackData.front9 : '';
                                totalCells[12].textContent = countbackData.front9_last6 > 0 ? countbackData.front9_last6 : '';
                                totalCells[13].textContent = countbackData.front9_last3 > 0 ? countbackData.front9_last3 : '';
                                totalCells[14].textContent = countbackData.front9_last2 > 0 ? countbackData.front9_last2 : '';
                                totalCells[15].textContent = countbackData.front9_last1 > 0 ? countbackData.front9_last1 : '';
                            }
                        }
                    }
                });
            },
            
            calculateNetScore(grossScore, phc, holeIndex) {
                if (grossScore === undefined || grossScore === null) return 0;
                const gross = parseInt(grossScore);
                if (isNaN(gross)) return 0;
                if (!phc && phc !== 0) return gross;
                
                const playingHandicap = Math.floor(phc) || 0;
                let strokes = 0;
                
                if (playingHandicap >= 0) {
                    // Positive handicap: player RECEIVES strokes
                    if (playingHandicap >= 18) {
                        strokes = 1 + Math.floor((playingHandicap - holeIndex) / 18);
                    } else if (playingHandicap >= holeIndex) {
                        strokes = 1;
                    }
                    return Math.max(1, gross - strokes);
                } else {
                    // Negative handicap: player GIVES strokes to the course
                    // Strokes are given on HIGHEST stroke index holes (18, 17, 16, etc.)
                    const absHandicap = Math.abs(playingHandicap);
                    const strokeIndexThreshold = 19 - absHandicap; // e.g., -3 means SI 16, 17, 18 get +1
                    
                    if (holeIndex >= strokeIndexThreshold) {
                        strokes = -1; // Giving a stroke (adds to net score)
                    }
                    return gross - strokes; // Subtracting -1 = adding 1
                }
            },
            
            calculateStablefordWithResult(grossScore, par, phc, holeIndex) {
                if (grossScore === 0 || grossScore === '0') {
                    return { points: 0, type: 'nr' };
                }
                
                if (grossScore === undefined || grossScore === null || grossScore === '') {
                    return { points: 0, type: 'double' };
                }
                
                const scoreNum = parseInt(grossScore);
                if (isNaN(scoreNum) || scoreNum === 0) {
                    return { points: 0, type: 'nr' };
                }
                
                const playingHandicap = Math.floor(phc) || 0;
                let strokesReceived = 0;
                
                if (playingHandicap >= 0) {
                    // Positive handicap: player RECEIVES strokes
                    if (playingHandicap >= 18) {
                        strokesReceived = 1 + Math.floor((playingHandicap - holeIndex) / 18);
                    } else if (playingHandicap >= holeIndex) {
                        strokesReceived = 1;
                    }
                } else {
                    // Negative handicap: player GIVES strokes to the course
                    // Strokes are given on HIGHEST stroke index holes (18, 17, 16, etc.)
                    const absHandicap = Math.abs(playingHandicap);
                    const strokeIndexThreshold = 19 - absHandicap; // e.g., -3 means SI 16, 17, 18 get stroke given
                    
                    if (holeIndex >= strokeIndexThreshold) {
                        strokesReceived = -1; // Player gives a stroke (net score increases)
                    }
                }
                
                const netScore = scoreNum - strokesReceived;
                const difference = par - netScore;
                
                if (difference >= 2) return { points: 4, type: 'eagle' };
                if (difference === 1) return { points: 3, type: 'birdie' };
                if (difference === 0) return { points: 2, type: 'par' };
                if (difference === -1) return { points: 1, type: 'bogey' };
                return { points: 0, type: 'double' };
            },
            
            // Calculate countback according to official golf rules
            // Full countback sequence as specified
            calculateCountbackScore(playerScores, course, player) {
                const countbackData = {
                    // Total points
                    totalPoints: 0,
                    
                    // Back 9 sequence
                    back9: 0,        // Holes 10-18
                    back9_last6: 0,  // Holes 13-18
                    back9_last3: 0,  // Holes 16-18
                    back9_last2: 0,  // Holes 17-18
                    back9_last1: 0,  // Hole 18
                    
                    // Front 9 sequence
                    front9: 0,       // Holes 1-9
                    front9_last6: 0, // Holes 4-9
                    front9_last3: 0, // Holes 7-9
                    front9_last2: 0, // Holes 8-9
                    front9_last1: 0  // Hole 9
                };
                
                // Calculate all 18 holes
                for (let i = 1; i <= 18; i++) {
                    const hole = course.holes.find(h => h.number === i);
                    const score = playerScores[i];
                    if (score !== undefined && score !== null && score !== '' && hole) {
                        const stablefordResult = this.calculateStablefordWithResult(
                            score, hole.par, player.phc, hole.index
                        );
                        const points = stablefordResult.points;
                        
                        countbackData.totalPoints += points;
                        
                        // Back 9 calculations (holes 10-18)
                        if (i >= 10) {
                            countbackData.back9 += points;
                            if (i >= 13) countbackData.back9_last6 += points;
                            if (i >= 16) countbackData.back9_last3 += points;
                            if (i >= 17) countbackData.back9_last2 += points;
                            if (i === 18) countbackData.back9_last1 = points;
                        }
                        
                        // Front 9 calculations (holes 1-9)
                        if (i <= 9) {
                            countbackData.front9 += points;
                            if (i >= 4) countbackData.front9_last6 += points;
                            if (i >= 7) countbackData.front9_last3 += points;
                            if (i >= 8) countbackData.front9_last2 += points;
                            if (i === 9) countbackData.front9_last1 = points;
                        }
                    }
                }
                
                return countbackData;
            },
            
            // Compare two players using complete official countback rules
            // Returns: -1 if player1 wins, 1 if player2 wins, 0 if still tied
            compareCountback(countback1, countback2) {
                // 1st: Total Stableford points (should already be compared, but included for completeness)
                if (countback1.totalPoints !== countback2.totalPoints) {
                    return countback2.totalPoints - countback1.totalPoints;
                }
                
                // 2nd: Back 9 (Holes 10-18)
                if (countback1.back9 !== countback2.back9) {
                    return countback2.back9 - countback1.back9;
                }
                
                // 3rd: Holes 13-18 (Last 6 holes of back 9)
                if (countback1.back9_last6 !== countback2.back9_last6) {
                    return countback2.back9_last6 - countback1.back9_last6;
                }
                
                // 4th: Holes 16-18 (Last 3 holes)
                if (countback1.back9_last3 !== countback2.back9_last3) {
                    return countback2.back9_last3 - countback1.back9_last3;
                }
                
                // 5th: Holes 17-18 (Last 2 holes)
                if (countback1.back9_last2 !== countback2.back9_last2) {
                    return countback2.back9_last2 - countback1.back9_last2;
                }
                
                // 6th: Hole 18 (Last 1 hole)
                if (countback1.back9_last1 !== countback2.back9_last1) {
                    return countback2.back9_last1 - countback1.back9_last1;
                }
                
                // 7th: Front 9 (Holes 1-9)
                if (countback1.front9 !== countback2.front9) {
                    return countback2.front9 - countback1.front9;
                }
                
                // 8th: Holes 4-9 (Last 6 holes of front 9)
                if (countback1.front9_last6 !== countback2.front9_last6) {
                    return countback2.front9_last6 - countback1.front9_last6;
                }
                
                // 9th: Holes 7-9 (Last 3 holes of front 9)
                if (countback1.front9_last3 !== countback2.front9_last3) {
                    return countback2.front9_last3 - countback1.front9_last3;
                }
                
                // 10th: Holes 8-9 (Last 2 holes of front 9)
                if (countback1.front9_last2 !== countback2.front9_last2) {
                    return countback2.front9_last2 - countback1.front9_last2;
                }
                
                // 11th: Hole 9 (Last hole of front 9)
                if (countback1.front9_last1 !== countback2.front9_last1) {
                    return countback2.front9_last1 - countback1.front9_last1;
                }
                
                // Still tied after all 11 countback checks
                return 0;
            },
            
            calculateAllScores() {
                const courseId = document.getElementById('scorecardCourseSelect').value;
                if (!courseId) {
                    this.showToast('Please select a course first', 'warning');
                    return;
                }
                
                const course = this.courses.find(c => c.id == courseId);
                if (!course) return;
                
                let calculatedCount = 0;
                
                const groupFilter = document.getElementById('scorecardGroupSelect').value;
                let players = this.players.filter(p => p.course === course.name);
                
                if (groupFilter !== 'all') {
                    if (groupFilter === 'ungrouped') {
                        players = players.filter(p => !p.group || p.group === '');
                    } else {
                        players = players.filter(p => p.group === groupFilter);
                    }
                }
                
                players.forEach(player => {
                    if (!this.scores[player.id]) this.scores[player.id] = {};
                    
                    for (let i = 1; i <= 18; i++) {
                        if (this.scores[player.id][i] === undefined) {
                            const hole = course.holes.find(h => h.number === i);
                            const par = hole ? hole.par : 4;
                            let score = par;
                            
                            const phcFactor = player.phc ? player.phc / 36 : 1;
                            const random = Math.random();
                            
                            if (random > 0.7) {
                                score += Math.floor(Math.random() * 3) - 1;
                            } else if (random > 0.3) {
                                score += Math.floor(Math.random() * 3) + 1;
                            } else {
                                score -= Math.floor(Math.random() * 2) + 1;
                            }
                            
                            if (player.phc > 18) score += Math.floor(player.phc / 18);
                            score = Math.max(1, Math.min(15, score));
                            this.scores[player.id][i] = score;
                            calculatedCount++;
                        }
                    }
                });
                
                if (calculatedCount > 0) {
                    this.saveData();
                    this.renderScorecard();
                    this.showToast(`Calculated ${calculatedCount} scores for ${players.length} players`, 'success');
                } else {
                    this.showToast('All scores already entered', 'info');
                }
            },
            
            // Pairs Functions
            populatePairsCourseDropdown() {
                const select = document.getElementById('pairsCourseSelect');
                select.innerHTML = '<option value="">Select course...</option>';
                this.courses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course.name;
                    option.textContent = course.name;
                    select.appendChild(option);
                });
                
                // Restore the selected course
                if (this.pairsCourseGenerated) {
                    select.value = this.pairsCourseGenerated;
                }
            },
            
            calculatePairsScores() {
                const courseName = document.getElementById('pairsCourseSelect').value;
                if (!courseName) {
                    this.showToast('Please select a course first', 'warning');
                    return;
                }
                
                const course = this.courses.find(c => c.name === courseName);
                if (!course) {
                    this.showToast('Selected course not found', 'error');
                    return;
                }
                
                if (this.pairs.length === 0) {
                    this.showToast('No pairs created yet', 'warning');
                    return;
                }
                
                let calculatedCount = 0;
                
                // Clear existing scores for this calculation
                this.pairsScores = {};
                
                this.pairs.forEach(pair => {
                    const player1Scores = this.scores[pair.player1.id] || {};
                    const player2Scores = this.scores[pair.player2.id] || {};
                    
                    let player1TotalPoints = 0;
                    let player1TotalGross = 0;
                    let player1Front9Points = 0;
                    let player1Back9Points = 0;
                    
                    let player2TotalPoints = 0;
                    let player2TotalGross = 0;
                    let player2Front9Points = 0;
                    let player2Back9Points = 0;
                    
                    // Calculate Player 1 scores
                    for (let i = 1; i <= 18; i++) {
                        const hole = course.holes.find(h => h.number === i);
                        if (!hole) continue;
                        
                        const player1Score = player1Scores[i];
                        if (player1Score !== undefined && player1Score !== null && player1Score !== '' && player1Score !== 0) {
                            const player1Result = this.calculateStablefordWithResult(
                                player1Score, 
                                hole.par, 
                                pair.player1.phc,
                                hole.index
                            );
                            
                            player1TotalPoints += player1Result.points;
                            player1TotalGross += parseInt(player1Score);
                            
                            if (i <= 9) {
                                player1Front9Points += player1Result.points;
                            } else {
                                player1Back9Points += player1Result.points;
                            }
                            calculatedCount++;
                        }
                    }
                    
                    // Calculate Player 2 scores
                    for (let i = 1; i <= 18; i++) {
                        const hole = course.holes.find(h => h.number === i);
                        if (!hole) continue;
                        
                        const player2Score = player2Scores[i];
                        if (player2Score !== undefined && player2Score !== null && player2Score !== '' && player2Score !== 0) {
                            const player2Result = this.calculateStablefordWithResult(
                                player2Score, 
                                hole.par, 
                                pair.player2.phc,
                                hole.index
                            );
                            
                            player2TotalPoints += player2Result.points;
                            player2TotalGross += parseInt(player2Score);
                            
                            if (i <= 9) {
                                player2Front9Points += player2Result.points;
                            } else {
                                player2Back9Points += player2Result.points;
                            }
                            calculatedCount++;
                        }
                    }
                    
                    // Add both players' scores together (not better ball)
                    const pairTotalPoints = player1TotalPoints + player2TotalPoints;
                    const pairTotalGross = player1TotalGross + player2TotalGross;
                    const pairFront9Points = player1Front9Points + player2Front9Points;
                    const pairBack9Points = player1Back9Points + player2Back9Points;
                    
                    // Store the pair's score
                    this.pairsScores[pair.id] = {
                        totalPoints: pairTotalPoints,
                        totalGross: pairTotalGross,
                        front9Points: pairFront9Points,
                        back9Points: pairBack9Points,
                        course: courseName,
                        calculatedAt: new Date().toISOString()
                    };
                });
                
                if (calculatedCount > 0) {
                    this.saveData();
                    this.renderPairs();
                    this.showToast(`Calculated scores for ${this.pairs.length} pairs`, 'success');
                } else {
                    this.showToast('No scores found for pairs players', 'warning');
                }
            },
            
            savePairsMoneyData() {
                // Find all money inputs in pairs and save their values
                const moneyInputs = document.querySelectorAll('input[data-pair]');
                moneyInputs.forEach(input => {
                    const pairId = parseInt(input.dataset.pair);
                    const value = input.value.trim();
                    
                    if (value === '') {
                        delete this.pairsMoney[pairId];
                    } else {
                        // Parse the value, removing any currency symbol
                        const cleanedValue = value.replace(/[^0-9.-]+/g, '');
                        const moneyValue = parseFloat(cleanedValue) || 0;
                        this.pairsMoney[pairId] = moneyValue;
                    }
                });
                
                this.saveData();
                this.showToast('Pairs money data saved', 'success');
                this.renderPairs();
            },
            
            renderPairs() {
                const container = document.getElementById('pairsContainer');
                
                if (this.pairs.length === 0) {
                    container.innerHTML = `
                        <div class="empty-message">
                            <h3>No pairs created yet</h3>
                            <p>Select a course and click "Random Draw" to create pairs.</p>
                        </div>
                    `;
                    return;
                }
                
                // Create compact grid layout
                container.innerHTML = '<div class="pairs-grid">';
                
                // Sort pairs by score (descending)
                const sortedPairs = [...this.pairs].sort((a, b) => {
                    const scoreA = this.pairsScores[a.id]?.totalPoints || 0;
                    const scoreB = this.pairsScores[b.id]?.totalPoints || 0;
                    return scoreB - scoreA;
                });
                
                sortedPairs.forEach((pair, index) => {
                    const pairScore = this.pairsScores[pair.id];
                    const pairMoney = this.pairsMoney[pair.id] || 0;
                    
                    // FULL player names - no truncation
                    const player1Name = pair.player1.name;
                    const player2Name = pair.player2.name;
                    
                    const card = document.createElement('div');
                    card.className = 'pair-card compact';
                    
                    // Determine position badge color
                    let positionBadgeColor = '#7f8c8d';
                    if (index === 0) positionBadgeColor = '#f39c12'; // Gold for 1st
                    if (index === 1) positionBadgeColor = '#95a5a6'; // Silver for 2nd
                    if (index === 2) positionBadgeColor = '#cd7f32'; // Bronze for 3rd
                    
                    card.innerHTML = `
                        <div class="pair-header">
                            <div class="pair-title">
                                <span style="background: ${positionBadgeColor}; color: white; padding: 1px 4px; border-radius: 8px; font-size: 0.5rem; font-weight: bold; margin-right: 3px;">
                                    ${index + 1}
                                </span>
                                <span>Pair ${index + 1}</span>
                            </div>
                            ${pairScore ? 
                                `<div style="background: ${this.getScoreColor(pairScore.totalPoints)}; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.8rem; font-weight: bold;">${pairScore.totalPoints}</div>` : 
                                `<div style="background: #f39c12; color: #2c3e50; padding: 2px 6px; border-radius: 10px; font-size: 0.6rem; font-weight: bold;">No Scores</div>`
                            }
                        </div>
                        
                        <!-- FULL Player Info - no truncation -->
                        <div style="font-size: 0.7rem; line-height: 1.3; margin: 4px 0; padding: 3px; background: #f8f9fa; border-radius: 3px; border-left: 2px solid #3498db;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: bold; color: #2c3e50; flex: 1;">${player1Name}</span>
                                <span style="color: #7f8c8d; font-size: 0.6rem; margin-left: 5px;">PHC: ${pair.player1.phc || 0}</span>
                            </div>
                        </div>
                        <div style="font-size: 0.7rem; line-height: 1.3; margin: 4px 0; padding: 3px; background: #f8f9fa; border-radius: 3px; border-left: 2px solid #e74c3c;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: bold; color: #2c3e50; flex: 1;">${player2Name}</span>
                                <span style="color: #7f8c8d; font-size: 0.6rem; margin-left: 5px;">PHC: ${pair.player2.phc || 0}</span>
                            </div>
                        </div>
                        
                        ${pairScore ? `
                            <!-- Compact Stats -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin: 6px 0; padding: 4px; background: #f8f9fa; border-radius: 3px; font-size: 0.6rem;">
                                <div style="text-align: center;">
                                    <div style="color: #7f8c8d; font-size: 0.55rem; margin-bottom: 1px;">Front 9</div>
                                    <div style="font-weight: bold; color: #2ecc71; font-size: 0.8rem;">${pairScore.front9Points}</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="color: #7f8c8d; font-size: 0.55rem; margin-bottom: 1px;">Back 9</div>
                                    <div style="font-weight: bold; color: #3498db; font-size: 0.8rem;">${pairScore.back9Points}</div>
                                </div>
                            </div>
                            <div style="font-size: 0.6rem; color: #7f8c8d; text-align: center; margin-top: 2px;">Gross: ${pairScore.totalGross}</div>
                        ` : ''}
                        
                        <!-- Money Input -->
                        <div style="margin-top: 6px; padding: 5px; background: #e8f6f3; border-radius: 3px; border: 1px solid #2ecc71;">
                            <div style="display: flex; align-items: center; gap: 5px; margin-bottom: 3px;">
                                <div style="font-size: 0.7rem; font-weight: bold; color: #27ae60;">üí∞ Prize:</div>
                                ${pairMoney > 0 ? 
                                    `<div style="font-size: 0.7rem; font-weight: bold; color: #27ae60; padding: 1px 4px; border-radius: 2px; background: #d4efdf; border: 1px solid #2ecc71;">¬£${pairMoney.toFixed(2)}</div>` : 
                                    `<div style="font-size: 0.6rem; color: #7f8c8d;">No money</div>`
                                }
                            </div>
                            <div style="display: flex; gap: 4px; align-items: center;">
                                <input type="text" 
                                       data-pair="${pair.id}"
                                       value="${pairMoney > 0 ? `¬£${pairMoney.toFixed(2)}` : ''}"
                                       style="flex: 1; padding: 3px; font-size: 0.7rem; text-align: center; border: 1px solid #ddd; border-radius: 2px;"
                                       placeholder="¬£0.00">
                                <button class="btn-success btn-small" onclick="app.saveSinglePairMoney(${pair.id})" style="font-size: 9px; padding: 3px 5px;">üíæ</button>
                            </div>
                        </div>
                        
                        <!-- Delete Button -->
                        <div class="player-actions" style="margin-top: 6px;">
                            <button class="btn-danger btn-small" onclick="app.deletePair(${pair.id})" style="font-size: 9px; padding: 2px 5px;">üóëÔ∏è Delete</button>
                        </div>
                    `;
                    
                    container.querySelector('.pairs-grid').appendChild(card);
                });
                
                container.innerHTML += '</div>';
            },
            
            getScoreColor(points) {
                if (points >= 40) return '#2ecc71'; // Green for excellent
                if (points >= 36) return '#3498db'; // Blue for good
                if (points >= 32) return '#f39c12'; // Orange for average
                return '#e74c3c'; // Red for below average
            },
            
            saveSinglePairMoney(pairId) {
                const input = document.querySelector(`input[data-pair="${pairId}"]`);
                if (!input) return;
                
                const value = input.value.trim();
                if (value === '') {
                    delete this.pairsMoney[pairId];
                } else {
                    // Parse the value, removing any currency symbol
                    const cleanedValue = value.replace(/[^0-9.-]+/g, '');
                    const moneyValue = parseFloat(cleanedValue) || 0;
                    this.pairsMoney[pairId] = moneyValue;
                    input.value = `¬£${moneyValue.toFixed(2)}`;
                }
                
                this.saveData();
                this.showToast('Money saved for pair', 'success');
            },
            
            randomDrawPairs() {
                // Check if course is selected
                const courseSelect = document.getElementById('pairsCourseSelect');
                const selectedCourse = courseSelect.value;
                
                if (!selectedCourse) {
                    this.showToast('Please select a course first', 'warning');
                    return;
                }
                
                // Get players assigned to the selected course who have scores - case insensitive
                const coursePlayers = this.players.filter(player => {
                    if (!player.course || !selectedCourse) return false;
                    if (player.course.toLowerCase() !== selectedCourse.toLowerCase()) return false;
                    
                    // Check if player has any scores entered
                    const playerScores = this.scores[player.id] || {};
                    const hasScores = Object.keys(playerScores).some(hole => {
                        const score = playerScores[hole];
                        return score !== undefined && score !== null && score !== '' && score !== 0;
                    });
                    
                    return hasScores;
                });
                
                if (coursePlayers.length < 2) {
                    this.showToast(`Need at least 2 players assigned to ${selectedCourse} for pairs`, 'warning');
                    return;
                }
                
                // Check if we already have pairs for this course
                if (this.pairsCourseGenerated === selectedCourse && this.pairs.length > 0) {
                    if (!confirm(`Pairs already exist for ${selectedCourse}. Create new pairs? This will clear existing pairs, scores, and money.`)) {
                        return;
                    }
                }
                
                const shuffledPlayers = [...coursePlayers].sort(() => Math.random() - 0.5);
                this.pairs = [];
                this.pairsScores = {}; // Clear existing scores
                this.pairsMoney = {}; // Clear existing money
                this.pairsCourseGenerated = selectedCourse; // Track which course was used
                
                for (let i = 0; i < shuffledPlayers.length; i += 2) {
                    if (i + 1 < shuffledPlayers.length) {
                        const pair = {
                            id: Date.now() + i,
                            player1: shuffledPlayers[i],
                            player2: shuffledPlayers[i + 1],
                            date: new Date().toISOString(),
                            course: selectedCourse
                        };
                        this.pairs.push(pair);
                    }
                }
                
                this.saveData();
                this.renderPairs();
                this.showToast(`Created ${this.pairs.length} pairs from ${selectedCourse}!`, 'success');
            },
            
            deletePair(pairId) {
                if (!confirm('Delete this pair?')) return;
                
                const index = this.pairs.findIndex(p => p.id === pairId);
                if (index === -1) return;
                
                delete this.pairsScores[pairId];
                delete this.pairsMoney[pairId];
                this.pairs.splice(index, 1);
                
                // If no more pairs, clear the course tracking
                if (this.pairs.length === 0) {
                    this.pairsCourseGenerated = '';
                }
                
                this.saveData();
                this.renderPairs();
                
                this.showToast('Pair deleted', 'warning');
            },
            
            // MASTER LEADERBOARD FUNCTIONS - COMPLETELY REWRITTEN TO FIX DOUBLE-COUNTING
            createMasterLeaderboard() {
                if (this.players.length === 0) {
                    this.showToast('No players added yet', 'warning');
                    return;
                }
                
                console.log('=== Creating Master Leaderboard ===');
                
                // Clear existing master leaderboard data
                this.masterLeaderboardData = [];
                
                // Group players by NAME to ensure each player appears only once
                const playerResults = new Map();
                
                // Create a map to track which player IDs we've processed for each course
                const processedPlayerCourses = new Set();
                
                // Process each player instance
                this.players.forEach(player => {
                    // Use player name as the key to group same players together
                    const playerKey = player.name.toLowerCase().trim();
                    
                    // Create unique key for this player-course combination
                    const playerCourseKey = `${player.id}_${player.course}`;
                    
                    // Skip if we've already processed this exact player-course combination
                    if (processedPlayerCourses.has(playerCourseKey)) {
                        console.log(`Skipping duplicate: ${player.name} - ${player.course}`);
                        return;
                    }
                    
                    // Initialize player result if not exists
                    if (!playerResults.has(playerKey)) {
                        playerResults.set(playerKey, {
                            playerId: player.id,
                            playerName: player.name,
                            courses: [],  // Use array for simplicity
                            combinedTotalGross: 0,
                            combinedTotalPoints: 0
                        });
                    }
                    
                    const playerResult = playerResults.get(playerKey);
                    
                    // Only process if player has a course assigned
                    if (player.course) {
                        // Case-insensitive course name matching
                        const course = this.courses.find(c => 
                            c.name && player.course && 
                            c.name.toLowerCase() === player.course.toLowerCase()
                        );
                        if (course) {
                            const playerScores = this.scores[player.id] || {};
                            let hasScores = false;
                            let totalGross = 0;
                            let totalPoints = 0;
                            
                            // Calculate scores for this course
                            for (let i = 1; i <= 18; i++) {
                                const score = playerScores[i];
                                if (score !== undefined && score !== null && score !== '' && score !== 0) {
                                    const hole = course.holes.find(h => h.number === i);
                                    if (hole) {
                                        hasScores = true;
                                        const scoreNum = parseInt(score);
                                        const stablefordResult = this.calculateStablefordWithResult(
                                            scoreNum, 
                                            hole.par, 
                                            player.phc,
                                            hole.index
                                        );
                                        
                                        totalGross += scoreNum;
                                        totalPoints += stablefordResult.points;
                                    }
                                }
                            }
                            
                            if (hasScores) {
                                console.log(`${player.name} at ${course.name}: Gross=${totalGross}, Points=${totalPoints}`);
                                
                                // Add this course data
                                playerResult.courses.push({
                                    courseName: course.name,
                                    totalGross: totalGross,
                                    totalPoints: totalPoints
                                });
                                
                                // Update combined totals
                                playerResult.combinedTotalGross += totalGross;
                                playerResult.combinedTotalPoints += totalPoints;
                                
                                // Mark this player-course combination as processed
                                processedPlayerCourses.add(playerCourseKey);
                            }
                        }
                    }
                });
                
                // Convert Map to Array and filter out players with no scores
                this.masterLeaderboardData = Array.from(playerResults.values())
                    .filter(player => player.courses.length > 0);
                
                if (this.masterLeaderboardData.length === 0) {
                    this.showToast('No scores found for any players', 'warning');
                    return;
                }
                
                // Log final results for debugging
                this.masterLeaderboardData.forEach(player => {
                    console.log(`${player.playerName}: Combined Gross=${player.combinedTotalGross}, Combined Points=${player.combinedTotalPoints}`);
                });
                
                // Sort by combined total points (descending) - Priority order based on Combined TOT P
                this.masterLeaderboardData.sort((a, b) => b.combinedTotalPoints - a.combinedTotalPoints);
                
                this.saveData();
                this.renderMasterLeaderboard();
                this.showToast('Master Leaderboard created!', 'success');
            },
            
            refreshMasterLeaderboard() {
                console.log('=== Refresh Master Leaderboard button clicked ===');
                this.createMasterLeaderboard();
            },
            
            renderMasterLeaderboard() {
                const container = document.getElementById('masterLeaderboardContent');
                const masterContainer = document.getElementById('masterLeaderboardContainer');
                
                if (this.masterLeaderboardData.length === 0) {
                    container.innerHTML = `
                        <div class="empty-message">
                            <h3>No master leaderboard data</h3>
                            <p>Click "Create Master Leaderboard" to generate combined results.</p>
                        </div>
                    `;
                    masterContainer.style.display = 'block';
                    return;
                }
                
                // Show the master leaderboard container
                masterContainer.style.display = 'block';
                
                // Restore currency selection
                const currencySelect = document.getElementById('masterLeaderboardCurrency');
                if (currencySelect) {
                    currencySelect.value = this.masterLeaderboardCurrency;
                }
                
                // Create the table with Money column
                let html = `
                    <div class="scorecard-container">
                        <table class="master-leaderboard-table">
                            <thead>
                                <tr>
                                    <th class="position-header">Pos</th>
                                    <th class="player-header">Players</th>
                                    <th class="courses-header">Courses Played</th>
                                    <th class="combined-gross-header">Combined TOT G</th>
                                    <th class="combined-points-header">Combined TOT P</th>
                                    <th style="background: #27ae60; color: white;">Money</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                this.masterLeaderboardData.forEach((playerData, index) => {
                    const position = index + 1;
                    
                    // Add position symbols/medals
                    let positionDisplay = '';
                    let positionClass = '';
                    if (position === 1) {
                        positionDisplay = 'ü•á 1st';
                        positionClass = 'style="background: #fef9e7;"';
                    } else if (position === 2) {
                        positionDisplay = 'ü•à 2nd';
                        positionClass = 'style="background: #f8f9fa;"';
                    } else if (position === 3) {
                        positionDisplay = 'ü•â 3rd';
                        positionClass = 'style="background: #f5f5f5;"';
                    } else if (position === 4) {
                        positionDisplay = 'üèÖ 4th';
                        positionClass = '';
                    } else {
                        positionDisplay = position;
                        positionClass = '';
                    }
                    
                    // Courses played list - show course names and their Gross Score / Stableford separately
                    let coursesPlayedHtml = '';
                    const sortedCourses = playerData.courses.sort((a, b) => a.courseName.localeCompare(b.courseName));
                    
                    sortedCourses.forEach((course, courseIndex) => {
                        coursesPlayedHtml += `
                            <div class="course-name-item" style="padding: 4px 0; border-bottom: 1px solid #eee;">
                                <div style="font-weight: 600; margin-bottom: 2px; color: #2c3e50;">${course.courseName}</div>
                                <div style="display: flex; justify-content: space-between; font-size: 9px;">
                                    <span style="color: #7f8c8d;">Gross:</span>
                                    <span class="course-total-gross" style="font-weight: bold; color: #2c3e50;">${course.totalGross}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 9px;">
                                    <span style="color: #7f8c8d;">Stableford:</span>
                                    <span class="course-total-points" style="font-weight: bold; color: #2ecc71;">${course.totalPoints}</span>
                                </div>
                            </div>
                        `;
                    });
                    
                    // Get money value for this player
                    const moneyValue = this.masterLeaderboardMoney[playerData.playerName] || '';
                    const displayMoney = moneyValue ? `${this.masterLeaderboardCurrency}${parseFloat(moneyValue).toFixed(2)}` : '';
                    
                    html += `
                        <tr ${positionClass}>
                            <td class="position-col">${positionDisplay}</td>
                            <td class="player-col" style="font-weight: bold;">${playerData.playerName}</td>
                            <td class="courses-col">
                                <div class="course-names-list">${coursesPlayedHtml}</div>
                            </td>
                            <td class="combined-col combined-gross" style="color: white;">${playerData.combinedTotalGross}</td>
                            <td class="combined-col combined-points" style="color: white;">${playerData.combinedTotalPoints}</td>
                            <td style="padding: 4px; text-align: center; width: 70px;">
                                <input type="text" 
                                       class="master-money-input" 
                                       data-player="${playerData.playerName}"
                                       value="${displayMoney}"
                                       placeholder="${this.masterLeaderboardCurrency}0"
                                       style="width: 60px; padding: 2px; text-align: center; border: 1px solid #ddd; border-radius: 2px; font-size: 9px;">
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                container.innerHTML = html;
                
                // Setup money input listeners
                this.setupMasterMoneyInputListeners();
            },
            
            setupMasterMoneyInputListeners() {
                document.querySelectorAll('.master-money-input').forEach(input => {
                    input.addEventListener('input', (e) => {
                        // Format the input to ensure it's a valid number
                        const value = e.target.value.replace(/[^0-9.-]/g, '');
                        if (value !== e.target.value) {
                            e.target.value = value;
                        }
                    });
                    
                    input.addEventListener('blur', (e) => {
                        // Add currency symbol when losing focus
                        const value = e.target.value.trim();
                        if (value) {
                            const numValue = parseFloat(value) || 0;
                            const currency = this.masterLeaderboardCurrency;
                            e.target.value = `${currency}${numValue.toFixed(2)}`;
                            
                            // Save the value
                            const playerName = e.target.dataset.player;
                            this.masterLeaderboardMoney[playerName] = numValue;
                            this.saveData();
                        }
                    });
                    
                    input.addEventListener('focus', (e) => {
                        // Remove currency symbol when focusing for editing
                        const value = e.target.value.replace(/[^0-9.-]/g, '');
                        e.target.value = value;
                        setTimeout(() => e.target.select(), 10);
                    });
                    
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.target.blur();
                        }
                    });
                });
            },
            
            saveMasterMoneyData() {
                // Find all money inputs and save their values
                const moneyInputs = document.querySelectorAll('.master-money-input');
                moneyInputs.forEach(input => {
                    const playerName = input.dataset.player;
                    const value = input.value.trim();
                    
                    if (value === '') {
                        delete this.masterLeaderboardMoney[playerName];
                    } else {
                        // Parse the value, removing any currency symbol
                        const cleanedValue = value.replace(/[^0-9.-]+/g, '');
                        const moneyValue = parseFloat(cleanedValue) || 0;
                        this.masterLeaderboardMoney[playerName] = moneyValue;
                    }
                });
                
                this.saveData();
            },
            
            // Comps Functions
            showCreateTeamModal(compType) {
                this.currentCompType = compType;
                
                // Set modal title based on comp type
                let title = '';
                switch(compType) {
                    case '4BBB': title = 'Create 4 Ball Better Ball (4BBB) Teams'; break;
                    case '4PersonTeam': title = 'Create 4 Person Team (All Scores Count)'; break;
                    case 'Best3From4': title = 'Create Best 3 from 4 Teams'; break;
                }
                
                document.getElementById('teamModalTitle').textContent = title;
                
                // Populate course dropdown
                const courseSelect = document.getElementById('teamCourseSelect');
                courseSelect.innerHTML = '<option value="">Select course...</option>';
                this.courses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course.name;
                    option.textContent = course.name;
                    courseSelect.appendChild(option);
                });
                
                // Reset money input
                document.getElementById('teamMoneyValue').value = '';
                document.getElementById('teamCurrency').value = '¬£';
                document.getElementById('teamCurrencySymbol').textContent = '¬£';
                
                document.getElementById('createTeamModal').style.display = 'flex';
            },
            
            hideCreateTeamModal() {
                document.getElementById('createTeamModal').style.display = 'none';
                this.currentCompType = null;
            },
            
            showManualTeamModal(compType) {
                this.currentCompType = compType;
                
                // Set modal title and player requirement based on comp type
                let title = '';
                let playersRequired = 2;
                switch(compType) {
                    case '4BBB': 
                        title = 'Create 4BBB Team Manually';
                        playersRequired = 2;
                        break;
                    case '4PersonTeam': 
                        title = 'Create 4 Person Team Manually';
                        playersRequired = 4;
                        break;
                    case 'Best3From4': 
                        title = 'Create Best 3 from 4 Team Manually';
                        playersRequired = 4;
                        break;
                }
                
                document.getElementById('manualTeamModalTitle').textContent = title;
                document.getElementById('manualTeamPlayersRequired').textContent = playersRequired;
                
                // Populate course dropdown
                const courseSelect = document.getElementById('manualTeamCourseSelect');
                courseSelect.innerHTML = '<option value="">Select course...</option>';
                this.courses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course.name;
                    option.textContent = course.name;
                    courseSelect.appendChild(option);
                });
                
                // Reset other fields
                document.getElementById('manualTeamName').value = '';
                document.getElementById('manualTeamGroupSelect').value = '';
                document.getElementById('manualTeamMoneyValue').value = '';
                document.getElementById('manualTeamCurrency').value = '¬£';
                document.getElementById('manualTeamCurrencySymbol').textContent = '¬£';
                
                // Clear player selection
                document.getElementById('manualTeamPlayersSelection').innerHTML = '<p style="text-align: center; color: #7f8c8d; font-size: 0.9rem;">Please select a course first</p>';
                
                document.getElementById('manualTeamModal').style.display = 'flex';
            },
            
            hideManualTeamModal() {
                document.getElementById('manualTeamModal').style.display = 'none';
                this.currentCompType = null;
            },
            
            populateManualTeamGroups() {
                const courseName = document.getElementById('manualTeamCourseSelect').value;
                const groupSelect = document.getElementById('manualTeamGroupSelect');
                
                // Populate group dropdown
                groupSelect.innerHTML = '<option value="">No Group</option>';
                
                if (courseName) {
                    const groups = this.getGroupsForCourse(courseName);
                    groups.forEach(group => {
                        const option = document.createElement('option');
                        option.value = group;
                        option.textContent = `Group ${group}`;
                        groupSelect.appendChild(option);
                    });
                }
                
                // Populate player checkboxes
                this.populateManualTeamPlayers();
            },
            
            populateManualTeamPlayers() {
                const courseName = document.getElementById('manualTeamCourseSelect').value;
                const container = document.getElementById('manualTeamPlayersSelection');
                
                if (!courseName) {
                    container.innerHTML = '<p style="text-align: center; color: #7f8c8d; font-size: 0.9rem;">Please select a course first</p>';
                    return;
                }
                
                // Case-insensitive course matching
                const eligiblePlayers = this.players.filter(p => 
                    p.course && courseName && 
                    p.course.toLowerCase() === courseName.toLowerCase()
                );
                
                if (eligiblePlayers.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #7f8c8d; font-size: 0.9rem;">No players assigned to this course</p>';
                    return;
                }
                
                container.innerHTML = '';
                eligiblePlayers.forEach(player => {
                    const checkDiv = document.createElement('div');
                    checkDiv.style.cssText = 'margin-bottom: 8px; padding: 8px; background: white; border-radius: 3px; border: 1px solid #e0e0e0;';
                    checkDiv.innerHTML = `
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" class="manual-team-player-checkbox" value="${player.id}" style="margin-right: 8px;">
                            <div>
                                <div style="font-weight: bold; font-size: 0.9rem;">${player.name}</div>
                                <div style="font-size: 0.7rem; color: #7f8c8d;">PHC: ${player.phc || 0} | ${player.group || 'No Group'}</div>
                            </div>
                        </label>
                    `;
                    container.appendChild(checkDiv);
                });
            },
            
            confirmManualTeam() {
                const teamName = document.getElementById('manualTeamName').value.trim();
                const courseName = document.getElementById('manualTeamCourseSelect').value;
                const group = document.getElementById('manualTeamGroupSelect').value;
                const currency = document.getElementById('manualTeamCurrency').value;
                const moneyValue = parseFloat(document.getElementById('manualTeamMoneyValue').value) || 0;
                
                if (!teamName) {
                    this.showToast('Please enter a team name', 'error');
                    return;
                }
                
                if (!courseName) {
                    this.showToast('Please select a course', 'error');
                    return;
                }
                
                // Get selected players
                const checkboxes = document.querySelectorAll('.manual-team-player-checkbox:checked');
                const selectedPlayers = Array.from(checkboxes).map(cb => {
                    const playerId = parseInt(cb.value);
                    return this.players.find(p => p.id === playerId);
                }).filter(p => p);
                
                // Validate player count based on comp type
                let requiredPlayers = 2;
                if (this.currentCompType === '4PersonTeam' || this.currentCompType === 'Best3From4' || this.currentCompType === 'MixedScore') {
                    requiredPlayers = 4;
                }
                
                if (selectedPlayers.length !== requiredPlayers) {
                    this.showToast(`Please select exactly ${requiredPlayers} players`, 'error');
                    return;
                }
                
                // Create team
                const team = {
                    id: Date.now(),
                    name: teamName,
                    players: selectedPlayers,
                    course: courseName,
                    currency: currency,
                    money: moneyValue,
                    group: group || '',
                    date: new Date().toISOString(),
                    scores: {},
                    totalPoints: 0,
                    totalGross: 0,
                    front9Points: 0,
                    back9Points: 0
                };
                
                // Add to appropriate comps array
                switch(this.currentCompType) {
                    case '4BBB':
                        this.comps.fourBBB.push(team);
                        break;
                    case '4PersonTeam':
                        this.comps.fourPersonTeams.push(team);
                        break;
                    case 'Best3From4':
                        this.comps.best3From4.push(team);
                        break;
                    case 'MixedScore':
                        this.comps.mixedScore.push(team);
                        break;
                }
                
                this.saveData();
                this.hideManualTeamModal();
                this.renderCompsResults();
                
                const compName = this.currentCompType === '4BBB' ? '4BBB' : 
                                this.currentCompType === '4PersonTeam' ? '4 Person Team' : 
                                this.currentCompType === 'Best3From4' ? 'Best 3 from 4' :
                                'Mixed Score';
                this.showToast(`${compName} team "${teamName}" created!`, 'success');
            },
            
            createTeam() {
                const courseName = document.getElementById('teamCourseSelect').value;
                const currency = document.getElementById('teamCurrency').value;
                const moneyValue = parseFloat(document.getElementById('teamMoneyValue').value) || 0;
                
                if (!courseName) {
                    this.showToast('Please select a course', 'error');
                    return;
                }
                
                let minPlayers = 2;
                if (this.currentCompType === '4PersonTeam' || this.currentCompType === 'Best3From4' || this.currentCompType === 'MixedScore') {
                    minPlayers = 4;
                }
                
                if (this.players.length < minPlayers) {
                    this.showToast(`Need at least ${minPlayers} players for this competition`, 'warning');
                    return;
                }
                
                // Check if course exists - case insensitive
                const course = this.courses.find(c => 
                    c.name && courseName && 
                    c.name.toLowerCase() === courseName.toLowerCase()
                );
                if (!course) {
                    this.showToast(`Course "${courseName}" not found`, 'error');
                    return;
                }
                
                // Filter players by course - case insensitive
                let eligiblePlayers = this.players.filter(p => 
                    p.course && courseName && 
                    p.course.toLowerCase() === courseName.toLowerCase()
                );
                
                if (eligiblePlayers.length < minPlayers) {
                    this.showToast(`Need at least ${minPlayers} players assigned to ${courseName}`, 'warning');
                    return;
                }
                
                // Shuffle players
                const shuffledPlayers = [...eligiblePlayers].sort(() => Math.random() - 0.5);
                
                // Create teams based on comp type
                let teams = [];
                let teamSize = 2;
                
                if (this.currentCompType === '4BBB') {
                    teamSize = 2;
                    for (let i = 0; i < shuffledPlayers.length; i += teamSize) {
                        if (i + 1 < shuffledPlayers.length) {
                            // MODIFIED: Group every 2 teams together (teams 1-2 in Group 1, 3-4 in Group 2, etc.)
                            const groupNumber = Math.floor(i/(teamSize*2)) + 1;
                            const team = {
                                id: Date.now() + i,
                                name: `4BBB Team ${Math.floor(i/teamSize) + 1}`,
                                players: [shuffledPlayers[i], shuffledPlayers[i + 1]],
                                course: courseName,
                                currency: currency,
                                money: moneyValue,
                                group: `Group ${groupNumber}`,
                                date: new Date().toISOString(),
                                scores: {},
                                totalPoints: 0,
                                totalGross: 0
                            };
                            teams.push(team);
                        }
                    }
                    this.comps.fourBBB = teams;
                }
                else if (this.currentCompType === '4PersonTeam') {
                    teamSize = 4;
                    for (let i = 0; i < shuffledPlayers.length; i += teamSize) {
                        if (i + 3 < shuffledPlayers.length) {
                            const groupNumber = Math.floor(i/(teamSize)) + 1; // Group every team separately
                            const team = {
                                id: Date.now() + i,
                                name: `4 Person Team ${Math.floor(i/teamSize) + 1}`,
                                players: [shuffledPlayers[i], shuffledPlayers[i+1], shuffledPlayers[i+2], shuffledPlayers[i+3]],
                                course: courseName,
                                currency: currency,
                                money: moneyValue,
                                group: `Group ${groupNumber}`,
                                date: new Date().toISOString(),
                                scores: {},
                                totalPoints: 0,
                                totalGross: 0
                            };
                            teams.push(team);
                        }
                    }
                    this.comps.fourPersonTeams = teams;
                }
                else if (this.currentCompType === 'Best3From4') {
                    teamSize = 4;
                    for (let i = 0; i < shuffledPlayers.length; i += teamSize) {
                        if (i + 3 < shuffledPlayers.length) {
                            const groupNumber = Math.floor(i/(teamSize)) + 1; // Group every team separately
                            const team = {
                                id: Date.now() + i,
                                name: `Best 3 from 4 Team ${Math.floor(i/teamSize) + 1}`,
                                players: [shuffledPlayers[i], shuffledPlayers[i+1], shuffledPlayers[i+2], shuffledPlayers[i+3]],
                                course: courseName,
                                currency: currency,
                                money: moneyValue,
                                group: `Group ${groupNumber}`,
                                date: new Date().toISOString(),
                                scores: {},
                                totalPoints: 0,
                                totalGross: 0
                            };
                            teams.push(team);
                        }
                    }
                    this.comps.best3From4 = teams;
                }
                else if (this.currentCompType === 'MixedScore') {
                    teamSize = 4;
                    for (let i = 0; i < shuffledPlayers.length; i += teamSize) {
                        if (i + 3 < shuffledPlayers.length) {
                            const groupNumber = Math.floor(i/(teamSize)) + 1;
                            const team = {
                                id: Date.now() + i,
                                name: `Mixed Score Team ${Math.floor(i/teamSize) + 1}`,
                                players: [shuffledPlayers[i], shuffledPlayers[i+1], shuffledPlayers[i+2], shuffledPlayers[i+3]],
                                course: courseName,
                                currency: currency,
                                money: moneyValue,
                                group: `Group ${groupNumber}`,
                                date: new Date().toISOString(),
                                scores: {},
                                totalPoints: 0,
                                totalGross: 0
                            };
                            teams.push(team);
                        }
                    }
                    this.comps.mixedScore = teams;
                }
                
                this.saveData();
                this.hideCreateTeamModal();
                this.renderCompsResults();
                
                const compName = this.currentCompType === '4BBB' ? '4BBB' : 
                                this.currentCompType === '4PersonTeam' ? '4 Person Team' : 
                                this.currentCompType === 'Best3From4' ? 'Best 3 from 4' :
                                'Mixed Score';
                const currencySymbol = currency || '';
                this.showToast(`Created ${teams.length} ${compName} teams${moneyValue > 0 ? ` with ${currencySymbol}${moneyValue} each` : ''}!`, 'success');
            },
            
            showEditTeamModal(team, teamType) {
                this.currentEditTeam = team;
                this.currentEditTeamType = teamType;
                
                // Set modal title
                let title = '';
                switch(teamType) {
                    case '4BBB': title = 'Edit 4BBB Team'; break;
                    case '4PersonTeam': title = 'Edit 4 Person Team'; break;
                    case 'Best3From4': title = 'Edit Best 3 from 4 Team'; break;
                    case 'MixedScore': title = 'Edit Mixed Score Team'; break;
                }
                document.getElementById('editTeamModalTitle').textContent = title;
                
                // Set currency and money values
                document.getElementById('editTeamCurrency').value = team.currency || '¬£';
                document.getElementById('editTeamCurrencySymbol').textContent = team.currency || '¬£';
                document.getElementById('editTeamMoneyValue').value = team.money || 0;
                
                // Display players
                const playersContainer = document.getElementById('editTeamPlayersContainer');
                playersContainer.innerHTML = '<h4 style="margin-bottom: 8px; font-size: 0.9rem;">Players:</h4>';
                
                team.players.forEach((player, index) => {
                    const playerDiv = document.createElement('div');
                    playerDiv.style.cssText = 'padding: 6px; margin-bottom: 5px; background: #f8f9fa; border-radius: 3px; border-left: 3px solid #3498db; font-size: 0.8rem;';
                    playerDiv.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: bold;">${player.name}</span>
                            <span style="color: #7f8c8d; font-size: 0.7rem;">PHC: ${player.phc || 0}</span>
                        </div>
                        <div style="color: #7f8c8d; font-size: 0.7rem; margin-top: 2px;">
                            Course: ${player.course || 'Not assigned'} | Group: ${player.group || 'None'}
                        </div>
                    `;
                    playersContainer.appendChild(playerDiv);
                });
                
                document.getElementById('editTeamModal').style.display = 'flex';
            },
            
            hideEditTeamModal() {
                document.getElementById('editTeamModal').style.display = 'none';
                this.currentEditTeam = null;
                this.currentEditTeamType = null;
            },
            
            saveEditedTeam() {
                if (!this.currentEditTeam || !this.currentEditTeamType) return;
                
                const currency = document.getElementById('editTeamCurrency').value;
                const moneyValue = parseFloat(document.getElementById('editTeamMoneyValue').value) || 0;
                
                // Update team
                this.currentEditTeam.currency = currency;
                this.currentEditTeam.money = moneyValue;
                
                // Save to appropriate comps array
                switch(this.currentEditTeamType) {
                    case '4BBB':
                        const fourBBBIndex = this.comps.fourBBB.findIndex(t => t.id === this.currentEditTeam.id);
                        if (fourBBBIndex !== -1) {
                            this.comps.fourBBB[fourBBBIndex] = this.currentEditTeam;
                        }
                        break;
                    case '4PersonTeam':
                        const fourPersonIndex = this.comps.fourPersonTeams.findIndex(t => t.id === this.currentEditTeam.id);
                        if (fourPersonIndex !== -1) {
                            this.comps.fourPersonTeams[fourPersonIndex] = this.currentEditTeam;
                        }
                        break;
                    case 'Best3From4':
                        const best3From4Index = this.comps.best3From4.findIndex(t => t.id === this.currentEditTeam.id);
                        if (best3From4Index !== -1) {
                            this.comps.best3From4[best3From4Index] = this.currentEditTeam;
                        }
                        break;
                    case 'MixedScore':
                        const mixedScoreIndex = this.comps.mixedScore.findIndex(t => t.id === this.currentEditTeam.id);
                        if (mixedScoreIndex !== -1) {
                            this.comps.mixedScore[mixedScoreIndex] = this.currentEditTeam;
                        }
                        break;
                }
                
                this.saveData();
                this.hideEditTeamModal();
                this.renderCompsResults();
                this.showToast('Team updated successfully!', 'success');
            },
            
            deleteEditedTeam() {
                if (!this.currentEditTeam || !this.currentEditTeamType || !confirm('Delete this team?')) return;
                
                // Remove from appropriate comps array
                switch(this.currentEditTeamType) {
                    case '4BBB':
                        this.comps.fourBBB = this.comps.fourBBB.filter(t => t.id !== this.currentEditTeam.id);
                        break;
                    case '4PersonTeam':
                        this.comps.fourPersonTeams = this.comps.fourPersonTeams.filter(t => t.id !== this.currentEditTeam.id);
                        break;
                    case 'Best3From4':
                        this.comps.best3From4 = this.comps.best3From4.filter(t => t.id !== this.currentEditTeam.id);
                        break;
                    case 'MixedScore':
                        this.comps.mixedScore = this.comps.mixedScore.filter(t => t.id !== this.currentEditTeam.id);
                        break;
                }
                
                this.saveData();
                this.hideEditTeamModal();
                this.renderCompsResults();
                this.showToast('Team deleted', 'warning');
            },
            
            showEditAllCompsModal() {
                document.getElementById('editAllCurrency').value = '¬£';
                
                const container = document.getElementById('editAllCompsContainer');
                container.innerHTML = '';
                
                let hasTeams = false;
                
                // 4BBB Teams
                if (this.comps.fourBBB.length > 0) {
                    hasTeams = true;
                    const section = document.createElement('div');
                    section.style.cssText = 'margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;';
                    section.innerHTML = `<h4 style="margin-bottom: 8px; color: #2c3e50; font-size: 0.9rem;">4BBB Teams (${this.comps.fourBBB.length})</h4>`;
                    
                    this.comps.fourBBB.forEach((team, index) => {
                        const teamDiv = document.createElement('div');
                        teamDiv.style.cssText = 'padding: 8px; margin-bottom: 8px; background: white; border-radius: 3px; border: 1px solid #e0e0e0;';
                        teamDiv.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <div>
                                    <strong style="font-size: 0.8rem;">${team.name}</strong>
                                    <span style="font-size: 0.7rem; color: #7f8c8d; margin-left: 8px;">${team.group || 'No Group'}</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="font-size: 0.7rem; color: #7f8c8d;">${team.players.length} players</div>
                                    <button onclick="app.showEditTeamModal(${JSON.stringify(team).replace(/"/g, '&quot;')}, '4BBB')" class="btn-secondary btn-small" style="font-size: 9px; padding: 2px 5px;">‚úèÔ∏è Edit</button>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="font-size: 0.7rem; min-width: 60px;">Money:</label>
                                <div style="display: flex; align-items: center; gap: 3px;">
                                    <span class="edit-all-currency-symbol" style="font-size: 0.8rem;">${team.currency || '¬£'}</span>
                                    <input type="number" 
                                           data-team-id="${team.id}"
                                           data-team-type="4BBB"
                                           step="0.01" 
                                           min="0" 
                                           value="${team.money || 0}" 
                                           style="padding: 3px; font-size: 0.8rem; width: 80px; text-align: center; border: 1px solid #ddd; border-radius: 2px;">
                                </div>
                            </div>
                        `;
                        section.appendChild(teamDiv);
                    });
                    
                    container.appendChild(section);
                }
                
                // 4 Person Teams
                if (this.comps.fourPersonTeams.length > 0) {
                    hasTeams = true;
                    const section = document.createElement('div');
                    section.style.cssText = 'margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;';
                    section.innerHTML = `<h4 style="margin-bottom: 8px; color: #2c3e50; font-size: 0.9rem;">4 Person Teams (${this.comps.fourPersonTeams.length})</h4>`;
                    
                    this.comps.fourPersonTeams.forEach((team, index) => {
                        const teamDiv = document.createElement('div');
                        teamDiv.style.cssText = 'padding: 8px; margin-bottom: 8px; background: white; border-radius: 3px; border: 1px solid #e0e0e0;';
                        teamDiv.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <div>
                                    <strong style="font-size: 0.8rem;">${team.name}</strong>
                                    <span style="font-size: 0.7rem; color: #7f8c8d; margin-left: 8px;">${team.group || 'No Group'}</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="font-size: 0.7rem; color: #7f8c8d;">${team.players.length} players</div>
                                    <button onclick="app.showEditTeamModal(${JSON.stringify(team).replace(/"/g, '&quot;')}, '4PersonTeam')" class="btn-secondary btn-small" style="font-size: 9px; padding: 2px 5px;">‚úèÔ∏è Edit</button>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="font-size: 0.7rem; min-width: 60px;">Money:</label>
                                <div style="display: flex; align-items: center; gap: 3px;">
                                    <span class="edit-all-currency-symbol" style="font-size: 0.8rem;">${team.currency || '¬£'}</span>
                                    <input type="number" 
                                           data-team-id="${team.id}"
                                           data-team-type="4PersonTeam"
                                           step="0.01" 
                                           min="0" 
                                           value="${team.money || 0}" 
                                           style="padding: 3px; font-size: 0.8rem; width: 80px; text-align: center; border: 1px solid #ddd; border-radius: 2px;">
                                </div>
                            </div>
                        `;
                        section.appendChild(teamDiv);
                    });
                    
                    container.appendChild(section);
                }
                
                // Best 3 from 4 Teams
                if (this.comps.best3From4.length > 0) {
                    hasTeams = true;
                    const section = document.createElement('div');
                    section.style.cssText = 'margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;';
                    section.innerHTML = `<h4 style="margin-bottom: 8px; color: #2c3e50; font-size: 0.9rem;">Best 3 from 4 Teams (${this.comps.best3From4.length})</h4>`;
                    
                    this.comps.best3From4.forEach((team, index) => {
                        const teamDiv = document.createElement('div');
                        teamDiv.style.cssText = 'padding: 8px; margin-bottom: 8px; background: white; border-radius: 3px; border: 1px solid #e0e0e0;';
                        teamDiv.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <div>
                                    <strong style="font-size: 0.8rem;">${team.name}</strong>
                                    <span style="font-size: 0.7rem; color: #7f8c8d; margin-left: 8px;">${team.group || 'No Group'}</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="font-size: 0.7rem; color: #7f8c8d;">${team.players.length} players</div>
                                    <button onclick="app.showEditTeamModal(${JSON.stringify(team).replace(/"/g, '&quot;')}, 'Best3From4')" class="btn-secondary btn-small" style="font-size: 9px; padding: 2px 5px;">‚úèÔ∏è Edit</button>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="font-size: 0.7rem; min-width: 60px;">Money:</label>
                                <div style="display: flex; align-items: center; gap: 3px;">
                                    <span class="edit-all-currency-symbol" style="font-size: 0.8rem;">${team.currency || '¬£'}</span>
                                    <input type="number" 
                                           data-team-id="${team.id}"
                                           data-team-type="Best3From4"
                                           step="0.01" 
                                           min="0" 
                                           value="${team.money || 0}" 
                                           style="padding: 3px; font-size: 0.8rem; width: 80px; text-align: center; border: 1px solid #ddd; border-radius: 2px;">
                                </div>
                            </div>
                        `;
                        section.appendChild(teamDiv);
                    });
                    
                    container.appendChild(section);
                }
                
                if (!hasTeams) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #7f8c8d; background: #f8f9fa; border-radius: 3px;">
                            <p>No teams created yet. Create teams first.</p>
                        </div>
                    `;
                }
                
                document.getElementById('editAllCompsModal').style.display = 'flex';
            },
            
            hideEditAllCompsModal() {
                document.getElementById('editAllCompsModal').style.display = 'none';
            },
            
            saveAllCompsChanges() {
                const currency = document.getElementById('editAllCurrency').value;
                
                // Update all money inputs
                const moneyInputs = document.querySelectorAll('#editAllCompsContainer input[type="number"]');
                let updatedCount = 0;
                
                moneyInputs.forEach(input => {
                    const teamId = parseInt(input.dataset.teamId);
                    const teamType = input.dataset.teamType;
                    const moneyValue = parseFloat(input.value) || 0;
                    
                    // Find and update team
                    let teamArray;
                    switch(teamType) {
                        case '4BBB': teamArray = this.comps.fourBBB; break;
                        case '4PersonTeam': teamArray = this.comps.fourPersonTeams; break;
                        case 'Best3From4': teamArray = this.comps.best3From4; break;
                        default: return;
                    }
                    
                    const team = teamArray.find(t => t.id === teamId);
                    if (team) {
                        team.currency = currency;
                        team.money = moneyValue;
                        updatedCount++;
                    }
                });
                
                if (updatedCount > 0) {
                    this.saveData();
                    this.renderCompsResults();
                    this.hideEditAllCompsModal();
                    this.showToast(`Updated ${updatedCount} teams!`, 'success');
                } else {
                    this.showToast('No changes to save', 'info');
                }
            },
            
            calculate4BBB() {
                if (this.comps.fourBBB.length === 0) {
                    this.showToast('No 4BBB teams created yet', 'warning');
                    return;
                }
                
                // Sort teams by group first, then calculate
                this.comps.fourBBB.sort((a, b) => {
                    if (a.group === b.group) return a.name.localeCompare(b.name);
                    if (!a.group) return 1;
                    if (!b.group) return -1;
                    return a.group.localeCompare(b.group);
                });
                
                // For demonstration, we'll calculate scores based on player scores
                this.comps.fourBBB.forEach(team => {
                    let totalPoints = 0;
                    let totalGross = 0;
                    let front9Points = 0;
                    let back9Points = 0;
                    
                    // For each hole, take the better stableford score
                    for (let hole = 1; hole <= 18; hole++) {
                        let bestHolePoints = 0;
                        let bestGross = 0;
                        
                        team.players.forEach(player => {
                            const playerScores = this.scores[player.id] || {};
                            const score = playerScores[hole];
                            
                            if (score !== undefined) {
                                // Find course for hole info - case insensitive
                                const course = this.courses.find(c => 
                                    c.name && team.course && 
                                    c.name.toLowerCase() === team.course.toLowerCase()
                                );
                                if (course) {
                                    const holeData = course.holes.find(h => h.number === hole);
                                    if (holeData) {
                                        const result = this.calculateStablefordWithResult(
                                            score, 
                                            holeData.par, 
                                            player.phc,
                                            holeData.index
                                        );
                                        
                                        if (result.points > bestHolePoints) {
                                            bestHolePoints = result.points;
                                            bestGross = score;
                                        }
                                    }
                                }
                            }
                        });
                        
                        totalPoints += bestHolePoints;
                        totalGross += bestGross;
                        
                        if (hole <= 9) {
                            front9Points += bestHolePoints;
                        } else {
                            back9Points += bestHolePoints;
                        }
                    }
                    
                    team.totalPoints = totalPoints;
                    team.totalGross = totalGross;
                    team.front9Points = front9Points;
                    team.back9Points = back9Points;
                });
                
                // Sort teams by total points within each group
                this.comps.fourBBB.sort((a, b) => {
                    if (a.group === b.group) {
                        return b.totalPoints - a.totalPoints;
                    }
                    if (!a.group) return 1;
                    if (!b.group) return -1;
                    return a.group.localeCompare(b.group);
                });
                
                this.saveData();
                this.renderCompsResults();
                this.showToast('4BBB scores calculated!', 'success');
            },
            
            calculate4PersonTeam() {
                if (this.comps.fourPersonTeams.length === 0) {
                    this.showToast('No 4 Person Teams created yet', 'warning');
                    return;
                }
                
                // MODIFIED: All FOUR scores count toward team total
                this.comps.fourPersonTeams.forEach(team => {
                    let totalPoints = 0;
                    let totalGross = 0;
                    let front9Points = 0;
                    let back9Points = 0;
                    
                    // For each hole, take ALL FOUR stableford scores
                    for (let hole = 1; hole <= 18; hole++) {
                        let holePoints = 0;
                        let holeGross = 0;
                        
                        team.players.forEach(player => {
                            const playerScores = this.scores[player.id] || {};
                            const score = playerScores[hole];
                            
                            if (score !== undefined) {
                                // Find course for hole info - case insensitive
                                const course = this.courses.find(c => 
                                    c.name && team.course && 
                                    c.name.toLowerCase() === team.course.toLowerCase()
                                );
                                if (course) {
                                    const holeData = course.holes.find(h => h.number === hole);
                                    if (holeData) {
                                        const result = this.calculateStablefordWithResult(
                                            score, 
                                            holeData.par, 
                                            player.phc,
                                            holeData.index
                                        );
                                        
                                        holePoints += result.points;
                                        holeGross += score;
                                    }
                                }
                            }
                        });
                        
                        totalPoints += holePoints;
                        totalGross += holeGross;
                        
                        if (hole <= 9) {
                            front9Points += holePoints;
                        } else {
                            back9Points += holePoints;
                        }
                    }
                    
                    team.totalPoints = totalPoints;
                    team.totalGross = totalGross;
                    team.front9Points = front9Points;
                    team.back9Points = back9Points;
                });
                
                // Sort teams by total points
                this.comps.fourPersonTeams.sort((a, b) => b.totalPoints - a.totalPoints);
                
                this.saveData();
                this.renderCompsResults();
                this.showToast('4 Person Team scores calculated (All 4 scores count)!', 'success');
            },
            
            calculateBest3From4() {
                if (this.comps.best3From4.length === 0) {
                    this.showToast('No Best 3 from 4 teams created yet', 'warning');
                    return;
                }
                
                // For demonstration, we'll calculate scores based on best 3 scores per hole
                this.comps.best3From4.forEach(team => {
                    let totalPoints = 0;
                    let totalGross = 0;
                    let front9Points = 0;
                    let back9Points = 0;
                    
                    // For each hole, take the best 3 stableford scores
                    for (let hole = 1; hole <= 18; hole++) {
                        const holePoints = [];
                        const holeGross = [];
                        
                        team.players.forEach(player => {
                            const playerScores = this.scores[player.id] || {};
                            const score = playerScores[hole];
                            
                            if (score !== undefined) {
                                // Find course for hole info - case insensitive
                                const course = this.courses.find(c => 
                                    c.name && team.course && 
                                    c.name.toLowerCase() === team.course.toLowerCase()
                                );
                                if (course) {
                                    const holeData = course.holes.find(h => h.number === hole);
                                    if (holeData) {
                                        const result = this.calculateStablefordWithResult(
                                            score, 
                                            holeData.par, 
                                            player.phc,
                                            holeData.index
                                        );
                                        
                                        holePoints.push(result.points);
                                        holeGross.push(score);
                                    }
                                }
                            }
                        });
                        
                        // Sort points descending and take best 3
                        holePoints.sort((a, b) => b - a);
                        const bestThreePoints = holePoints.slice(0, 3).reduce((sum, points) => sum + points, 0);
                        
                        // Sort gross ascending and take best 3 (lower is better)
                        holeGross.sort((a, b) => a - b);
                        const bestThreeGross = holeGross.slice(0, 3).reduce((sum, gross) => sum + gross, 0);
                        
                        totalPoints += bestThreePoints;
                        totalGross += bestThreeGross;
                        
                        if (hole <= 9) {
                            front9Points += bestThreePoints;
                        } else {
                            back9Points += bestThreePoints;
                        }
                    }
                    
                    team.totalPoints = totalPoints;
                    team.totalGross = totalGross;
                    team.front9Points = front9Points;
                    team.back9Points = back9Points;
                });
                
                // Sort teams by total points
                this.comps.best3From4.sort((a, b) => b.totalPoints - a.totalPoints);
                
                this.saveData();
                this.renderCompsResults();
                this.showToast('Best 3 from 4 scores calculated!', 'success');
            },
            
            calculateMixedScore() {
                if (this.comps.mixedScore.length === 0) {
                    this.showToast('No Mixed Score teams created yet', 'warning');
                    return;
                }
                
                // Calculate scores based on assigned holes for each player
                // P1: holes 1-4, P2: holes 5-9, P3: holes 10-13, P4: holes 14-18
                this.comps.mixedScore.forEach(team => {
                    let totalPoints = 0;
                    let totalGross = 0;
                    let front9Points = 0;
                    let back9Points = 0;
                    
                    // Define hole assignments for each player (0-indexed in array = players[0] is P1)
                    const holeAssignments = [
                        [1, 2, 3, 4],           // Player 1
                        [5, 6, 7, 8, 9],        // Player 2
                        [10, 11, 12, 13],       // Player 3
                        [14, 15, 16, 17, 18]    // Player 4
                    ];
                    
                    // For each hole, only count the designated player's score
                    for (let hole = 1; hole <= 18; hole++) {
                        // Find which player is assigned to this hole
                        let assignedPlayerIndex = -1;
                        for (let p = 0; p < holeAssignments.length; p++) {
                            if (holeAssignments[p].includes(hole)) {
                                assignedPlayerIndex = p;
                                break;
                            }
                        }
                        
                        if (assignedPlayerIndex >= 0 && assignedPlayerIndex < team.players.length) {
                            const player = team.players[assignedPlayerIndex];
                            const playerScores = this.scores[player.id] || {};
                            const score = playerScores[hole];
                            
                            if (score !== undefined) {
                                // Find course for hole info - case insensitive
                                const course = this.courses.find(c => 
                                    c.name && team.course && 
                                    c.name.toLowerCase() === team.course.toLowerCase()
                                );
                                if (course) {
                                    const holeData = course.holes.find(h => h.number === hole);
                                    if (holeData) {
                                        const result = this.calculateStablefordWithResult(
                                            score, 
                                            holeData.par, 
                                            player.phc,
                                            holeData.index
                                        );
                                        
                                        totalPoints += result.points;
                                        totalGross += score;
                                        
                                        if (hole <= 9) {
                                            front9Points += result.points;
                                        } else {
                                            back9Points += result.points;
                                        }
                                    }
                                }
                            }
                        }
                    }
                    
                    team.totalPoints = totalPoints;
                    team.totalGross = totalGross;
                    team.front9Points = front9Points;
                    team.back9Points = back9Points;
                });
                
                // Sort teams by total points
                this.comps.mixedScore.sort((a, b) => b.totalPoints - a.totalPoints);
                
                this.saveData();
                this.renderCompsResults();
                this.showToast('4 Person Team Mixed Score calculated!', 'success');
            },
            
            // Team A vs Team B Functions
            showTeamAvsBAutoDraw() {
                if (this.players.length < 2) {
                    this.showToast('Need at least 2 players for Team A vs Team B', 'warning');
                    return;
                }
                
                if (this.courses.length === 0) {
                    this.showToast('Please add a course first', 'warning');
                    return;
                }
                
                // Open modal in auto-draw mode
                document.getElementById('teamAvsBModalTitle').textContent = 'Team A vs Team B - Auto Draw';
                document.getElementById('teamAvsBAutoDraw').style.display = 'inline-flex';
                
                // Populate course dropdown
                const courseSelect = document.getElementById('teamAvsBCourseSelect');
                courseSelect.innerHTML = '<option value="">Select course...</option>';
                this.courses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course.name;
                    option.textContent = course.name;
                    courseSelect.appendChild(option);
                });
                
                // Reset teams
                this.tempTeamAvsB = { teamA: [], teamB: [], courseName: '' };
                document.getElementById('teamAvsBPlayersSection').style.display = 'none';
                
                document.getElementById('teamAvsBModal').style.display = 'flex';
            },
            
            showTeamAvsBManualAdd() {
                if (this.players.length === 0) {
                    this.showToast('No players available', 'warning');
                    return;
                }
                
                if (this.courses.length === 0) {
                    this.showToast('Please add a course first', 'warning');
                    return;
                }
                
                // Open modal in manual mode
                document.getElementById('teamAvsBModalTitle').textContent = 'Team A vs Team B - Manual Assignment';
                document.getElementById('teamAvsBAutoDraw').style.display = 'none';
                
                // Populate course dropdown
                const courseSelect = document.getElementById('teamAvsBCourseSelect');
                courseSelect.innerHTML = '<option value="">Select course...</option>';
                this.courses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course.name;
                    option.textContent = course.name;
                    courseSelect.appendChild(option);
                });
                
                // Load existing teams if any
                if (this.comps.teamAvsB && this.comps.teamAvsB.courseName) {
                    this.tempTeamAvsB = JSON.parse(JSON.stringify(this.comps.teamAvsB));
                    courseSelect.value = this.tempTeamAvsB.courseName;
                    this.teamAvsBCourseChanged();
                } else {
                    this.tempTeamAvsB = { teamA: [], teamB: [], courseName: '' };
                    document.getElementById('teamAvsBPlayersSection').style.display = 'none';
                }
                
                document.getElementById('teamAvsBModal').style.display = 'flex';
            },
            
            hideTeamAvsBModal() {
                document.getElementById('teamAvsBModal').style.display = 'none';
                this.tempTeamAvsB = null;
            },
            
            teamAvsBCourseChanged() {
                const courseName = document.getElementById('teamAvsBCourseSelect').value;
                
                if (!courseName) {
                    document.getElementById('teamAvsBPlayersSection').style.display = 'none';
                    return;
                }
                
                // Initialize tempTeamAvsB if null
                if (!this.tempTeamAvsB) {
                    this.tempTeamAvsB = { teamA: [], teamB: [], courseName: '' };
                }
                
                // If changing course, clear teams
                if (this.tempTeamAvsB.courseName && this.tempTeamAvsB.courseName !== courseName) {
                    if (confirm('Changing course will clear current team assignments. Continue?')) {
                        this.tempTeamAvsB = { teamA: [], teamB: [], courseName: courseName };
                    } else {
                        // Revert dropdown to previous course
                        document.getElementById('teamAvsBCourseSelect').value = this.tempTeamAvsB.courseName;
                        return;
                    }
                } else {
                    this.tempTeamAvsB.courseName = courseName;
                }
                
                document.getElementById('teamAvsBPlayersSection').style.display = 'block';
                this.renderTeamAvsBPlayers();
            },
            
            teamAvsBAutoDrawInModal() {
                const courseName = this.tempTeamAvsB.courseName;
                
                if (!courseName) {
                    this.showToast('Please select a course first', 'warning');
                    return;
                }
                
                // Case-insensitive course matching
                const coursePlayers = this.players.filter(p => 
                    p.course && courseName && 
                    p.course.toLowerCase() === courseName.toLowerCase()
                );
                
                if (coursePlayers.length < 2) {
                    this.showToast('Need at least 2 players on this course', 'warning');
                    return;
                }
                
                // Randomly shuffle players
                const shuffled = [...coursePlayers].sort(() => Math.random() - 0.5);
                
                // Split into two teams
                const halfWay = Math.ceil(shuffled.length / 2);
                this.tempTeamAvsB.teamA = shuffled.slice(0, halfWay);
                this.tempTeamAvsB.teamB = shuffled.slice(halfWay);
                
                this.renderTeamAvsBPlayers();
                this.showToast(`Auto-draw complete: Team A (${this.tempTeamAvsB.teamA.length}) vs Team B (${this.tempTeamAvsB.teamB.length})`, 'success');
            },
            
            renderTeamAvsBPlayers() {
                const teamAList = document.getElementById('teamAPlayersList');
                const teamBList = document.getElementById('teamBPlayersList');
                const courseName = this.tempTeamAvsB.courseName;
                
                // Update counts
                document.getElementById('teamACount').textContent = this.tempTeamAvsB.teamA.length;
                document.getElementById('teamBCount').textContent = this.tempTeamAvsB.teamB.length;
                
                // Render Team A players
                teamAList.innerHTML = '';
                if (this.tempTeamAvsB.teamA.length === 0) {
                    teamAList.innerHTML = '<p style="text-align: center; color: #7f8c8d; font-size: 0.85rem; margin: 10px 0;">No players in Team A</p>';
                } else {
                    this.tempTeamAvsB.teamA.forEach(player => {
                        const playerDiv = document.createElement('div');
                        playerDiv.style.cssText = 'margin-bottom: 6px; padding: 6px; background: white; border-radius: 3px; border: 1px solid #3498db; cursor: pointer; transition: all 0.2s;';
                        playerDiv.innerHTML = `
                            <div style="font-weight: bold; font-size: 0.85rem;">${player.name}</div>
                            <div style="font-size: 0.7rem; color: #7f8c8d;">PHC: ${player.phc || 0}</div>
                        `;
                        playerDiv.onmouseover = () => playerDiv.style.background = '#ebf5fb';
                        playerDiv.onmouseout = () => playerDiv.style.background = 'white';
                        playerDiv.onclick = () => this.teamAvsBPlayerClick(player.id, 'A');
                        teamAList.appendChild(playerDiv);
                    });
                }
                
                // Render Team B players
                teamBList.innerHTML = '';
                if (this.tempTeamAvsB.teamB.length === 0) {
                    teamBList.innerHTML = '<p style="text-align: center; color: #7f8c8d; font-size: 0.85rem; margin: 10px 0;">No players in Team B</p>';
                } else {
                    this.tempTeamAvsB.teamB.forEach(player => {
                        const playerDiv = document.createElement('div');
                        playerDiv.style.cssText = 'margin-bottom: 6px; padding: 6px; background: white; border-radius: 3px; border: 1px solid #e74c3c; cursor: pointer; transition: all 0.2s;';
                        playerDiv.innerHTML = `
                            <div style="font-weight: bold; font-size: 0.85rem;">${player.name}</div>
                            <div style="font-size: 0.7rem; color: #7f8c8d;">PHC: ${player.phc || 0}</div>
                        `;
                        playerDiv.onmouseover = () => playerDiv.style.background = '#fadbd8';
                        playerDiv.onmouseout = () => playerDiv.style.background = 'white';
                        playerDiv.onclick = () => this.teamAvsBPlayerClick(player.id, 'B');
                        teamBList.appendChild(playerDiv);
                    });
                }
                
                // Clear any existing available players section
                const existingAvailable = document.getElementById('teamAvsBAvailablePlayers');
                if (existingAvailable) {
                    existingAvailable.remove();
                }
                
                // Show available players to add - case insensitive
                const coursePlayers = this.players.filter(p => 
                    p.course && courseName && 
                    p.course.toLowerCase() === courseName.toLowerCase()
                );
                const assignedIds = new Set([
                    ...this.tempTeamAvsB.teamA.map(p => p.id),
                    ...this.tempTeamAvsB.teamB.map(p => p.id)
                ]);
                const availablePlayers = coursePlayers.filter(p => !assignedIds.has(p.id));
                
                // Find the teams grid container
                const teamsGrid = teamAList.parentElement.parentElement;
                const playersSection = document.getElementById('teamAvsBPlayersSection');
                
                if (availablePlayers.length > 0) {
                    const availableDiv = document.createElement('div');
                    availableDiv.id = 'teamAvsBAvailablePlayers';
                    availableDiv.style.cssText = 'margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 3px; border: 1px solid #e0e0e0;';
                    availableDiv.innerHTML = '<strong style="font-size: 0.85rem; color: #2c3e50; margin-bottom: 8px; display: block;">Available Players (click to assign):</strong>';
                    
                    const availableGrid = document.createElement('div');
                    availableGrid.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr; gap: 8px;';
                    
                    availablePlayers.forEach(player => {
                        const playerDiv = document.createElement('div');
                        playerDiv.style.cssText = 'padding: 6px; background: white; border-radius: 3px; border: 1px solid #95a5a6; cursor: pointer; transition: all 0.2s;';
                        playerDiv.innerHTML = `
                            <div style="font-weight: bold; font-size: 0.85rem;">${player.name}</div>
                            <div style="font-size: 0.7rem; color: #7f8c8d;">PHC: ${player.phc || 0}</div>
                        `;
                        playerDiv.onmouseover = () => playerDiv.style.background = '#ecf0f1';
                        playerDiv.onmouseout = () => playerDiv.style.background = 'white';
                        playerDiv.onclick = () => this.teamAvsBPlayerClick(player.id, 'unassigned');
                        availableGrid.appendChild(playerDiv);
                    });
                    
                    availableDiv.appendChild(availableGrid);
                    
                    // Insert after the teams grid
                    teamsGrid.after(availableDiv);
                }
            },
            
            teamAvsBPlayerClick(playerId, currentTeam) {
                const player = this.players.find(p => p.id === playerId);
                if (!player) return;
                
                if (currentTeam === 'unassigned') {
                    // Ask which team to add to using a more explicit prompt
                    const teamChoice = prompt(`Assign ${player.name} to which team?\n\nEnter 'A' for Team A or 'B' for Team B:`, 'A');
                    
                    if (!teamChoice) {
                        // User cancelled
                        return;
                    }
                    
                    const choice = teamChoice.toUpperCase().trim();
                    if (choice === 'A') {
                        this.tempTeamAvsB.teamA.push(player);
                        this.showToast(`${player.name} added to Team A`, 'success');
                    } else if (choice === 'B') {
                        this.tempTeamAvsB.teamB.push(player);
                        this.showToast(`${player.name} added to Team B`, 'success');
                    } else {
                        this.showToast('Invalid choice. Please enter A or B', 'error');
                        return;
                    }
                } else if (currentTeam === 'A') {
                    // Offer to move to Team B or remove
                    const choice = prompt(`${player.name} is in Team A.\n\nWhat would you like to do?\nEnter 'B' to move to Team B\nEnter 'R' to remove\nCancel to keep in Team A:`, 'B');
                    
                    if (!choice) {
                        return;
                    }
                    
                    const action = choice.toUpperCase().trim();
                    if (action === 'B') {
                        this.tempTeamAvsB.teamA = this.tempTeamAvsB.teamA.filter(p => p.id !== playerId);
                        this.tempTeamAvsB.teamB.push(player);
                        this.showToast(`${player.name} moved to Team B`, 'success');
                    } else if (action === 'R') {
                        this.tempTeamAvsB.teamA = this.tempTeamAvsB.teamA.filter(p => p.id !== playerId);
                        this.showToast(`${player.name} removed from teams`, 'warning');
                    } else {
                        return;
                    }
                } else if (currentTeam === 'B') {
                    // Offer to move to Team A or remove
                    const choice = prompt(`${player.name} is in Team B.\n\nWhat would you like to do?\nEnter 'A' to move to Team A\nEnter 'R' to remove\nCancel to keep in Team B:`, 'A');
                    
                    if (!choice) {
                        return;
                    }
                    
                    const action = choice.toUpperCase().trim();
                    if (action === 'A') {
                        this.tempTeamAvsB.teamB = this.tempTeamAvsB.teamB.filter(p => p.id !== playerId);
                        this.tempTeamAvsB.teamA.push(player);
                        this.showToast(`${player.name} moved to Team A`, 'success');
                    } else if (action === 'R') {
                        this.tempTeamAvsB.teamB = this.tempTeamAvsB.teamB.filter(p => p.id !== playerId);
                        this.showToast(`${player.name} removed from teams`, 'warning');
                    } else {
                        return;
                    }
                }
                
                this.renderTeamAvsBPlayers();
            },
            
            confirmTeamAvsB() {
                if (!this.tempTeamAvsB.courseName) {
                    this.showToast('Please select a course', 'error');
                    return;
                }
                
                if (this.tempTeamAvsB.teamA.length === 0 && this.tempTeamAvsB.teamB.length === 0) {
                    this.showToast('Please assign at least one player to a team', 'warning');
                    return;
                }
                
                // Save the teams
                this.comps.teamAvsB = JSON.parse(JSON.stringify(this.tempTeamAvsB));
                
                this.saveData();
                this.hideTeamAvsBModal();
                this.renderCompsResults();
                
                this.showToast(`Team A vs Team B created: Team A (${this.comps.teamAvsB.teamA.length}) vs Team B (${this.comps.teamAvsB.teamB.length})`, 'success');
            },
            
            calculateTeamAvsB() {
                if (!this.comps.teamAvsB.courseName || 
                    (this.comps.teamAvsB.teamA.length === 0 && this.comps.teamAvsB.teamB.length === 0)) {
                    this.showToast('No Team A vs Team B competition created yet', 'warning');
                    return;
                }
                
                const calculateTeamScores = (team) => {
                    let totalPoints = 0;
                    let totalGross = 0;
                    const playerScores = [];
                    
                    team.forEach(player => {
                        let playerTotalPoints = 0;
                        let playerTotalGross = 0;
                        
                        for (let hole = 1; hole <= 18; hole++) {
                            const playerHoleScores = this.scores[player.id] || {};
                            const score = playerHoleScores[hole];
                            
                            if (score !== undefined) {
                                // Case-insensitive course matching
                                const course = this.courses.find(c => 
                                    c.name && this.comps.teamAvsB.courseName && 
                                    c.name.toLowerCase() === this.comps.teamAvsB.courseName.toLowerCase()
                                );
                                if (course) {
                                    const holeData = course.holes.find(h => h.number === hole);
                                    if (holeData) {
                                        const result = this.calculateStablefordWithResult(
                                            score, 
                                            holeData.par, 
                                            player.phc,
                                            holeData.index
                                        );
                                        
                                        playerTotalPoints += result.points;
                                        playerTotalGross += score;
                                    }
                                }
                            }
                        }
                        
                        totalPoints += playerTotalPoints;
                        totalGross += playerTotalGross;
                        playerScores.push({
                            name: player.name,
                            points: playerTotalPoints,
                            gross: playerTotalGross
                        });
                    });
                    
                    return { totalPoints, totalGross, playerScores };
                };
                
                this.comps.teamAvsB.teamAScores = calculateTeamScores(this.comps.teamAvsB.teamA);
                this.comps.teamAvsB.teamBScores = calculateTeamScores(this.comps.teamAvsB.teamB);
                
                this.saveData();
                this.renderCompsResults();
                this.showToast('Team A vs Team B scores calculated!', 'success');
            },
            
            deleteCompetition(compType, groupName) {
                let confirmMessage = '';
                let teamsToDelete = 0;
                
                if (compType === '4BBB') {
                    teamsToDelete = this.comps.fourBBB.filter(t => (t.group || 'Ungrouped') === groupName).length;
                    confirmMessage = `Delete all ${teamsToDelete} teams in 4BBB - ${groupName}?`;
                } else if (compType === '4PersonTeam') {
                    teamsToDelete = this.comps.fourPersonTeams.length;
                    confirmMessage = `Delete all ${teamsToDelete} 4 Person Teams?`;
                } else if (compType === 'Best3From4') {
                    teamsToDelete = this.comps.best3From4.length;
                    confirmMessage = `Delete all ${teamsToDelete} Best 3 from 4 teams?`;
                } else if (compType === 'MixedScore') {
                    teamsToDelete = this.comps.mixedScore.length;
                    confirmMessage = `Delete all ${teamsToDelete} Mixed Score teams?`;
                } else if (compType === 'TeamAvsB') {
                    confirmMessage = 'Delete Team A vs Team B competition?';
                }
                
                if (!confirm(confirmMessage)) return;
                
                if (compType === '4BBB') {
                    this.comps.fourBBB = this.comps.fourBBB.filter(t => (t.group || 'Ungrouped') !== groupName);
                    this.showToast(`Deleted ${teamsToDelete} 4BBB teams from ${groupName}`, 'warning');
                } else if (compType === '4PersonTeam') {
                    this.comps.fourPersonTeams = [];
                    this.showToast(`Deleted all 4 Person Teams`, 'warning');
                } else if (compType === 'Best3From4') {
                    this.comps.best3From4 = [];
                    this.showToast(`Deleted all Best 3 from 4 teams`, 'warning');
                } else if (compType === 'MixedScore') {
                    this.comps.mixedScore = [];
                    this.showToast(`Deleted all Mixed Score teams`, 'warning');
                } else if (compType === 'TeamAvsB') {
                    this.comps.teamAvsB = { teamA: [], teamB: [], courseName: '' };
                    this.showToast(`Deleted Team A vs Team B competition`, 'warning');
                }
                
                this.saveData();
                this.renderCompsResults();
            },
            
            renderCompsResults() {
                const container = document.getElementById('compsResultsContainer');
                
                let html = '';
                
                // 4BBB Results - WITH GROUPING
                if (this.comps.fourBBB.length > 0) {
                    // Group teams by their group
                    const groupedTeams = {};
                    this.comps.fourBBB.forEach(team => {
                        const group = team.group || 'Ungrouped';
                        if (!groupedTeams[group]) {
                            groupedTeams[group] = [];
                        }
                        groupedTeams[group].push(team);
                    });
                    
                    // Sort groups
                    const sortedGroups = Object.keys(groupedTeams).sort((a, b) => {
                        if (a === 'Ungrouped') return 1;
                        if (b === 'Ungrouped') return -1;
                        return a.localeCompare(b);
                    });
                    
                    sortedGroups.forEach(groupName => {
                        const groupTeams = groupedTeams[groupName];
                        const sampleTeam = groupTeams[0];
                        
                        html += `
                            <div style="background: white; border-radius: 5px; padding: 12px; margin-bottom: 15px; border: 1px solid #e0e0e0; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <h3 style="color: #2c3e50; margin: 0; padding-bottom: 5px; border-bottom: 2px solid #2ecc71; font-size: 1rem; flex: 1;">
                                        üèåÔ∏è 4 Ball Better Ball (4BBB) - ${groupName}
                                        <span style="font-size: 0.7rem; color: #7f8c8d; margin-left: 10px;">
                                            ${groupTeams.length} teams
                                        </span>
                                        ${sampleTeam?.course ? 
                                            `<span style="font-size: 0.7rem; color: #3498db; margin-left: 10px; font-weight: bold;">
                                                ‚õ≥ ${sampleTeam.course}
                                            </span>` : ''
                                        }
                                        ${sampleTeam?.money > 0 ? 
                                            `<span style="font-size: 0.7rem; color: #27ae60; margin-left: 10px; font-weight: bold;">
                                                Prize: ${sampleTeam.currency || '¬£'}${sampleTeam.money}
                                            </span>` : ''
                                        }
                                    </h3>
                                    <button onclick="app.deleteCompetition('4BBB', '${groupName}')" class="btn-danger btn-small" style="font-size: 10px; padding: 4px 8px; white-space: nowrap;">üóëÔ∏è Delete</button>
                                </div>
                        `;
                        
                        if (sampleTeam.totalPoints > 0) {
                            html += `
                                <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                                    <thead>
                                        <tr style="background: #2c3e50; color: white;">
                                            <th style="padding: 6px; text-align: center; width: 40px;">Pos</th>
                                            <th style="padding: 6px; text-align: left;">Team</th>
                                            <th style="padding: 6px; text-align: center; width: 100px;">Players</th>
                                            <th style="padding: 6px; text-align: center; width: 60px; background: #2ecc71;">F9 P</th>
                                            <th style="padding: 6px; text-align: center; width: 60px; background: #2ecc71;">B9 P</th>
                                            <th style="padding: 6px; text-align: center; width: 60px; background: #2ecc71;">Total P</th>
                                            <th style="padding: 6px; text-align: center; width: 60px;">Gross</th>
                                            <th style="padding: 6px; text-align: center; width: 80px; background: #27ae60;">Money</th>
                                            <th style="padding: 6px; text-align: center; width: 50px;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                            `;
                            
                            // Sort teams within group by points
                            const sortedGroupTeams = [...groupTeams].sort((a, b) => b.totalPoints - a.totalPoints);
                            
                            sortedGroupTeams.forEach((team, index) => {
                                const position = index + 1;
                                const positionClass = position === 1 ? 'style="background: #fef9e7;"' : 
                                                   position === 2 ? 'style="background: #f8f9fa;"' : 
                                                   position === 3 ? 'style="background: #f5f5f5;"' : '';
                                
                                // FULL player names in team display
                                const playerNames = team.players.map(p => p.name).join(', ');
                                
                                html += `
                                    <tr ${positionClass}>
                                        <td style="padding: 6px; text-align: center; font-weight: bold; border-right: 1px solid #e0e0e0;">${position}</td>
                                        <td style="padding: 6px;"><strong>${team.name}</strong></td>
                                        <td style="padding: 6px; text-align: left; font-size: 0.7em;" title="${playerNames}">
                                            ${playerNames}
                                        </td>
                                        <td style="padding: 6px; text-align: center; font-weight: bold; background: #f0f9f4;">${team.front9Points || 0}</td>
                                        <td style="padding: 6px; text-align: center; font-weight: bold; background: #f0f9f4;">${team.back9Points || 0}</td>
                                        <td style="padding: 6px; text-align: center; font-weight: bold; background: #f0f9f4; color: #2ecc71;">${team.totalPoints || 0}</td>
                                        <td style="padding: 6px; text-align: center;">${team.totalGross || 0}</td>
                                        <td style="padding: 6px; text-align: center; font-weight: bold; background: #e8f6f3; color: #27ae60;">
                                            ${team.money > 0 ? `${team.currency || '¬£'}${team.money.toFixed(2)}` : '-'}
                                        </td>
                                        <td style="padding: 6px; text-align: center;">
                                            <button onclick="app.showEditTeamModal(${JSON.stringify(team).replace(/"/g, '&quot;')}, '4BBB')" class="btn-secondary btn-small" style="font-size: 9px; padding: 2px 5px;">‚úèÔ∏è Edit</button>
                                        </td>
                                    </tr>
                                `;
                            });
                            
                            html += `
                                    </tbody>
                                </table>
                            `;
                        } else {
                            html += `
                                <div style="text-align: center; padding: 20px; color: #7f8c8d; background: #f8f9fa; border-radius: 3px;">
                                    <p>No scores calculated yet. Click "Calculate" to compute team scores.</p>
                                </div>
                            `;
                        }
                        
                        html += `</div>`;
                    });
                }
                
                // 4 Person Team Results
                if (this.comps.fourPersonTeams.length > 0) {
                    const sampleTeam = this.comps.fourPersonTeams[0];
                    
                    html += `
                        <div style="background: white; border-radius: 5px; padding: 12px; margin-bottom: 15px; border: 1px solid #e0e0e0; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h3 style="color: #2c3e50; margin: 0; padding-bottom: 5px; border-bottom: 2px solid #1abc9c; font-size: 1rem; flex: 1;">
                                    üë• 4 Person Team (All Scores Count) Results
                                    <span style="font-size: 0.7rem; color: #7f8c8d; margin-left: 10px;">
                                        ${this.comps.fourPersonTeams.length} teams
                                    </span>
                                    ${sampleTeam?.course ? 
                                        `<span style="font-size: 0.7rem; color: #3498db; margin-left: 10px; font-weight: bold;">
                                            ‚õ≥ ${sampleTeam.course}
                                        </span>` : ''
                                    }
                                    ${sampleTeam?.money > 0 ? 
                                        `<span style="font-size: 0.7rem; color: #27ae60; margin-left: 10px; font-weight: bold;">
                                            Prize: ${sampleTeam.currency || '¬£'}${sampleTeam.money}
                                        </span>` : ''
                                    }
                                </h3>
                                <button onclick="app.deleteCompetition('4PersonTeam', '')" class="btn-danger btn-small" style="font-size: 10px; padding: 4px 8px; white-space: nowrap;">üóëÔ∏è Delete</button>
                            </div>
                    `;
                    
                    if (sampleTeam.totalPoints > 0) {
                        html += `
                            <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                                <thead>
                                    <tr style="background: #2c3e50; color: white;">
                                        <th style="padding: 6px; text-align: center; width: 40px;">Pos</th>
                                        <th style="padding: 6px; text-align: left;">Team / Group</th>
                                        <th style="padding: 6px; text-align: center; width: 120px;">Players</th>
                                        <th style="padding: 6px; text-align: center; width: 60px; background: #1abc9c;">F9 P</th>
                                        <th style="padding: 6px; text-align: center; width: 60px; background: #1abc9c;">B9 P</th>
                                        <th style="padding: 6px; text-align: center; width: 60px; background: #1abc9c;">Total P</th>
                                        <th style="padding: 6px; text-align: center; width: 60px;">Gross</th>
                                        <th style="padding: 6px; text-align: center; width: 80px; background: #27ae60;">Money</th>
                                        <th style="padding: 6px; text-align: center; width: 50px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        this.comps.fourPersonTeams.forEach((team, index) => {
                            const position = index + 1;
                            const positionClass = position === 1 ? 'style="background: #fef9e7;"' : 
                                               position === 2 ? 'style="background: #f8f9fa;"' : 
                                               position === 3 ? 'style="background: #f5f5f5;"' : '';
                            
                            // FULL player names in team display
                            const playerNames = team.players.map(p => p.name).join(', ');
                            
                            html += `
                                <tr ${positionClass}>
                                    <td style="padding: 6px; text-align: center; font-weight: bold; border-right: 1px solid #e0e0e0;">${position}</td>
                                    <td style="padding: 6px;">
                                        <strong>${team.name}</strong>
                                        <div style="font-size: 0.7rem; color: #7f8c8d;">${team.group || 'No Group'}</div>
                                    </td>
                                    <td style="padding: 6px; text-align: left; font-size: 0.7em;" title="${playerNames}">
                                        ${playerNames}
                                    </td>
                                    <td style="padding: 6px; text-align: center; font-weight: bold; background: #e8f6f3;">${team.front9Points || 0}</td>
                                    <td style="padding: 6px; text-align: center; font-weight: bold; background: #e8f6f3;">${team.back9Points || 0}</td>
                                    <td style="padding: 6px; text-align: center; font-weight: bold; background: #e8f6f3; color: #1abc9c;">${team.totalPoints || 0}</td>
                                    <td style="padding: 6px; text-align: center;">${team.totalGross || 0}</td>
                                    <td style="padding: 6px; text-align: center; font-weight: bold; background: #e8f6f3; color: #27ae60;">
                                        ${team.money > 0 ? `${team.currency || '¬£'}${team.money.toFixed(2)}` : '-'}
                                    </td>
                                    <td style="padding: 6px; text-align: center;">
                                        <button onclick="app.showEditTeamModal(${JSON.stringify(team).replace(/"/g, '&quot;')}, '4PersonTeam')" class="btn-secondary btn-small" style="font-size: 9px; padding: 2px 5px;">‚úèÔ∏è Edit</button>
                                    </td>
                                </tr>
                            `;
                        });
                        
                        html += `
                                </tbody>
                            </table>
                        `;
                    } else {
                        html += `
                            <div style="text-align: center; padding: 20px; color: #7f8c8d; background: #f8f9fa; border-radius: 3px;">
                                <p>No scores calculated yet. Click "Calculate" to compute team scores.</p>
                            </div>
                        `;
                    }
                    
                    html += `</div>`;
                }
                
                // Best 3 from 4 Results
                if (this.comps.best3From4.length > 0) {
                    const sampleTeam = this.comps.best3From4[0];
                    
                    html += `
                        <div style="background: white; border-radius: 5px; padding: 12px; margin-bottom: 15px; border: 1px solid #e0e0e0; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h3 style="color: #2c3e50; margin: 0; padding-bottom: 5px; border-bottom: 2px solid #e67e22; font-size: 1rem; flex: 1;">
                                    ‚≠ê Best 3 from 4 Results
                                    <span style="font-size: 0.7rem; color: #7f8c8d; margin-left: 10px;">
                                        ${this.comps.best3From4.length} teams
                                    </span>
                                    ${sampleTeam?.course ? 
                                        `<span style="font-size: 0.7rem; color: #3498db; margin-left: 10px; font-weight: bold;">
                                            ‚õ≥ ${sampleTeam.course}
                                        </span>` : ''
                                    }
                                    ${sampleTeam?.money > 0 ? 
                                        `<span style="font-size: 0.7rem; color: #27ae60; margin-left: 10px; font-weight: bold;">
                                            Prize: ${sampleTeam.currency || '¬£'}${sampleTeam.money}
                                        </span>` : ''
                                    }
                                </h3>
                                <button onclick="app.deleteCompetition('Best3From4', '')" class="btn-danger btn-small" style="font-size: 10px; padding: 4px 8px; white-space: nowrap;">üóëÔ∏è Delete</button>
                            </div>
                    `;
                    
                    if (sampleTeam.totalPoints > 0) {
                        html += `
                            <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                                <thead>
                                    <tr style="background: #2c3e50; color: white;">
                                        <th style="padding: 6px; text-align: center; width: 40px;">Pos</th>
                                        <th style="padding: 6px; text-align: left;">Team / Group</th>
                                        <th style="padding: 6px; text-align: center; width: 120px;">Players</th>
                                        <th style="padding: 6px; text-align: center; width: 60px; background: #e67e22;">F9 P</th>
                                        <th style="padding: 6px; text-align: center; width: 60px; background: #e67e22;">B9 P</th>
                                        <th style="padding: 6px; text-align: center; width: 60px; background: #e67e22;">Total P</th>
                                        <th style="padding: 6px; text-align: center; width: 60px;">Gross</th>
                                        <th style="padding: 6px; text-align: center; width: 80px; background: #27ae60;">Money</th>
                                        <th style="padding: 6px; text-align: center; width: 50px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        this.comps.best3From4.forEach((team, index) => {
                            const position = index + 1;
                            const positionClass = position === 1 ? 'style="background: #fef9e7;"' : 
                                               position === 2 ? 'style="background: #f8f9fa;"' : 
                                               position === 3 ? 'style="background: #f5f5f5;"' : '';
                            
                            // FULL player names in team display
                            const playerNames = team.players.map(p => p.name).join(', ');
                            
                            html += `
                                <tr ${positionClass}>
                                    <td style="padding: 6px; text-align: center; font-weight: bold; border-right: 1px solid #e0e0e0;">${position}</td>
                                    <td style="padding: 6px;">
                                        <strong>${team.name}</strong>
                                        <div style="font-size: 0.7rem; color: #7f8c8d;">${team.group || 'No Group'}</div>
                                    </td>
                                    <td style="padding: 6px; text-align: left; font-size: 0.7em;" title="${playerNames}">
                                        ${playerNames}
                                    </td>
                                    <td style="padding: 6px; text-align: center; font-weight: bold; background: #fef5e7;">${team.front9Points || 0}</td>
                                    <td style="padding: 6px; text-align: center; font-weight: bold; background: #fef5e7;">${team.back9Points || 0}</td>
                                    <td style="padding: 6px; text-align: center; font-weight: bold; background: #fef5e7; color: #e67e22;">${team.totalPoints || 0}</td>
                                    <td style="padding: 6px; text-align: center;">${team.totalGross || 0}</td>
                                    <td style="padding: 6px; text-align: center; font-weight: bold; background: #e8f6f3; color: #27ae60;">
                                        ${team.money > 0 ? `${team.currency || '¬£'}${team.money.toFixed(2)}` : '-'}
                                    </td>
                                    <td style="padding: 6px; text-align: center;">
                                        <button onclick="app.showEditTeamModal(${JSON.stringify(team).replace(/"/g, '&quot;')}, 'Best3From4')" class="btn-secondary btn-small" style="font-size: 9px; padding: 2px 5px;">‚úèÔ∏è Edit</button>
                                    </td>
                                </tr>
                            `;
                        });
                        
                        html += `
                                </tbody>
                            </table>
                        `;
                    } else {
                        html += `
                            <div style="text-align: center; padding: 20px; color: #7f8c8d; background: #f8f9fa; border-radius: 3px;">
                                <p>No scores calculated yet. Click "Calculate" to compute team scores.</p>
                            </div>
                        `;
                    }
                    
                    html += `</div>`;
                }
                
                // Mixed Score Results
                if (this.comps.mixedScore.length > 0) {
                    const sampleTeam = this.comps.mixedScore[0];
                    
                    html += `
                        <div style="background: white; border-radius: 5px; padding: 12px; margin-bottom: 15px; border: 1px solid #e0e0e0; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h3 style="color: #2c3e50; margin: 0; padding-bottom: 5px; border-bottom: 2px solid #9b59b6; font-size: 1rem; flex: 1;">
                                    üéØ 4 Person Team Mixed Score Results
                                    <span style="font-size: 0.7rem; color: #7f8c8d; margin-left: 10px;">
                                        ${this.comps.mixedScore.length} teams
                                    </span>
                                    ${sampleTeam?.course ? 
                                        `<span style="font-size: 0.7rem; color: #3498db; margin-left: 10px; font-weight: bold;">
                                            ‚õ≥ ${sampleTeam.course}
                                        </span>` : ''
                                    }
                                    ${sampleTeam?.money > 0 ? 
                                        `<span style="font-size: 0.7rem; color: #27ae60; margin-left: 10px; font-weight: bold;">
                                            Prize: ${sampleTeam.currency || '¬£'}${sampleTeam.money}
                                        </span>` : ''
                                    }
                                </h3>
                                <button onclick="app.deleteCompetition('MixedScore', '')" class="btn-danger btn-small" style="font-size: 10px; padding: 4px 8px; white-space: nowrap;">üóëÔ∏è Delete</button>
                            </div>
                    `;
                    
                    if (sampleTeam.totalPoints > 0) {
                        html += `
                            <div style="padding: 8px; margin-bottom: 10px; background: #f3e5f5; border-left: 3px solid #9b59b6; border-radius: 3px; font-size: 10px;">
                                <strong>Hole Assignment:</strong> P1: 1-4, P2: 5-9, P3: 10-13, P4: 14-18
                            </div>
                            <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                                <thead>
                                    <tr style="background: #2c3e50; color: white;">
                                        <th style="padding: 6px; text-align: center; width: 40px;">Pos</th>
                                        <th style="padding: 6px; text-align: left;">Team / Group</th>
                                        <th style="padding: 6px; text-align: center; width: 120px;">Players</th>
                                        <th style="padding: 6px; text-align: center; width: 60px; background: #9b59b6;">F9 P</th>
                                        <th style="padding: 6px; text-align: center; width: 60px; background: #9b59b6;">B9 P</th>
                                        <th style="padding: 6px; text-align: center; width: 60px; background: #9b59b6;">Total P</th>
                                        <th style="padding: 6px; text-align: center; width: 60px;">Gross</th>
                                        <th style="padding: 6px; text-align: center; width: 80px; background: #27ae60;">Money</th>
                                        <th style="padding: 6px; text-align: center; width: 50px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        this.comps.mixedScore.forEach((team, index) => {
                            const position = index + 1;
                            const positionClass = position === 1 ? 'style="background: #fef9e7;"' : 
                                               position === 2 ? 'style="background: #f8f9fa;"' : 
                                               position === 3 ? 'style="background: #f5f5f5;"' : '';
                            
                            // FULL player names in team display
                            const playerNames = team.players.map(p => p.name).join(', ');
                            
                            html += `
                                <tr ${positionClass}>
                                    <td style="padding: 6px; text-align: center; font-weight: bold; border-right: 1px solid #e0e0e0;">${position}</td>
                                    <td style="padding: 6px;">
                                        <strong>${team.name}</strong>
                                        <div style="font-size: 0.7rem; color: #7f8c8d;">${team.group || 'No Group'}</div>
                                    </td>
                                    <td style="padding: 6px; text-align: left; font-size: 0.7em;" title="${playerNames}">
                                        ${playerNames}
                                    </td>
                                    <td style="padding: 6px; text-align: center; font-weight: bold; background: #f3e5f5;">${team.front9Points || 0}</td>
                                    <td style="padding: 6px; text-align: center; font-weight: bold; background: #f3e5f5;">${team.back9Points || 0}</td>
                                    <td style="padding: 6px; text-align: center; font-weight: bold; background: #f3e5f5; color: #9b59b6;">${team.totalPoints || 0}</td>
                                    <td style="padding: 6px; text-align: center;">${team.totalGross || 0}</td>
                                    <td style="padding: 6px; text-align: center; font-weight: bold; background: #e8f6f3; color: #27ae60;">
                                        ${team.money > 0 ? `${team.currency || '¬£'}${team.money.toFixed(2)}` : '-'}
                                    </td>
                                    <td style="padding: 6px; text-align: center;">
                                        <button onclick="app.showEditTeamModal(${JSON.stringify(team).replace(/"/g, '&quot;')}, 'MixedScore')" class="btn-secondary btn-small" style="font-size: 9px; padding: 2px 5px;">‚úèÔ∏è Edit</button>
                                    </td>
                                </tr>
                            `;
                        });
                        
                        html += `
                                </tbody>
                            </table>
                        `;
                    } else {
                        html += `
                            <div style="text-align: center; padding: 20px; color: #7f8c8d; background: #f8f9fa; border-radius: 3px;">
                                <p>No scores calculated yet. Click "Calculate" to compute team scores.</p>
                            </div>
                        `;
                    }
                    
                    html += `</div>`;
                }
                
                // Team A vs Team B Results
                if (this.comps.teamAvsB && this.comps.teamAvsB.courseName && 
                    (this.comps.teamAvsB.teamA.length > 0 || this.comps.teamAvsB.teamB.length > 0)) {
                    
                    const teamAScores = this.comps.teamAvsB.teamAScores || { totalPoints: 0, totalGross: 0, playerScores: [] };
                    const teamBScores = this.comps.teamAvsB.teamBScores || { totalPoints: 0, totalGross: 0, playerScores: [] };
                    const hasScores = teamAScores.totalPoints > 0 || teamBScores.totalPoints > 0;
                    
                    const winner = teamAScores.totalPoints > teamBScores.totalPoints ? 'Team A' : 
                                   teamBScores.totalPoints > teamAScores.totalPoints ? 'Team B' : 'Tie';
                    
                    html += `
                        <div style="background: white; border-radius: 5px; padding: 12px; margin-bottom: 15px; border: 1px solid #e0e0e0; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h3 style="color: #2c3e50; margin: 0; padding-bottom: 5px; border-bottom: 2px solid #e74c3c; font-size: 1rem; flex: 1;">
                                    ‚öîÔ∏è Team A vs Team B
                                    <span style="font-size: 0.7rem; color: #3498db; margin-left: 10px; font-weight: bold;">
                                        ‚õ≥ ${this.comps.teamAvsB.courseName}
                                    </span>
                                    ${hasScores ? 
                                        `<span style="font-size: 0.7rem; color: #f39c12; margin-left: 10px; font-weight: bold;">
                                            üèÜ Winner: ${winner}
                                        </span>` : ''
                                    }
                                </h3>
                                <button onclick="app.deleteCompetition('TeamAvsB', '')" class="btn-danger btn-small" style="font-size: 10px; padding: 4px 8px; white-space: nowrap;">üóëÔ∏è Delete</button>
                            </div>
                    `;
                    
                    html += `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                    `;
                    
                    // Team A
                    html += `
                        <div style="border: 2px solid #3498db; border-radius: 5px; padding: 10px; background: #ebf5fb;">
                            <h4 style="color: #2c3e50; margin: 0 0 10px 0; padding-bottom: 5px; border-bottom: 2px solid #3498db; font-size: 0.9rem;">
                                Team A (${this.comps.teamAvsB.teamA.length} players)
                            </h4>
                            ${hasScores ? 
                                `<div style="background: white; padding: 8px; border-radius: 3px; margin-bottom: 10px; border-left: 3px solid #3498db;">
                                    <div style="font-size: 0.8rem; font-weight: bold; color: #2c3e50;">Team Totals:</div>
                                    <div style="display: flex; gap: 15px; margin-top: 5px; font-size: 0.75rem;">
                                        <div><strong>Stableford:</strong> <span style="color: #2ecc71; font-weight: bold;">${teamAScores.totalPoints}</span></div>
                                        <div><strong>Gross:</strong> <span style="color: #e74c3c; font-weight: bold;">${teamAScores.totalGross}</span></div>
                                    </div>
                                </div>` : ''
                            }
                            <table style="width: 100%; border-collapse: collapse; font-size: 10px;">
                                <thead>
                                    <tr style="background: #3498db; color: white;">
                                        <th style="padding: 4px; text-align: left;">Player</th>
                                        ${hasScores ? 
                                            `<th style="padding: 4px; text-align: center; width: 50px; background: #2ecc71;">Points</th>
                                            <th style="padding: 4px; text-align: center; width: 50px;">Gross</th>` : ''
                                        }
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    this.comps.teamAvsB.teamA.forEach((player, idx) => {
                        const playerScore = hasScores ? teamAScores.playerScores.find(ps => ps.name === player.name) : null;
                        html += `
                            <tr style="background: ${idx % 2 === 0 ? '#f8f9fa' : 'white'};">
                                <td style="padding: 4px;">${player.name}</td>
                                ${hasScores && playerScore ? 
                                    `<td style="padding: 4px; text-align: center; font-weight: bold; background: #e8f8f5;">${playerScore.points}</td>
                                    <td style="padding: 4px; text-align: center;">${playerScore.gross}</td>` : 
                                    hasScores ? `<td style="padding: 4px; text-align: center;">-</td><td style="padding: 4px; text-align: center;">-</td>` : ''
                                }
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    // Team B
                    html += `
                        <div style="border: 2px solid #e74c3c; border-radius: 5px; padding: 10px; background: #fadbd8;">
                            <h4 style="color: #2c3e50; margin: 0 0 10px 0; padding-bottom: 5px; border-bottom: 2px solid #e74c3c; font-size: 0.9rem;">
                                Team B (${this.comps.teamAvsB.teamB.length} players)
                            </h4>
                            ${hasScores ? 
                                `<div style="background: white; padding: 8px; border-radius: 3px; margin-bottom: 10px; border-left: 3px solid #e74c3c;">
                                    <div style="font-size: 0.8rem; font-weight: bold; color: #2c3e50;">Team Totals:</div>
                                    <div style="display: flex; gap: 15px; margin-top: 5px; font-size: 0.75rem;">
                                        <div><strong>Stableford:</strong> <span style="color: #2ecc71; font-weight: bold;">${teamBScores.totalPoints}</span></div>
                                        <div><strong>Gross:</strong> <span style="color: #e74c3c; font-weight: bold;">${teamBScores.totalGross}</span></div>
                                    </div>
                                </div>` : ''
                            }
                            <table style="width: 100%; border-collapse: collapse; font-size: 10px;">
                                <thead>
                                    <tr style="background: #e74c3c; color: white;">
                                        <th style="padding: 4px; text-align: left;">Player</th>
                                        ${hasScores ? 
                                            `<th style="padding: 4px; text-align: center; width: 50px; background: #2ecc71;">Points</th>
                                            <th style="padding: 4px; text-align: center; width: 50px;">Gross</th>` : ''
                                        }
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    this.comps.teamAvsB.teamB.forEach((player, idx) => {
                        const playerScore = hasScores ? teamBScores.playerScores.find(ps => ps.name === player.name) : null;
                        html += `
                            <tr style="background: ${idx % 2 === 0 ? '#f8f9fa' : 'white'};">
                                <td style="padding: 4px;">${player.name}</td>
                                ${hasScores && playerScore ? 
                                    `<td style="padding: 4px; text-align: center; font-weight: bold; background: #e8f8f5;">${playerScore.points}</td>
                                    <td style="padding: 4px; text-align: center;">${playerScore.gross}</td>` : 
                                    hasScores ? `<td style="padding: 4px; text-align: center;">-</td><td style="padding: 4px; text-align: center;">-</td>` : ''
                                }
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    html += `</div>`; // Close grid
                    
                    if (!hasScores) {
                        html += `
                            <div style="text-align: center; padding: 15px; margin-top: 10px; color: #7f8c8d; background: #f8f9fa; border-radius: 3px;">
                                <p>No scores calculated yet. Click "Calculate Scores" to compute team totals.</p>
                            </div>
                        `;
                    }
                    
                    html += `</div>`;
                }
                
                if (html === '') {
                    html = `
                        <div style="text-align: center; padding: 30px; color: #7f8c8d; background: #f8f9fa; border-radius: 5px; border: 2px dashed #e0e0e0; margin-top: 12px;">
                            <h3>No competitions created yet</h3>
                            <p>Create a competition using the buttons above to see results here.</p>
                        </div>
                    `;
                }
                
                container.innerHTML = html;
            },
            
            applyDefaultSort() {
                const sortValue = this.leaderboardSettings.defaultSort;
                
                switch(sortValue) {
                    case 'totalPoints':
                        this.currentSort = { column: 'totalPoints', direction: 'desc' };
                        break;
                    case 'totalPointsAsc':
                        this.currentSort = { column: 'totalPoints', direction: 'asc' };
                        break;
                    case 'totalGross':
                        this.currentSort = { column: 'totalGross', direction: 'asc' };
                        break;
                    case 'totalGrossDesc':
                        this.currentSort = { column: 'totalGross', direction: 'desc' };
                        break;
                    case 'name':
                        this.currentSort = { column: 'name', direction: 'asc' };
                        break;
                    case 'nameDesc':
                        this.currentSort = { column: 'name', direction: 'desc' };
                        break;
                    case 'money':
                        this.currentSort = { column: 'money', direction: 'desc' };
                        break;
                    default:
                        this.currentSort = { column: 'totalPoints', direction: 'desc' };
                }
            },
            
            sortLeaderboardData(data, column, direction) {
                return [...data].sort((a, b) => {
                    let aValue, bValue;
                    
                    switch(column) {
                        case 'position':
                            return direction === 'asc' ? a.position - b.position : b.position - a.position;
                        case 'name':
                            aValue = a.player.name.toLowerCase();
                            bValue = b.player.name.toLowerCase();
                            break;
                        case 'group':
                            aValue = a.player.group || '';
                            bValue = b.player.group || '';
                            break;
                        case 'phc':
                            aValue = a.player.phc || 0;
                            bValue = b.player.phc || 0;
                            break;
                        case 'front9Gross':
                            aValue = a.front9Gross || 0;
                            bValue = b.front9Gross || 0;
                            break;
                        case 'front9Points':
                            aValue = a.front9Points || 0;
                            bValue = b.front9Points || 0;
                            break;
                        case 'back9Gross':
                            aValue = a.back9Gross || 0;
                            bValue = b.back9Gross || 0;
                            break;
                        case 'back9Points':
                            aValue = a.back9Points || 0;
                            bValue = b.back9Points || 0;
                            break;
                        case 'totalGross':
                            aValue = a.totalGross || 0;
                            bValue = b.totalGross || 0;
                            break;
                        case 'totalPoints':
                            aValue = a.totalPoints || 0;
                            bValue = b.totalPoints || 0;
                            break;
                        case 'countback':
                            aValue = a.countbackTotal || 0;
                            bValue = b.countbackTotal || 0;
                            break;
                        case 'money':
                            aValue = a.moneyValue || 0;
                            bValue = b.moneyValue || 0;
                            break;
                        default:
                            aValue = a.totalPoints || 0;
                            bValue = b.totalPoints || 0;
                    }
                    
                    // Primary sort
                    let result;
                    if (direction === 'asc') {
                        if (typeof aValue === 'string') {
                            result = aValue.localeCompare(bValue);
                        } else {
                            result = aValue - bValue;
                        }
                    } else {
                        if (typeof aValue === 'string') {
                            result = bValue.localeCompare(aValue);
                        } else {
                            result = bValue - aValue;
                        }
                    }
                    
                    // If tied on primary sort and sorting by points, use countback as tiebreaker
                    if (result === 0 && column === 'totalPoints' && a.countbackData && b.countbackData) {
                        // Use countback comparison (always higher countback wins regardless of sort direction)
                        return this.compareCountback(a.countbackData, b.countbackData);
                    }
                    
                    return result;
                });
            },
            
            setupSortListeners() {
                document.querySelectorAll('.leaderboard-table th[data-sort]').forEach(th => {
                    th.addEventListener('click', () => {
                        const column = th.dataset.sort;
                        const currentDirection = th.classList.contains('sorted-asc') ? 'asc' : 
                                                th.classList.contains('sorted-desc') ? 'desc' : 'desc';
                        
                        // Clear all sort classes
                        document.querySelectorAll('.leaderboard-table th').forEach(header => {
                            header.classList.remove('sorted-asc', 'sorted-desc');
                        });
                        
                        // Set new sort direction
                        const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
                        th.classList.add(`sorted-${newDirection}`);
                        
                        this.currentSort = { column: column, direction: newDirection };
                        this.renderLeaderboard();
                    });
                });
            },
            
            saveMoneyData() {
                // Find all money inputs and save their values
                const moneyInputs = document.querySelectorAll('.money-input');
                moneyInputs.forEach(input => {
                    const playerId = parseInt(input.dataset.player);
                    const value = input.value.trim();
                    
                    if (value === '') {
                        delete this.leaderboardMoney[playerId];
                    } else {
                        // Parse the value, removing any currency symbol
                        const cleanedValue = value.replace(/[^0-9.-]+/g, '');
                        const moneyValue = parseFloat(cleanedValue) || 0;
                        this.leaderboardMoney[playerId] = moneyValue;
                    }
                });
                
                this.saveData();
                this.showToast('Money data saved', 'success');
            },
            
            renderLeaderboard() {
                const container = document.getElementById('leaderboardContainer');
                
                if (this.players.length === 0) {
                    container.innerHTML = `
                        <div class="empty-message">
                            <h3>No players added yet</h3>
                            <p>Add players and enter scores to see the leaderboard.</p>
                        </div>
                    `;
                    return;
                }

                // Get all courses that have players assigned
                const coursesWithPlayers = {};
                
                this.players.forEach(player => {
                    if (player.course) {
                        // Normalize course name to lowercase for grouping
                        const normalizedCourseName = player.course.toLowerCase();
                        if (!coursesWithPlayers[normalizedCourseName]) {
                            coursesWithPlayers[normalizedCourseName] = {
                                displayName: player.course, // Keep original case for display
                                players: []
                            };
                        }
                        coursesWithPlayers[normalizedCourseName].players.push(player);
                    }
                });
                
                if (Object.keys(coursesWithPlayers).length === 0) {
                    container.innerHTML = `
                        <div class="empty-message">
                            <h3>No players assigned to courses</h3>
                            <p>Assign players to courses to see the leaderboard.</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '<div style="display: flex; flex-direction: column; gap: 20px;">';
                
                // Process each course separately
                Object.keys(coursesWithPlayers).forEach(normalizedCourseName => {
                    const courseGroup = coursesWithPlayers[normalizedCourseName];
                    const courseName = courseGroup.displayName;
                    
                    // Case-insensitive course name matching
                    const course = this.courses.find(c => 
                        c.name && normalizedCourseName && 
                        c.name.toLowerCase() === normalizedCourseName
                    );
                    if (!course) return;
                    
                    const playersForCourse = courseGroup.players;
                    
                    // Calculate leaderboard data for this course
                    let leaderboardData = playersForCourse
                        .map(player => {
                            const playerScores = this.scores[player.id] || {};
                            
                            let front9Gross = 0;
                            let front9Points = 0;
                            let back9Gross = 0;
                            let back9Points = 0;
                            let totalGross = 0;
                            let totalPoints = 0;
                            
                            // Calculate countback data using new function
                            const countbackData = this.calculateCountbackScore(playerScores, course, player);
                            
                            for (let i = 1; i <= 18; i++) {
                                const hole = course.holes.find(h => h.number === i);
                                const score = playerScores[i];
                                
                                if (score !== undefined && score !== null && score !== '' && hole) {
                                    const scoreNum = parseInt(score);
                                    const stablefordResult = this.calculateStablefordWithResult(
                                        score, 
                                        hole.par, 
                                        player.phc,
                                        hole.index
                                    );
                                    
                                    const netScore = this.calculateNetScore(scoreNum, player.phc, hole.index);
                                    
                                    if (i <= 9) {
                                        front9Gross += scoreNum;
                                        front9Points += stablefordResult.points;
                                    } else {
                                        back9Gross += scoreNum;
                                        back9Points += stablefordResult.points;
                                    }
                                    
                                    totalGross += scoreNum;
                                    totalPoints += stablefordResult.points;
                                }
                            }
                            
                            const moneyValue = this.leaderboardMoney[player.id] || 0;
                            const moneyDisplay = moneyValue > 0 ? 
                                `${this.leaderboardSettings.currency}${moneyValue.toFixed(2)}` : 
                                '';
                            
                            return {
                                player: player,
                                front9Gross: front9Gross,
                                front9Points: front9Points,
                                back9Gross: back9Gross,
                                back9Points: back9Points,
                                totalGross: totalGross,
                                totalPoints: totalPoints,
                                countbackData: countbackData,
                                countbackTotal: countbackData.last6,  // Display last 6 as main CB value
                                moneyValue: moneyValue,
                                moneyDisplay: moneyDisplay,
                                hasScores: totalGross > 0 || totalPoints > 0
                            };
                        })
                        .filter(data => data.hasScores);
                    
                    if (leaderboardData.length === 0) return;
                    
                    // Sort the data
                    leaderboardData = this.sortLeaderboardData(
                        leaderboardData, 
                        this.currentSort.column, 
                        this.currentSort.direction
                    );
                    
                    // Add positions with proper tie-breaking using countback
                    let currentPosition = 1;
                    for (let i = 0; i < leaderboardData.length; i++) {
                        if (i === 0) {
                            leaderboardData[i].position = currentPosition;
                        } else {
                            const prev = leaderboardData[i - 1];
                            const curr = leaderboardData[i];
                            
                            // Check if tied on total points (or current sort column)
                            if (curr.totalPoints === prev.totalPoints) {
                                // Use countback to determine if truly tied
                                const cbComparison = this.compareCountback(curr.countbackData, prev.countbackData);
                                if (cbComparison === 0) {
                                    // Still tied after countback - same position
                                    curr.position = prev.position;
                                    curr.tiedPosition = true;
                                } else {
                                    // Countback resolved the tie - different position
                                    currentPosition = i + 1;
                                    curr.position = currentPosition;
                                }
                            } else {
                                // Not tied on points - new position
                                currentPosition = i + 1;
                                curr.position = currentPosition;
                            }
                        }
                    }
                    
                    html += `
                        <div style="background: white; border-radius: 5px; padding: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #e0e0e0;">
                            <h3 style="color: #2c3e50; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid #3498db; font-size: 1rem; display: flex; justify-content: space-between; align-items: center;">
                                <span>${courseName}</span>
                                <span style="font-size: 0.7rem; color: #7f8c8d; font-weight: normal;">
                                    Par ${course.par}
                                </span>
                            </h3>
                            <table class="leaderboard-table">
                                <thead>
                                    <tr style="background: #2c3e50; color: white;">
                                        <th data-sort="position" style="padding: 6px; text-align: center; width: 40px; cursor: pointer;">
                                            Pos
                                        </th>
                                        <th data-sort="name" style="padding: 6px; text-align: left; cursor: pointer;">
                                            Player
                                        </th>
                                        <th data-sort="money" style="padding: 6px; text-align: center; width: 70px; cursor: pointer; background: #27ae60;">
                                            Money
                                        </th>
                                        <th data-sort="phc" style="padding: 6px; text-align: center; width: 50px; cursor: pointer;">
                                            PHC
                                        </th>
                                        <th data-sort="group" style="padding: 6px; text-align: center; width: 60px; cursor: pointer;">
                                            Group
                                        </th>
                                        <th data-sort="front9Gross" style="padding: 6px; text-align: center; width: 60px; cursor: pointer; background: #2c3e50;">
                                            F9 G
                                        </th>
                                        <th data-sort="front9Points" style="padding: 6px; text-align: center; width: 60px; cursor: pointer; background: #2ecc71;">
                                            F9 P
                                        </th>
                                        <th data-sort="back9Gross" style="padding: 6px; text-align: center; width: 60px; cursor: pointer; background: #2c3e50;">
                                            B9 G
                                        </th>
                                        <th data-sort="back9Points" style="padding: 6px; text-align: center; width: 60px; cursor: pointer; background: #2ecc71;">
                                            B9 P
                                        </th>
                                        <th data-sort="totalGross" style="padding: 6px; text-align: center; width: 60px; cursor: pointer; background: #2c3e50;">
                                            TOT G
                                        </th>
                                        <th data-sort="totalPoints" style="padding: 6px; text-align: center; width: 60px; cursor: pointer; background: #2ecc71;">
                                            TOT P
                                        </th>
                                        <th data-sort="countback" style="padding: 6px; text-align: center; width: 70px; cursor: pointer; background: #3498db;">
                                            CB
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    leaderboardData.forEach((data, index) => {
                        const position = data.position;
                        const positionClass = position === 1 ? 'style="background: #fef9e7;"' : 
                                           position === 2 ? 'style="background: #f8f9fa;"' : 
                                           position === 3 ? 'style="background: #f5f5f5;"' : '';
                        
                        // Create money input field
                        const moneyInputId = `money-${data.player.id}-${courseName.replace(/\s+/g, '-')}`;
                        const currentMoneyValue = this.leaderboardMoney[data.player.id] || '';
                        
                        html += `
                            <tr ${positionClass}>
                                <td style="padding: 6px; text-align: center; font-weight: bold; border-right: 1px solid #e0e0e0; font-size: 0.9em;">${position}</td>
                                <td style="padding: 6px; font-size: 0.9em;"><strong>${data.player.name}</strong></td>
                                <td style="padding: 6px; text-align: center; background: #e8f6f3;">
                                    <input type="text" 
                                           id="${moneyInputId}"
                                           data-player="${data.player.id}"
                                           value="${currentMoneyValue}"
                                           style="width: 100%; padding: 4px; font-size: 0.8em; text-align: center; border: 1px solid #ddd; border-radius: 2px;"
                                           placeholder="${this.leaderboardSettings.currency}0.00">
                                </td>
                                <td style="padding: 6px; text-align: center; font-size: 0.9em;">${data.player.phc || 0}</td>
                                <td style="padding: 6px; text-align: center; color: #7f8c8d; font-size: 0.8em;">${data.player.group || '-'}</td>
                                <td style="padding: 6px; text-align: center; font-weight: bold; background: #f8f9fa; font-size: 0.9em;">${data.front9Gross > 0 ? data.front9Gross : '-'}</td>
                                <td style="padding: 6px; text-align: center; font-weight: bold; background: #f0f9f4; color: #2ecc71; font-size: 0.9em;">${data.front9Points > 0 ? data.front9Points : '-'}</td>
                                <td style="padding: 6px; text-align: center; font-weight: bold; background: #f8f9fa; font-size: 0.9em;">${data.back9Gross > 0 ? data.back9Gross : '-'}</td>
                                <td style="padding: 6px; text-align: center; font-weight: bold; background: #f0f9f4; color: #2ecc71; font-size: 0.9em;">${data.back9Points > 0 ? data.back9Points : '-'}</td>
                                <td style="padding: 6px; text-align: center; font-weight: bold; background: #f8f9fa; font-size: 0.9em;">${data.totalGross > 0 ? data.totalGross : '-'}</td>
                                <td style="padding: 6px; text-align: center; font-weight: bold; background: #f0f9f4; color: #2ecc71; font-size: 0.9em;">${data.totalPoints > 0 ? data.totalPoints : '-'}</td>
                                <td style="padding: 6px; text-align: center; font-weight: bold; background: #e8f4fc; color: #3498db; font-size: 0.9em;" title="L6: ${data.countbackData.last6} | L3: ${data.countbackData.last3} | H18: ${data.countbackData.last1} | H17: ${data.countbackData.last2nd} | H16: ${data.countbackData.last3rd}">${data.countbackTotal > 0 ? data.countbackTotal : '-'}</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                });
                
                html += '</div>';
                
                if (html === '<div style="display: flex; flex-direction: column; gap: 20px;"></div>') {
                    container.innerHTML = `
                        <div class="empty-message">
                            <h3>No scores entered yet</h3>
                            <p>Enter scores on the scorecard to see the leaderboard.</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = html;
                    
                    // Highlight the current sort column
                    const currentSortTh = document.querySelector(`th[data-sort="${this.currentSort.column}"]`);
                    if (currentSortTh) {
                        currentSortTh.classList.add(`sorted-${this.currentSort.direction}`);
                    }
                    
                    this.setupSortListeners();
                    this.setupMoneyInputListeners();
                }
            },
            
            setupMoneyInputListeners() {
                document.querySelectorAll('.money-input').forEach(input => {
                    input.addEventListener('input', (e) => {
                        // Format the input to ensure it's a valid number
                        const value = e.target.value.replace(/[^0-9.-]/g, '');
                        if (value !== e.target.value) {
                            e.target.value = value;
                        }
                    });
                    
                    input.addEventListener('blur', (e) => {
                        // Add currency symbol when losing focus
                        const value = e.target.value.trim();
                        if (value) {
                            const numValue = parseFloat(value) || 0;
                            const currency = this.leaderboardSettings.currency;
                            e.target.value = `${currency}${numValue.toFixed(2)}`;
                            
                            // Save the value
                            const playerId = parseInt(e.target.dataset.player);
                            this.leaderboardMoney[playerId] = numValue;
                            this.saveData();
                        }
                    });
                    
                    input.addEventListener('focus', (e) => {
                        // Remove currency symbol when focusing for editing
                        const value = e.target.value.replace(/[^0-9.-]/g, '');
                        e.target.value = value;
                        setTimeout(() => e.target.select(), 10);
                    });
                    
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.target.blur();
                        }
                    });
                });
            },
            
            // Import/Export
            importData(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = e.target.result;
                        const workbook = XLSX.read(data, { type: 'binary' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        
                        if (jsonData.length === 0) {
                            this.showToast('No data found in file', 'error');
                            return;
                        }
                        
                        let importedCount = 0;
                        jsonData.forEach(row => {
                            const name = row.Name || row.Player || row['Player Name'];
                            const handicap = parseFloat(row['Handicap Index'] || row.Handicap || row.HCP || row.Index || 0);
                            const phc = parseInt(row.PHC || row['Playing Handicap'] || row.Handicap || 0);
                            const course = row.Course || '';
                            const group = row.Group || '';
                            
                            if (name) {
                                if (course && group && this.isGroupFullForCourse(group, course)) {
                                    this.showToast(`Skipped ${name} - ${group} is full for ${course}!`, 'warning');
                                    return;
                                }
                                
                                const player = {
                                    id: Date.now() + importedCount,
                                    name: name.toString().trim(),
                                    handicap: isNaN(handicap) ? 0 : handicap,
                                    phc: isNaN(phc) ? 0 : phc,
                                    course: course ? course.toString() : '',
                                    group: group ? group.toString() : '',
                                    date: new Date().toISOString(),
                                    imported: true
                                };
                                
                                this.players.push(player);
                                importedCount++;
                            }
                        });
                        
                        if (importedCount > 0) {
                            this.saveData();
                            this.renderPlayers();
                            this.updateGroupStats();
                            this.showToast(`Imported ${importedCount} players from file!`, 'success');
                        } else {
                            this.showToast('No valid player data found in file', 'warning');
                        }
                        
                        event.target.value = '';
                    } catch (error) {
                        console.error('Error importing data:', error);
                        this.showToast('Error importing data. Please check file format.', 'error');
                    }
                };
                
                reader.readAsBinaryString(file);
            },
            
            exportData() {
                if (this.players.length === 0) {
                    this.showToast('No data to export', 'warning');
                    return;
                }
                
                const worksheetData = [
                    ['Name', 'Handicap Index', 'PHC', 'Course', 'Group']
                ];
                
                this.players.forEach(player => {
                    worksheetData.push([
                        player.name,
                        player.handicap,
                        player.phc || 0,
                        player.course || '',
                        player.group || ''
                    ]);
                });
                
                const workbook = XLSX.utils.book_new();
                const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Players');
                
                const fileName = `golf-players-${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(workbook, fileName);
                
                this.showToast('Data exported to Excel!', 'success');
            },
            
            backupData() {
                const data = {
                    players: this.players,
                    courses: this.courses,
                    pairs: this.pairs,
                    scores: this.scores,
                    leaderboardMoney: this.leaderboardMoney,
                    pairsScores: this.pairsScores,
                    pairsMoney: this.pairsMoney,
                    pairsCourseGenerated: this.pairsCourseGenerated,
                    comps: this.comps,
                    masterLeaderboardData: this.masterLeaderboardData,
                    currentTab: this.currentTab,
                    scorecardSettings: this.scorecardSettings,
                    leaderboardSettings: this.leaderboardSettings,
                    pairsSettings: this.pairsSettings,
                    timestamp: new Date().toISOString()
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `golf-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.showToast('Backup created!', 'success');
            },
            
            backupCourses() {
                if (this.courses.length === 0) {
                    this.showToast('No courses to backup', 'warning');
                    return;
                }
                
                const data = {
                    courses: this.courses,
                    timestamp: new Date().toISOString()
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `golf-courses-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.showToast('Courses backup created!', 'success');
            },
            
            restoreData(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        this.players = data.players || [];
                        this.courses = data.courses || [];
                        this.pairs = data.pairs || [];
                        this.scores = data.scores || {};
                        this.leaderboardMoney = data.leaderboardMoney || {};
                        this.pairsScores = data.pairsScores || {};
                        this.pairsMoney = data.pairsMoney || {};
                        this.pairsCourseGenerated = data.pairsCourseGenerated || '';
                        this.comps = data.comps || { fourBBB: [], fourPersonTeams: [], best3From4: [] };
                        this.masterLeaderboardData = data.masterLeaderboardData || [];
                        this.currentTab = data.currentTab || 'players';
                        // Clear scorecard settings on restore since course IDs will be different
                        this.scorecardSettings = {
                            selectedCourseId: '',
                            selectedGroupFilter: 'all'
                        };
                        this.leaderboardSettings = data.leaderboardSettings || {
                            currency: '$',
                            defaultSort: 'totalPoints'
                        };
                        this.pairsSettings = data.pairsSettings || {
                            currency: '$'
                        };
                        
                        this.saveData();
                        this.renderPlayers();
                        this.renderCourses();
                        this.renderPairs();
                        this.updateGroupStats();
                        this.populateScorecardDropdowns();
                        this.populatePairsCourseDropdown();
                        this.restoreActiveTab();
                        this.restoreScorecardSettings();
                        this.restoreLeaderboardSettings();
                        this.restorePairsSettings();
                        // Force render scorecard after restore
                        this.renderScorecard();
                        
                        event.target.value = '';
                        this.showToast('Backup restored!', 'success');
                    } catch (error) {
                        console.error('Error restoring backup:', error);
                        this.showToast('Error restoring backup. Invalid file format.', 'error');
                    }
                };
                reader.readAsText(file);
            },
            
            // Capture Functions
            captureFullTabData() {
                if (typeof html2canvas === 'undefined') {
                    this.showToast('html2canvas not loaded', 'error');
                    return;
                }
                
                const activeTabContent = document.querySelector('.tab-content.active');
                if (!activeTabContent) {
                    this.showToast('No active tab found', 'error');
                    return;
                }
                
                // Get the current tab name for the filename
                const activeTabButton = document.querySelector('.tab-button.active');
                const tabName = activeTabButton ? activeTabButton.textContent.trim().replace(/\s+/g, '-') : 'tab';
                
                // Find scrollable container and get its full dimensions
                const scrollContainer = activeTabContent.querySelector('.scorecard-container') || activeTabContent.querySelector('[style*="overflow"]') || activeTabContent;
                const scorecardTable = activeTabContent.querySelector('.scorecard-table');
                
                // Store original styles to restore later
                const originalStyles = {
                    tabOverflow: activeTabContent.style.overflow,
                    tabMaxHeight: activeTabContent.style.maxHeight,
                    tabMinHeight: activeTabContent.style.minHeight,
                    tabWidth: activeTabContent.style.width,
                    containerOverflow: scrollContainer.style.overflow,
                    containerMaxHeight: scrollContainer.style.maxHeight,
                    containerWidth: scrollContainer.style.width
                };
                
                // Temporarily remove constraints for full capture
                activeTabContent.style.overflow = 'visible';
                activeTabContent.style.maxHeight = 'none';
                activeTabContent.style.minHeight = 'auto';
                activeTabContent.style.width = 'auto';
                scrollContainer.style.overflow = 'visible';
                scrollContainer.style.maxHeight = 'none';
                scrollContainer.style.width = 'auto';
                
                // Show loading message
                this.showToast('Capturing full tab data...', 'info');
                
                // Force a reflow to ensure DOM updates
                activeTabContent.offsetHeight;
                
                // Calculate actual full width and height needed including the table
                let captureWidth = activeTabContent.scrollWidth;
                let captureHeight = activeTabContent.scrollHeight;
                
                if (scorecardTable) {
                    // Get the actual table width which includes all columns
                    const tableWidth = scorecardTable.scrollWidth;
                    const tableOffsetLeft = scorecardTable.getBoundingClientRect().left - activeTabContent.getBoundingClientRect().left;
                    const requiredWidth = tableOffsetLeft + tableWidth + 50; // Add padding
                    captureWidth = Math.max(captureWidth, requiredWidth, tableWidth);
                    
                    // Get the actual table height which includes all rows
                    const tableHeight = scorecardTable.scrollHeight;
                    const tableOffsetTop = scorecardTable.getBoundingClientRect().top - activeTabContent.getBoundingClientRect().top;
                    const requiredHeight = tableOffsetTop + tableHeight + 100; // Add padding
                    captureHeight = Math.max(captureHeight, requiredHeight, tableHeight);
                }
                
                html2canvas(activeTabContent, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    logging: false,
                    scrollY: -window.scrollY,
                    scrollX: 0,
                    windowWidth: captureWidth,
                    windowHeight: captureHeight,
                    width: captureWidth,
                    height: captureHeight,
                    onclone: function(clonedDoc) {
                        // Ensure all content is visible in the cloned document
                        const clonedTab = clonedDoc.querySelector('.tab-content.active');
                        if (clonedTab) {
                            clonedTab.style.overflow = 'visible';
                            clonedTab.style.maxHeight = 'none';
                            clonedTab.style.minHeight = 'auto';
                            clonedTab.style.height = 'auto';
                            clonedTab.style.width = 'auto';
                        }
                        
                        // Expand all scrollable containers including scorecard
                        const scrollables = clonedDoc.querySelectorAll('[style*="overflow"], .scorecard-container');
                        scrollables.forEach(el => {
                            el.style.overflow = 'visible';
                            el.style.maxHeight = 'none';
                            el.style.width = 'auto';
                            el.style.maxWidth = 'none';
                        });
                        
                        // Ensure all tables are fully expanded with all columns visible
                        const tables = clonedDoc.querySelectorAll('table, .scorecard-table');
                        tables.forEach(table => {
                            table.style.width = 'auto';
                            table.style.minWidth = 'max-content';
                            table.style.overflow = 'visible';
                            table.style.display = 'table';
                        });
                        
                        // Specifically handle scorecard table to show all columns and rows
                        const scorecardTable = clonedDoc.querySelector('.scorecard-table');
                        if (scorecardTable) {
                            scorecardTable.style.minWidth = 'max-content';
                            scorecardTable.style.width = 'auto';
                            scorecardTable.style.minHeight = 'max-content';
                            scorecardTable.style.height = 'auto';
                            // Ensure all cells are visible
                            const cells = scorecardTable.querySelectorAll('th, td');
                            cells.forEach(cell => {
                                cell.style.whiteSpace = 'nowrap';
                            });
                        }
                        
                        // Ensure scorecard container shows all content
                        const scorecardContainer = clonedDoc.querySelector('.scorecard-container');
                        if (scorecardContainer) {
                            scorecardContainer.style.maxHeight = 'none';
                            scorecardContainer.style.height = 'auto';
                            scorecardContainer.style.overflow = 'visible';
                        }
                    }
                }).then(canvas => {
                    // Restore original styles
                    activeTabContent.style.overflow = originalStyles.tabOverflow;
                    activeTabContent.style.maxHeight = originalStyles.tabMaxHeight;
                    activeTabContent.style.minHeight = originalStyles.tabMinHeight;
                    activeTabContent.style.width = originalStyles.tabWidth;
                    scrollContainer.style.overflow = originalStyles.containerOverflow;
                    scrollContainer.style.maxHeight = originalStyles.containerMaxHeight;
                    scrollContainer.style.width = originalStyles.containerWidth;
                    
                    const link = document.createElement('a');
                    link.download = `golf-${tabName}-${Date.now()}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    this.showToast(`Full ${tabName} data captured!`, 'success');
                }).catch(error => {
                    // Restore original styles even if there's an error
                    activeTabContent.style.overflow = originalStyles.tabOverflow;
                    activeTabContent.style.maxHeight = originalStyles.tabMaxHeight;
                    activeTabContent.style.minHeight = originalStyles.tabMinHeight;
                    activeTabContent.style.width = originalStyles.tabWidth;
                    scrollContainer.style.overflow = originalStyles.containerOverflow;
                    scrollContainer.style.maxHeight = originalStyles.containerMaxHeight;
                    scrollContainer.style.width = originalStyles.containerWidth;
                    
                    console.error('Error capturing tab:', error);
                    this.showToast('Error capturing full tab data', 'error');
                });
            },
            
            // Other functions
            shareWhatsApp() {
                const totalPlayers = this.players.length;
                const ungroupedCount = this.players.filter(p => !p.group || p.group === '').length;
                const groupedPlayers = totalPlayers - ungroupedCount;
                const coursesCount = this.courses.length;
                const pairsCount = this.pairs.length;
                const fourBBBTeams = this.comps.fourBBB.length;
                const fourPersonTeams = this.comps.fourPersonTeams.length;
                const best3From4Teams = this.comps.best3From4.length;
                
                const message = `üèåÔ∏è Golf Competition Manager\nTotal Players: ${totalPlayers}\nCourses: ${coursesCount}\nPairs: ${pairsCount}\n4BBB Teams: ${fourBBBTeams}\n4 Person Teams: ${fourPersonTeams}\nBest 3 from 4: ${best3From4Teams}\nGrouped Players: ${groupedPlayers}\nUngrouped: ${ungroupedCount}`;
                const url = `https://wa.me/?text=${encodeURIComponent(message)}`;
                window.open(url, '_blank');
            },
            
            // Random Draw Functions
            populateRandomDrawCourseDropdown() {
                const select = document.getElementById('randomDrawCourseSelect');
                select.innerHTML = '<option value="">-- Select a course --</option>';
                this.courses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course.name;
                    option.textContent = course.name;
                    select.appendChild(option);
                });
                
                // Restore previously selected course
                if (this.randomDrawCourse) {
                    select.value = this.randomDrawCourse;
                }
            },
            
            generateRandomDraw() {
                const courseSelect = document.getElementById('randomDrawCourseSelect');
                const selectedCourse = courseSelect.value;
                
                if (!selectedCourse) {
                    this.showToast('Please select a course first', 'warning');
                    return;
                }
                
                // Get players assigned to the selected course - case insensitive
                const coursePlayers = this.players.filter(player => 
                    player.course && selectedCourse && 
                    player.course.toLowerCase() === selectedCourse.toLowerCase()
                );
                
                if (coursePlayers.length < 2) {
                    this.showToast(`Need at least 2 players assigned to ${selectedCourse}`, 'warning');
                    return;
                }
                
                // Shuffle players randomly using Fisher-Yates algorithm for true randomness
                const shuffledPlayers = [...coursePlayers];
                for (let i = shuffledPlayers.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffledPlayers[i], shuffledPlayers[j]] = [shuffledPlayers[j], shuffledPlayers[i]];
                }
                
                // Create groups: prioritize groups of 3, then groups of 4
                // Smallest groups should be numbered first (Group 1, 2, etc.)
                const groups = [];
                const totalPlayers = shuffledPlayers.length;
                
                // Calculate optimal distribution
                let groupsOf3 = 0;
                let groupsOf4 = 0;
                let groupsOf2 = 0;
                
                const remainder = totalPlayers % 4;
                
                if (remainder === 0) {
                    // Divisible by 4: all groups of 4
                    groupsOf4 = totalPlayers / 4;
                } else if (remainder === 1) {
                    // e.g., 5,9,13,17,21: make groups like 3+4s or 3+3+3 for 9
                    if (totalPlayers === 5) {
                        groupsOf3 = 1;
                        groupsOf2 = 1;
                    } else {
                        groupsOf3 = 1;
                        groupsOf4 = (totalPlayers - 3) / 4;
                    }
                } else if (remainder === 2) {
                    // e.g., 2,6,10,14,18: make groups like 3+3 or 3+4+4 for 10
                    if (totalPlayers === 2) {
                        groupsOf2 = 1;
                    } else if (totalPlayers === 6) {
                        groupsOf3 = 2;
                    } else {
                        groupsOf3 = 2;
                        groupsOf4 = (totalPlayers - 6) / 4;
                    }
                } else if (remainder === 3) {
                    // e.g., 3,7,11,15,19: make one group of 3, rest groups of 4
                    groupsOf3 = 1;
                    groupsOf4 = (totalPlayers - 3) / 4;
                }
                
                // Create groups starting with smallest sizes first
                let currentIndex = 0;
                let groupNumber = 1;
                
                // First: groups of 2 (smallest)
                for (let i = 0; i < groupsOf2; i++) {
                    const group = {
                        id: Date.now() + currentIndex,
                        number: groupNumber++,
                        players: shuffledPlayers.slice(currentIndex, currentIndex + 2),
                        course: selectedCourse,
                        date: new Date().toISOString()
                    };
                    groups.push(group);
                    currentIndex += 2;
                }
                
                // Second: groups of 3
                for (let i = 0; i < groupsOf3; i++) {
                    const group = {
                        id: Date.now() + currentIndex,
                        number: groupNumber++,
                        players: shuffledPlayers.slice(currentIndex, currentIndex + 3),
                        course: selectedCourse,
                        date: new Date().toISOString()
                    };
                    groups.push(group);
                    currentIndex += 3;
                }
                
                // Third: groups of 4 (largest)
                for (let i = 0; i < groupsOf4; i++) {
                    const group = {
                        id: Date.now() + currentIndex,
                        number: groupNumber++,
                        players: shuffledPlayers.slice(currentIndex, currentIndex + 4),
                        course: selectedCourse,
                        date: new Date().toISOString()
                    };
                    groups.push(group);
                    currentIndex += 4;
                }
                
                this.randomDrawGroups = groups;
                this.randomDrawCourse = selectedCourse;
                this.saveData();
                this.renderRandomDraw();
                
                this.showToast(`Created ${groups.length} groups for ${selectedCourse}!`, 'success');
            },
            
            renderRandomDraw() {
                const container = document.getElementById('randomDrawContainer');
                
                if (this.randomDrawGroups.length === 0) {
                    container.innerHTML = `
                        <div class="empty-message">
                            <h3>No draw generated yet</h3>
                            <p>Select a course and click "Generate Draw" to randomly assign players into groups.</p>
                        </div>
                    `;
                    return;
                }
                
                let html = `
                    <div style="margin-bottom: 10px; padding: 10px; background: #e3f2fd; border-left: 3px solid #2196f3; border-radius: 3px;">
                        <strong>Course:</strong> ${this.randomDrawCourse} | <strong>Total Groups:</strong> ${this.randomDrawGroups.length}
                    </div>
                    <div class="pairs-grid">
                `;
                
                this.randomDrawGroups.forEach(group => {
                    html += `
                        <div class="pair-card">
                            <div class="pair-header">
                                <div class="pair-title">
                                    üéØ Group ${group.number}
                                    <span style="font-size: 0.7rem; color: #7f8c8d; margin-left: 8px;">(${group.players.length} players)</span>
                                </div>
                            </div>
                            <div style="margin-top: 10px;">
                    `;
                    
                    group.players.forEach((player, index) => {
                        html += `
                            <div style="padding: 6px; margin-bottom: 4px; background: #f8f9fa; border-radius: 3px; border-left: 3px solid #3498db; font-size: 0.8rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-weight: bold;">${index + 1}. ${player.name}</span>
                                    <span style="color: #7f8c8d; font-size: 0.7rem;">PHC: ${player.phc || 0}</span>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
            },
            
            showToast(message, type = 'info') {
                const existing = document.querySelectorAll('.toast');
                existing.forEach(t => t.remove());
                
                const toast = document.createElement('div');
                toast.className = 'toast';
                
                if (type === 'success') toast.style.background = '#2ecc71';
                else if (type === 'error') toast.style.background = '#e74c3c';
                else if (type === 'warning') toast.style.background = '#f39c12';
                else toast.style.background = '#3498db';
                
                let icon = '‚ÑπÔ∏è';
                if (type === 'success') icon = '‚úÖ';
                if (type === 'error') icon = '‚ùå';
                if (type === 'warning') icon = '‚ö†Ô∏è';
                
                toast.innerHTML = `${icon} ${message}`;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.opacity = '0';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
            // Make app globally accessible for onclick handlers
            window.app = app;
        });
    </script>
</body>
</html>
